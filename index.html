<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Facturier Styl'Emoi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .sidebar-item.active { background: linear-gradient(to right, #f59e0b, #ea580c); }
        .btn-primary { background: linear-gradient(to right, #f59e0b, #ea580c); }
        .btn-primary:hover { background: linear-gradient(to right, #d97706, #dc2626); }
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            @page { size: A4; margin: 15mm; }
            .page-break { page-break-after: always; }
        }
        .logo-container { max-width: 200px; max-height: 80px; }
        .logo-container img { max-width: 100%; max-height: 80px; object-fit: contain; }
    </style>
</head>
<body class="bg-gradient-to-br from-stone-100 to-amber-50 min-h-screen">
    <!-- Page de Connexion -->
    <div id="login-page" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
            <div class="text-center mb-8">
                <div id="login-logo" class="mx-auto h-24 mb-4"></div>
                <h1 class="text-2xl font-bold text-stone-800">Facturier Styl'Emoi</h1>
                <p class="text-stone-500">Connectez-vous pour acc√©der √† votre espace</p>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-stone-700 mb-1">Mot de passe</label>
                    <input type="password" id="login-password" onkeypress="if(event.key==='Enter')login()" 
                           class="w-full px-4 py-3 border border-stone-300 rounded-lg focus:ring-2 focus:ring-amber-500" 
                           placeholder="Entrez votre mot de passe">
                </div>
                <div id="login-error" class="hidden text-red-500 text-sm text-center">Mot de passe incorrect</div>
                <button onclick="login()" class="w-full btn-primary text-white py-3 rounded-lg font-semibold">Se connecter</button>
            </div>
        </div>
    </div>

    <div id="app" class="hidden flex min-h-screen">
        <!-- Sidebar FIXE -->
        <aside class="w-64 bg-gradient-to-b from-stone-900 to-stone-800 text-white flex flex-col h-screen sticky top-0 no-print">
            <div class="p-6 border-b border-stone-700">
                <div id="sidebar-logo" class="logo-container cursor-pointer" onclick="navigateTo('settings')" title="Cliquez pour changer le logo">
                    <!-- Logo ou texte par d√©faut -->
                </div>
                <p class="text-stone-400 text-sm mt-1" id="version-display">v3.0.0</p>
            </div>
            <nav class="flex-1 p-4 space-y-1" id="nav-menu"></nav>
            <div class="p-4 border-t border-stone-700 text-stone-400 text-xs">¬© 2024 Styl'Emoi</div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-8 overflow-auto" id="main-content"></main>
    </div>

    <!-- Modal Container -->
    <div id="modal-container" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
        <div id="modal-content" class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden"></div>
    </div>

    <!-- Zone d'impression cach√©e -->
    <div id="print-area" class="hidden print:block"></div>

<script>
// ============================================
// FIREBASE REALTIME DATABASE
// ============================================
const firebaseConfig = {
    apiKey: "AIzaSyAW0oncXlG74CoQmzIBwNuySPObG3Fn4rE",
    authDomain: "facturier-stylemoi.firebaseapp.com",
    databaseURL: "https://facturier-stylemoi-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "facturier-stylemoi",
    storageBucket: "facturier-stylemoi.firebasestorage.app",
    messagingSenderId: "662308649673",
    appId: "1:662308649673:web:0a658387c8762bc91beb18",
    measurementId: "G-73FEYNDN5Z"
};

let dbRef = null;
try {
    firebase.initializeApp(firebaseConfig);
    dbRef = firebase.database().ref('facturier');
    console.log('‚úÖ Firebase Realtime Database connect√©');
} catch(e) {
    console.error('‚ùå Erreur Firebase:', e);
}

// ============================================
// FONCTIONS DE CONNEXION
// ============================================
function login() {
    const password = document.getElementById('login-password').value;
    const storedData = localStorage.getItem('facturier_stylemoi_v3');
    let adminPassword = 'admin123';
    if (storedData) {
        try {
            const parsed = JSON.parse(storedData);
            if (parsed.adminPassword) adminPassword = parsed.adminPassword;
        } catch(e) {}
    }
    if (password === adminPassword) {
        document.getElementById('login-page').classList.add('hidden');
        document.getElementById('app').classList.remove('hidden');
        sessionStorage.setItem('facturier_logged', 'true');
        document.getElementById('login-error').classList.add('hidden');
        initApp();
    } else {
        document.getElementById('login-error').classList.remove('hidden');
        document.getElementById('login-password').value = '';
    }
}

function logout() {
    sessionStorage.removeItem('facturier_logged');
    document.getElementById('app').classList.add('hidden');
    document.getElementById('login-page').classList.remove('hidden');
    document.getElementById('login-password').value = '';
}

function checkSession() {
    const storedData = localStorage.getItem('facturier_stylemoi_v3');
    if (storedData) {
        try {
            const parsed = JSON.parse(storedData);
            if (parsed.logo) {
                document.getElementById('login-logo').innerHTML = '<img src="' + parsed.logo + '" class="h-24 mx-auto">';
            }
        } catch(e) {}
    }
    if (sessionStorage.getItem('facturier_logged') === 'true') {
        document.getElementById('login-page').classList.add('hidden');
        document.getElementById('app').classList.remove('hidden');
        initApp();
    }
}

function initApp() {
    loadData();
    renderNav();
    renderPage();
}

// ============================================
// DONN√âES PAR D√âFAUT
// ============================================
const defaultData = {
    version: '3.2.0',
    adminPassword: 'admin123',
    logo: null, // Base64 du logo
    cgv: `Conditions g√©n√©rales de vente

Entre l'auto-entrepreneur Eric Ohlmann Styl'Emoi - Situ√©e au 6g Rue De La M√©sange, immatricul√©e au RCS de Strasbourg sous le num√©ro SIRET 93315077300010.

PREAMBULE - Le Vendeur est √©diteur de Produits et Services de Customisation d'objets et de textiles √† destination de consommateurs.

Article 1 : Objet - Les pr√©sentes CGV d√©terminent les droits et obligations des parties dans le cadre de la vente en ligne de Produits ou Services propos√©s par le Vendeur.

Article 2 : Dispositions g√©n√©rales - Les pr√©sentes CGV r√©gissent les ventes de Produits ou de Services et sont partie int√©grante du Contrat entre l'Acheteur et le Vendeur. Elles sont pleinement opposables √† l'Acheteur qui les a accept√©s avant de passer commande. Le Vendeur se r√©serve la possibilit√© de modifier les pr√©sentes √† tout moment. Les CGV applicables sont celles en vigueur √† la date du paiement de la commande. Le Client d√©clare avoir pris connaissance de l'ensemble des pr√©sentes CGV et les accepter sans restriction ni r√©serve.

Article 3 : Prix - Les prix des produits sont indiqu√©s en Euro TTC. Le montant total d√ª par l'Acheteur est indiqu√© sur la page de confirmation de la commande. Le prix de vente est celui en vigueur au jour de la commande, hors frais de port factur√©s en suppl√©ment. Le Vendeur se r√©serve la possibilit√© de modifier ses prix √† tout moment, tout en garantissant l'application du prix indiqu√© au moment de la commande.

Article 4 : Produits et services - Les caract√©ristiques essentielles des biens, des services et leurs prix respectifs sont mis √† disposition de l'acheteur. Conform√©ment √† l'article L112-1 du Code la consommation, le consommateur est inform√© des prix et conditions particuli√®res avant toute conclusion du contrat.

Article 5 : Commandes - Pour toutes commandes un acompte de 50% sera demand√© afin de valider celle-ci. Sans paiement de cet acompte la production ne pourra pas s'effectuer. Un d√©lai allant jusqu'√† 21 jours pourra √™tre indiqu√© en fonction de la complexit√© de la commande.

Article 6 : Modalit√©s de livraison - Les produits sont livr√©s √† l'adresse indiqu√©e lors de la commande et dans les d√©lais indiqu√©s, ou r√©cup√©r√©s directement par le client. Ces d√©lais ne prennent pas en compte le d√©lai de pr√©paration. Styl'Emoi ne pourra √™tre tenu responsable des retards de livraisons dus au transporteur.

Article 7 : Paiement - Le paiement est exigible imm√©diatement √† la livraison. Le paiement s√©curis√© en ligne par PayPal ou lien de paiement est r√©alis√© par notre prestataire. L'engagement de payer donn√© par carte est irr√©vocable. En cas d'erreur ou d'impossibilit√© de d√©biter la carte, la Vente est imm√©diatement r√©solue et la commande annul√©e.

Article 8 : D√©lai de r√©tractation - Conform√©ment √† l'article L221-5 du Code de la consommation, l'Acheteur dispose d'un d√©lai de 14 jours pour se r√©tracter, sauf objets personnalis√©s sur mesure (objets ou textiles avec photos ou inscriptions personnelles ne pouvant √™tre revendus). Contact : 67stylemoi@gmail.com. Les frais de retour restent √† la charge du Client.

Article 9 : Garanties - Conform√©ment √† la loi, le Vendeur assume les garanties de conformit√© et relatives aux vices cach√©s. Le Vendeur rembourse ou √©change les produits d√©fectueux ou ne correspondant pas √† la commande. Contact : 67stylemoi@gmail.com

Article 10 : R√©clamations et m√©diation - R√©clamations par mail : 67stylemoi@gmail.com. M√©diation : MED CONSO DEV - https://www.medconsodev.eu ou par courrier : MED CONSO DEV, Centre d'Affaires St√©phanois, 3 rue J.Constant Milleret, 42000 Saint-Etienne.

Article 11 : Force majeure - L'ex√©cution des obligations du vendeur est suspendue en cas de force majeure. Le vendeur avisera le client de la survenance d'un tel √©v√®nement d√®s que possible.

Article 12 : Protection des donn√©es personnelles - Conform√©ment au R√®glement 2016/679 du 27 avril 2016 (RGPD), le Vendeur met en place un traitement de donn√©es personnelles ayant pour finalit√© la vente et la livraison de produits et services.`,
    entreprise: {
        nom: "Styl'Emoi",
        complement: 'Entrepreneur individuel',
        adresse: '6G Rue de la M√©sange',
        codePostal: '67110',
        ville: 'NIEDERBRONN-LES-BAINS',
        telephone: '06 71 66 81 02',
        email: 'contact@stylemoi.fr',
        siret: '933 150 773 000 10',
        rcs: 'RCS Strasbourg 933 150 773 Code APE 4791A',
        iban: 'FR76 10 27 8017 8000 0206 0130 132',
        bic: 'CMCIFR2A',
        exonereTVA: true
    },
    // Taux URSSAF par mois (cl√©: YYYY-MM, valeur: taux)
    tauxURSSAFParMois: {
        'default': 23.20
    },
    tauxTVA: [0, 5.5, 10, 20],
    moyensReglement: ['ch√®que', 'virement', 'carte bancaire', 'esp√®ces', 'paypal', 'CB', '√† d√©finir'],
    categories: [
        { id: 'tasses', nom: 'Tasses', icon: '‚òï' },
        { id: 'gourdes', nom: 'Gourdes', icon: 'üç∂' },
        { id: 'verres', nom: 'Verres', icon: 'ü•õ' },
        { id: 'ardoises', nom: 'Ardoises', icon: 'ü™®' },
        { id: 'panneaux', nom: 'Panneaux', icon: 'üñºÔ∏è' },
        { id: 'cuisine', nom: 'Cuisine', icon: 'üç≥' },
        { id: 'tabliers', nom: 'Tabliers', icon: 'üëî' },
        { id: 'boites', nom: 'Bo√Ætes', icon: 'üì¶' },
        { id: 'accessoires', nom: 'Accessoires', icon: 'üéÅ' },
        { id: 'coussins', nom: 'Coussins', icon: 'üõãÔ∏è' },
        { id: 'tshirts', nom: 'T-shirts', icon: 'üëï' },
        { id: 'bebe', nom: 'B√©b√©', icon: 'üë∂' },
        { id: 'serviettes', nom: 'Serviettes', icon: 'üõÅ' },
        { id: 'divers', nom: 'Divers', icon: 'üìã' }
    ],
    clients: [
        { numero: 'C00001', type: 'Professionnel', nom: 'WALTER Patrice', adresse: '3 rue des Hirondelles', codePostal: '67110', ville: 'GUNDERSHOFFEN', telephone: '', portable: '06 37 70 37 31', email: 'walterpatrice67@gmail.com' },
        { numero: 'C00002', type: 'Particulier', nom: 'CHRISTMANN Corine', adresse: '19 route de Philippsbourg', codePostal: '67110', ville: 'Neunhoffen', telephone: '', portable: '06 85 68 72 96', email: '' },
        { numero: 'C00003', type: 'Particulier', nom: 'RAKOTOSALAMA Rojo', adresse: '20 rue de Lobsann', codePostal: '67250', ville: 'Soultz-sous-For√™ts', telephone: '', portable: '648865782', email: 'rojorakotosalama@yahoo.fr' },
        { numero: 'C00004', type: 'Particulier', nom: 'Ferri C√©line', adresse: '19 rue s≈ìur Marie', codePostal: '67500', ville: 'Weitbruch', telephone: '', portable: '622005989', email: '' },
        { numero: 'C00005', type: 'Particulier', nom: 'Wingert Leslie', adresse: '5 rue de la Rotlach', codePostal: '67850', ville: 'Herrlisheim', telephone: '', portable: '', email: '' },
        { numero: 'C00006', type: 'Particulier', nom: 'Schmitt Audrey', adresse: '1 passage du Murin', codePostal: '67500', ville: 'Haguenau', telephone: '', portable: '614145487', email: '' },
        { numero: 'C00007', type: 'Particulier', nom: 'Waechter Andr√©e', adresse: '7 rue de la Sabloni√®re', codePostal: '67110', ville: 'Reichshoffen', telephone: '', portable: '786493984', email: '' },
        { numero: 'C00008', type: 'Particulier', nom: 'Brunner Emmanuelle', adresse: '42 rue des roseaux', codePostal: '67590', ville: 'Schweighouse-sur-Moder', telephone: '', portable: '671815064', email: '' },
        { numero: 'C00009', type: 'Particulier', nom: 'Weibel Joelle', adresse: '7 IMPASSES DES JARDINS', codePostal: '67590', ville: 'OHLUNGEN', telephone: '', portable: '626102755', email: '' },
        { numero: 'C00010', type: 'Particulier', nom: 'GITZ MORGANE', adresse: '91 RUE PRINCIPALE', codePostal: '67590', ville: 'OHLUNGEN', telephone: '', portable: '620951401', email: '' },
        { numero: 'C00011', type: 'Particulier', nom: 'Restaurant les Cordons Bleus', adresse: '20 rue Principale', codePostal: '67250', ville: 'Lobsann', telephone: '', portable: '624185568', email: '' },
        { numero: 'C00012', type: 'Particulier', nom: 'CHRISTMANN DELPHINE', adresse: '18 CITE NAPOLEON', codePostal: '67660', ville: 'BETCHDORF', telephone: '', portable: '681615580', email: '' },
        { numero: 'C00013', type: 'Particulier', nom: 'Virginie', adresse: '21 rue des vergers', codePostal: '68640', ville: 'Waldighoffen', telephone: '', portable: '683674047', email: 'Booggybooggy68@gmail.com' },
        { numero: 'C00014', type: 'Particulier', nom: 'FROBERGER KERLEN GAELLE', adresse: '3 RUE DE LARGITZEN', codePostal: '68560', ville: 'Hirsingue', telephone: '', portable: '688813905', email: 'greg.gaelle51@hotmail.fr' },
        { numero: 'C00015', type: 'Particulier', nom: 'Elodie', adresse: '', codePostal: '', ville: '', telephone: '', portable: '', email: '' },
        { numero: 'C00016', type: 'Particulier', nom: 'Marion', adresse: '', codePostal: '', ville: '', telephone: '', portable: '', email: '' },
        { numero: 'C00017', type: 'Particulier', nom: 'Association des cerfs solidaires', adresse: '', codePostal: '67360', ville: 'Langensoultzbach', telephone: '', portable: '', email: '' },
        { numero: 'C00018', type: 'Particulier', nom: 'AAPPMA Gundershoffen', adresse: '', codePostal: '67110', ville: 'Gundershoffen', telephone: '', portable: '', email: '' },
        { numero: 'C00019', type: 'Particulier', nom: 'hoernel antoine', adresse: '', codePostal: '67110', ville: 'Gundershoffen', telephone: '', portable: '', email: '' },
        { numero: 'C00020', type: 'Particulier', nom: 'CSE fonderie de Niederbronn', adresse: '', codePostal: '67110', ville: 'Niederbronn les bains', telephone: '', portable: '', email: 'Georges.VOLTZ@fonderiedeniederbronn.com' },
        { numero: 'C00021', type: 'Particulier', nom: 'weiss maria', adresse: '', codePostal: '', ville: 'sessenheim', telephone: '', portable: '', email: '' },
        { numero: 'C00022', type: 'Particulier', nom: 'CANARELLI CELINE', adresse: '', codePostal: '44320', ville: 'CHAUMES EN RETZ', telephone: '', portable: '', email: '' },
        { numero: 'C00023', type: 'Particulier', nom: 'Klein Fabienne', adresse: '', codePostal: '67110', ville: 'Reichshoffen', telephone: '', portable: '', email: '' },
        { numero: 'C00024', type: 'Particulier', nom: 'Schneider Dylan', adresse: '', codePostal: '67360', ville: 'Preuschdorf', telephone: '', portable: '', email: '' },
        { numero: 'C00025', type: 'Particulier', nom: 'Pauli Anita', adresse: '7 rue Charles Munch', codePostal: '67580', ville: 'Mertzwiller', telephone: '', portable: '', email: '' },
        { numero: 'C00026', type: 'Particulier', nom: 'March√© de No√´l Novembre', adresse: '', codePostal: '', ville: '', telephone: '', portable: '', email: '' },
        { numero: 'C00027', type: 'Particulier', nom: 'March√© de No√´l D√©cembre', adresse: '', codePostal: '', ville: '', telephone: '', portable: '', email: '' },
    ],
    produits: [
        // TASSES - T001 √† T018
        { reference: 'T001', description: 'Tasse blanche c√©ramique', prixHT: 12.00, tauxTVA: 0, coutAchat: 1.32, marge: 8.09, categorie: 'tasses', stock: 17 },
        { reference: 'T002', description: 'Tasse √©mail 450 ml personnalis√©e', prixHT: 15.00, tauxTVA: 0, coutAchat: 3.62, marge: 3.15, categorie: 'tasses', stock: 15 },
        { reference: 'T003', description: 'Tasse inox 400 ml personnalis√©e', prixHT: 15.00, tauxTVA: 0, coutAchat: 5.05, marge: 1.97, categorie: 'tasses', stock: 2 },
        { reference: 'T004', description: 'Tasse plastique', prixHT: 0, tauxTVA: 0, coutAchat: 3.09, marge: 0, categorie: 'tasses', stock: 12 },
        { reference: 'T005', description: 'Tasse conique', prixHT: 0, tauxTVA: 0, coutAchat: 3.64, marge: 0, categorie: 'tasses', stock: 12 },
        { reference: 'T006', description: 'Tasse Waouh', prixHT: 15.00, tauxTVA: 0, coutAchat: 2.44, marge: 5.15, categorie: 'tasses', stock: 4 },
        { reference: 'T007', description: 'Tasse noir int blanc', prixHT: 0, tauxTVA: 0, coutAchat: 0, marge: 0, categorie: 'tasses', stock: 12 },
        { reference: 'T008', description: 'Tasse en verre jaune', prixHT: 15.00, tauxTVA: 0, coutAchat: 3.37, marge: 3.45, categorie: 'tasses', stock: 2 },
        { reference: 'T009', description: 'Tasse en verre violet', prixHT: 15.00, tauxTVA: 0, coutAchat: 3.37, marge: 3.45, categorie: 'tasses', stock: 2 },
        { reference: 'T010', description: 'Tasse en verre bleu', prixHT: 15.00, tauxTVA: 0, coutAchat: 3.37, marge: 3.45, categorie: 'tasses', stock: 1 },
        { reference: 'T011', description: 'Tasse paillette gris bleu', prixHT: 15.00, tauxTVA: 0, coutAchat: 2.98, marge: 4.04, categorie: 'tasses', stock: 2 },
        { reference: 'T012', description: 'Tasse paillette gris rose', prixHT: 15.00, tauxTVA: 0, coutAchat: 2.87, marge: 4.23, categorie: 'tasses', stock: 1 },
        { reference: 'T013', description: 'Tasse paillette gris jaune', prixHT: 15.00, tauxTVA: 0, coutAchat: 2.87, marge: 4.23, categorie: 'tasses', stock: 2 },
        { reference: 'T014', description: 'Tasse paillette rose jaune', prixHT: 15.00, tauxTVA: 0, coutAchat: 2.98, marge: 4.04, categorie: 'tasses', stock: 1 },
        { reference: 'T015', description: 'Tasse paillette rose bleu', prixHT: 15.00, tauxTVA: 0, coutAchat: 2.98, marge: 4.04, categorie: 'tasses', stock: 1 },
        { reference: 'T016', description: 'Mug thermos Inox 470 ml', prixHT: 20.00, tauxTVA: 0, coutAchat: 8.40, marge: 1.38, categorie: 'tasses', stock: 0 },
        { reference: 'T017', description: 'Mug thermos Inox 390ml', prixHT: 1.00, tauxTVA: 0, coutAchat: 6.66, marge: 0, categorie: 'tasses', stock: 3 },
        { reference: 'T018', description: 'Boite pour tasse en c√©ramique', prixHT: 1.00, tauxTVA: 0, coutAchat: 1.00, marge: 0, categorie: 'tasses', stock: 0 },
        { reference: 'T019', description: 'Choppe √† bi√®re 500ML', prixHT: 18.00, tauxTVA: 0, coutAchat: 4.80, marge: 2.75, categorie: 'tasses', stock: 6 },
        { reference: 'T020', description: 'Bol en c√©ramique petit', prixHT: 20.00, tauxTVA: 0, coutAchat: 6.16, marge: 2.25, categorie: 'tasses', stock: 3 },
        { reference: 'T021', description: 'Bol c√©r√©ales c√©ramique', prixHT: 18.00, tauxTVA: 0, coutAchat: 5.83, marge: 2.09, categorie: 'tasses', stock: 3 },
        { reference: 'T022', description: 'Pot √† biscuit', prixHT: 15.00, tauxTVA: 0, coutAchat: 7.00, marge: 1.14, categorie: 'tasses', stock: 0 },
        // GOURDES - G001 √† G014
        { reference: 'G001', description: 'Gourde Iso inox 500ML Blanche', prixHT: 18.00, tauxTVA: 0, coutAchat: 7.54, marge: 1.39, categorie: 'gourdes', stock: 3 },
        { reference: 'G002', description: 'Gourde Iso inox 500ML violet', prixHT: 18.00, tauxTVA: 0, coutAchat: 8.01, marge: 1.25, categorie: 'gourdes', stock: 3 },
        { reference: 'G003', description: 'Gourde Iso inox 500ML rose/blanc', prixHT: 18.00, tauxTVA: 0, coutAchat: 8.01, marge: 1.25, categorie: 'gourdes', stock: 3 },
        { reference: 'G004', description: 'Gourde Iso inox 500ML bleu/vert', prixHT: 18.00, tauxTVA: 0, coutAchat: 8.01, marge: 1.25, categorie: 'gourdes', stock: 3 },
        { reference: 'G005', description: 'Gourde sport Alu Gris 500ML', prixHT: 13.00, tauxTVA: 0, coutAchat: 4.27, marge: 2.05, categorie: 'gourdes', stock: 3 },
        { reference: 'G006', description: 'Gourde sport Alu Blanc 500ML', prixHT: 13.00, tauxTVA: 0, coutAchat: 4.27, marge: 2.05, categorie: 'gourdes', stock: 3 },
        { reference: 'G007', description: 'Bouteille iso inox Blanc/Gris 750ML', prixHT: 20.00, tauxTVA: 0, coutAchat: 8.26, marge: 1.42, categorie: 'gourdes', stock: 0 },
        { reference: 'G008', description: 'Bouteille iso inox Gris 750ML', prixHT: 20.00, tauxTVA: 0, coutAchat: 8.26, marge: 1.42, categorie: 'gourdes', stock: 0 },
        { reference: 'G009', description: 'Bouteille iso inox Blanc 750ML', prixHT: 20.00, tauxTVA: 0, coutAchat: 8.26, marge: 1.42, categorie: 'gourdes', stock: 0 },
        { reference: 'G010', description: 'Thermos Inox 750ML Gris+Gobelet', prixHT: 22.00, tauxTVA: 0, coutAchat: 10.31, marge: 1.13, categorie: 'gourdes', stock: 0 },
        { reference: 'G011', description: 'Thermos Inox 750ML Blanc+Gobelet', prixHT: 22.00, tauxTVA: 0, coutAchat: 10.31, marge: 1.13, categorie: 'gourdes', stock: 0 },
        { reference: 'G012', description: 'Cannette iso inox 380Ml', prixHT: 20.00, tauxTVA: 0, coutAchat: 8.25, marge: 1.42, categorie: 'gourdes', stock: 0 },
        { reference: 'G013', description: 'Gobelet cannette subli', prixHT: 18.00, tauxTVA: 0, coutAchat: 7.50, marge: 1.40, categorie: 'gourdes', stock: 16 },
        { reference: 'G014', description: 'Gourde Iso 500ML Paillettes Bleu', prixHT: 20.00, tauxTVA: 0, coutAchat: 8.46, marge: 1.36, categorie: 'gourdes', stock: 2 },
        { reference: 'G015', description: 'Gourde Iso 500ML Paillettes Gold', prixHT: 20.00, tauxTVA: 0, coutAchat: 8.46, marge: 1.36, categorie: 'gourdes', stock: 2 },
        { reference: 'G016', description: 'Gourde Iso 500ML Paillettes Argent', prixHT: 20.00, tauxTVA: 0, coutAchat: 8.46, marge: 1.36, categorie: 'gourdes', stock: 2 },
        { reference: 'G017', description: 'Gourde Iso 500ML Paillettes Rose', prixHT: 20.00, tauxTVA: 0, coutAchat: 8.46, marge: 1.36, categorie: 'gourdes', stock: 2 },
        { reference: 'G018', description: 'Flasque acier inox 20cl', prixHT: 15.00, tauxTVA: 0, coutAchat: 6.58, marge: 1.28, categorie: 'gourdes', stock: 0 },
        // VERRES - V001 √† V004
        { reference: 'V001', description: 'Verre cannette avec paille givr√©', prixHT: 20.00, tauxTVA: 0, coutAchat: 5.00, marge: 3.00, categorie: 'verres', stock: 4 },
        { reference: 'V002', description: 'Verre cannette avec paille bleu', prixHT: 20.00, tauxTVA: 0, coutAchat: 5.00, marge: 3.00, categorie: 'verres', stock: 1 },
        { reference: 'V003', description: 'Verre cannette avec paille vert', prixHT: 20.00, tauxTVA: 0, coutAchat: 5.00, marge: 3.00, categorie: 'verres', stock: 1 },
        { reference: 'V004', description: 'Verre cannette avec paille transparent', prixHT: 18.00, tauxTVA: 0, coutAchat: 4.60, marge: 2.91, categorie: 'verres', stock: 3 },
        // ARDOISES - A001 √† A009
        { reference: 'A001', description: 'Ardoise carr√©e 15x15', prixHT: 15.00, tauxTVA: 0, coutAchat: 4.94, marge: 2.04, categorie: 'ardoises', stock: 0 },
        { reference: 'A002', description: 'Ardoise carr√©e 20x20', prixHT: 20.00, tauxTVA: 0, coutAchat: 5.32, marge: 2.76, categorie: 'ardoises', stock: 9 },
        { reference: 'A003', description: 'Ardoise carr√©e 30x30', prixHT: 30.00, tauxTVA: 0, coutAchat: 9.89, marge: 2.03, categorie: 'ardoises', stock: 0 },
        { reference: 'A004', description: 'Ardoise rectangulaire 20x30', prixHT: 20.00, tauxTVA: 0, coutAchat: 8.20, marge: 1.44, categorie: 'ardoises', stock: 0 },
        { reference: 'A005', description: 'Ardoise rectangulaire 15x20', prixHT: 15.00, tauxTVA: 0, coutAchat: 5.53, marge: 1.71, categorie: 'ardoises', stock: 13 },
        { reference: 'A006', description: 'Ardoise c≈ìur', prixHT: 20.00, tauxTVA: 0, coutAchat: 8.35, marge: 1.40, categorie: 'ardoises', stock: 0 },
        { reference: 'A007', description: 'Ardoise croix', prixHT: 20.00, tauxTVA: 0, coutAchat: 8.35, marge: 1.40, categorie: 'ardoises', stock: 0 },
        { reference: 'A008', description: 'Ardoise ovale', prixHT: 18.00, tauxTVA: 0, coutAchat: 6.90, marge: 1.61, categorie: 'ardoises', stock: 0 },
        { reference: 'A009', description: 'Ardoise horloge', prixHT: 40.00, tauxTVA: 0, coutAchat: 15.90, marge: 1.52, categorie: 'ardoises', stock: 0 },
        // BOITES - BO001 √† BO005
        { reference: 'BO001', description: 'Bo√Æte √† gouter Bleu Clair', prixHT: 15.00, tauxTVA: 0, coutAchat: 5.34, marge: 1.81, categorie: 'boites', stock: 1 },
        { reference: 'BO002', description: 'Bo√Æte √† gouter Bleu fonc√©', prixHT: 15.00, tauxTVA: 0, coutAchat: 5.34, marge: 1.81, categorie: 'boites', stock: 0 },
        { reference: 'BO003', description: 'Bo√Æte √† gouter Vert', prixHT: 15.00, tauxTVA: 0, coutAchat: 5.34, marge: 1.81, categorie: 'boites', stock: 0 },
        { reference: 'BO004', description: 'Bo√Æte √† gouter Rose', prixHT: 15.00, tauxTVA: 0, coutAchat: 5.34, marge: 1.81, categorie: 'boites', stock: 1 },
        { reference: 'BO005', description: 'Bo√Æte √† gouter Rouge', prixHT: 15.00, tauxTVA: 0, coutAchat: 5.34, marge: 1.81, categorie: 'boites', stock: 0 },
        // PANNEAUX - PA001 √† PA011
        { reference: 'PA001', description: 'Panneau acrylique 100x150', prixHT: 8.00, tauxTVA: 0, coutAchat: 2.38, marge: 2.36, categorie: 'panneaux', stock: 2 },
        { reference: 'PA002', description: 'Panneau acrylique 150x200', prixHT: 10.00, tauxTVA: 0, coutAchat: 4.65, marge: 1.15, categorie: 'panneaux', stock: 1 },
        { reference: 'PA003', description: 'Panneau acrylique 150x300', prixHT: 15.00, tauxTVA: 0, coutAchat: 6.66, marge: 1.25, categorie: 'panneaux', stock: 0 },
        { reference: 'PA004', description: 'Panneau acrylique 200x250', prixHT: 18.00, tauxTVA: 0, coutAchat: 7.38, marge: 1.44, categorie: 'panneaux', stock: 0 },
        { reference: 'PA005', description: 'Panneau acrylique 200x300', prixHT: 22.00, tauxTVA: 0, coutAchat: 10.25, marge: 1.15, categorie: 'panneaux', stock: 0 },
        { reference: 'PA006', description: 'Panneau acrylique 100x200', prixHT: 8.50, tauxTVA: 0, coutAchat: 3.56, marge: 1.39, categorie: 'panneaux', stock: 0 },
        { reference: 'PA007', description: 'Plaque photo Alu 12,5x17,5', prixHT: 0, tauxTVA: 0, coutAchat: 0, marge: 0, categorie: 'panneaux', stock: 3 },
        { reference: 'PA008', description: 'Panneau en verre 178x127', prixHT: 15.00, tauxTVA: 0, coutAchat: 6.80, marge: 1.21, categorie: 'panneaux', stock: 2 },
        { reference: 'PA009', description: 'Panneau en verre 127x178', prixHT: 15.00, tauxTVA: 0, coutAchat: 6.80, marge: 1.21, categorie: 'panneaux', stock: 1 },
        { reference: 'PA010', description: 'Panneau en verre 250x203', prixHT: 20.00, tauxTVA: 0, coutAchat: 9.88, marge: 1.02, categorie: 'panneaux', stock: 0 },
        { reference: 'PA011', description: 'Panneau en verre 203x250', prixHT: 20.00, tauxTVA: 0, coutAchat: 9.88, marge: 1.02, categorie: 'panneaux', stock: 0 },
        // CUISINE - CU001 √† CU008
        { reference: 'CU001', description: 'Gant cuisine', prixHT: 6.00, tauxTVA: 0, coutAchat: 2.91, marge: 1.06, categorie: 'cuisine', stock: 2 },
        { reference: 'CU002', description: 'Manique cuisine', prixHT: 6.00, tauxTVA: 0, coutAchat: 2.91, marge: 1.06, categorie: 'cuisine', stock: 9 },
        { reference: 'CU003', description: 'Planche √† d√©couper polym√®re 235x140', prixHT: 12.50, tauxTVA: 0, coutAchat: 4.36, marge: 1.87, categorie: 'cuisine', stock: 2 },
        { reference: 'CU004', description: 'Planche √† d√©couper polym√®re 200x250', prixHT: 15.00, tauxTVA: 0, coutAchat: 5.60, marge: 1.68, categorie: 'cuisine', stock: 2 },
        { reference: 'CU005', description: 'Planche √† d√©couper verre ronde 300', prixHT: 7.77, tauxTVA: 0, coutAchat: 7.77, marge: 0, categorie: 'cuisine', stock: 0 },
        { reference: 'CU006', description: 'Planche √† d√©couper verre 285x391', prixHT: 7.60, tauxTVA: 0, coutAchat: 7.60, marge: 0, categorie: 'cuisine', stock: 0 },
        { reference: 'CU007', description: 'Planche √† d√©couper verre 200x285', prixHT: 5.86, tauxTVA: 0, coutAchat: 5.86, marge: 0, categorie: 'cuisine', stock: 0 },
        { reference: 'CU008', description: 'Carrelage en verre 152x152', prixHT: 2.35, tauxTVA: 0, coutAchat: 2.35, marge: 0, categorie: 'cuisine', stock: 0 },
        // TABLIERS - TA001 √† TA004
        { reference: 'TA001', description: 'Tablier Enfant 360x510', prixHT: 2.37, tauxTVA: 0, coutAchat: 2.37, marge: 0, categorie: 'tabliers', stock: 0 },
        { reference: 'TA002', description: 'Tablier Enfant 480x650', prixHT: 2.74, tauxTVA: 0, coutAchat: 2.74, marge: 0, categorie: 'tabliers', stock: 1 },
        { reference: 'TA003', description: 'Tablier Adulte 600x850', prixHT: 4.90, tauxTVA: 0, coutAchat: 4.90, marge: 0, categorie: 'tabliers', stock: 1 },
        { reference: 'TA004', description: 'Tablier Adulte 700x950', prixHT: 6.15, tauxTVA: 0, coutAchat: 6.15, marge: 0, categorie: 'tabliers', stock: 0 },
        // ACCESSOIRES - AC001 √† AC019
        { reference: 'AC001', description: 'Badge Aimant√© 75x50mm', prixHT: 1.07, tauxTVA: 0, coutAchat: 1.07, marge: 0, categorie: 'accessoires', stock: 10 },
        { reference: 'AC002', description: 'Magnet C≈ìur', prixHT: 2.18, tauxTVA: 0, coutAchat: 2.18, marge: 0, categorie: 'accessoires', stock: 1 },
        { reference: 'AC003', description: 'Tapis de souris', prixHT: 8.00, tauxTVA: 0, coutAchat: 1.57, marge: 4.10, categorie: 'accessoires', stock: 6 },
        { reference: 'AC004', description: 'Zippo', prixHT: 0, tauxTVA: 0, coutAchat: 0, marge: 0, categorie: 'accessoires', stock: 4 },
        { reference: 'AC005', description: 'Tirelire', prixHT: 10.00, tauxTVA: 0, coutAchat: 3.31, marge: 2.02, categorie: 'accessoires', stock: 1 },
        { reference: 'AC006', description: 'Porte Carte Bois avec ou sans pr√©nom', prixHT: 2.50, tauxTVA: 0, coutAchat: 2.50, marge: 0, categorie: 'accessoires', stock: 3 },
        { reference: 'AC007', description: 'Dessous de Verre sublimable', prixHT: 0, tauxTVA: 0, coutAchat: 0, marge: 0, categorie: 'accessoires', stock: 39 },
        { reference: 'AC008', description: 'Lingettes Lunettes Sublimable', prixHT: 0, tauxTVA: 0, coutAchat: 0, marge: 0, categorie: 'accessoires', stock: 39 },
        { reference: 'AC009', description: 'D√©capsuleur Metal', prixHT: 0, tauxTVA: 0, coutAchat: 0, marge: 0, categorie: 'accessoires', stock: 9 },
        { reference: 'AC010', description: 'D√©capsuleur Bois', prixHT: 0, tauxTVA: 0, coutAchat: 0, marge: 0, categorie: 'accessoires', stock: 5 },
        { reference: 'AC011', description: 'Marque page 95mm', prixHT: 0, tauxTVA: 0, coutAchat: 0, marge: 0, categorie: 'accessoires', stock: 5 },
        { reference: 'AC012', description: 'Cabas tissus', prixHT: 0, tauxTVA: 0, coutAchat: 0, marge: 0, categorie: 'accessoires', stock: 8 },
        { reference: 'AC013', description: 'Lampe sublimable', prixHT: 0, tauxTVA: 0, coutAchat: 0, marge: 0, categorie: 'accessoires', stock: 5 },
        { reference: 'AC014', description: 'Horloge Mural sublimable', prixHT: 11.44, tauxTVA: 0, coutAchat: 11.44, marge: 0, categorie: 'accessoires', stock: 0 },
        { reference: 'AC015', description: 'Puzzle', prixHT: 10.00, tauxTVA: 0, coutAchat: 3.50, marge: 1.86, categorie: 'accessoires', stock: 0 },
        { reference: 'AC016', description: 'Pendentif os alu', prixHT: 5.00, tauxTVA: 0, coutAchat: 1.75, marge: 1.86, categorie: 'accessoires', stock: 0 },
        // COUSSINS - CO001 √† CO007
        { reference: 'CO001', description: 'Coussin Coeur 40x44cm + housse sublimable', prixHT: 6.00, tauxTVA: 0, coutAchat: 6.00, marge: 0, categorie: 'coussins', stock: 0 },
        { reference: 'CO002', description: 'Coussin carr√© 35x35cm + housse sublimable', prixHT: 4.91, tauxTVA: 0, coutAchat: 4.91, marge: 0, categorie: 'coussins', stock: 3 },
        { reference: 'CO003', description: 'Coussin carr√© 40x40cm + housse sublimable', prixHT: 5.20, tauxTVA: 0, coutAchat: 5.20, marge: 0, categorie: 'coussins', stock: 0 },
        { reference: 'CO004', description: 'Coussin carr√© 45x45cm + housse sublimable', prixHT: 6.68, tauxTVA: 0, coutAchat: 6.68, marge: 0, categorie: 'coussins', stock: 0 },
        { reference: 'CO005', description: 'Coussin rectangulaire 80x40cm + housse sublimable', prixHT: 10.17, tauxTVA: 0, coutAchat: 10.17, marge: 0, categorie: 'coussins', stock: 1 },
        { reference: 'CO006', description: 'Bouillotte + Housse', prixHT: 8.06, tauxTVA: 0, coutAchat: 8.06, marge: 0, categorie: 'coussins', stock: 0 },
        // T-SHIRTS - TS001 √† TS022
        { reference: 'TS001', description: 'TSHIRT POLY BLEU TOUCHER COTON S-XL', prixHT: 10.08, tauxTVA: 0, coutAchat: 10.08, marge: 0, categorie: 'tshirts', stock: 0 },
        { reference: 'TS002', description: 'TSHIRT POLY BLEU TOUCHER COTON 2XL', prixHT: 11.22, tauxTVA: 0, coutAchat: 11.22, marge: 0, categorie: 'tshirts', stock: 0 },
        { reference: 'TS003', description: 'TSHIRT POLY BLEU TOUCHER COTON 3XL', prixHT: 11.82, tauxTVA: 0, coutAchat: 11.82, marge: 0, categorie: 'tshirts', stock: 0 },
        { reference: 'TS004', description: 'TSHIRT POLY GRIS TOUCHER COTON S-XL', prixHT: 10.08, tauxTVA: 0, coutAchat: 10.08, marge: 0, categorie: 'tshirts', stock: 0 },
        { reference: 'TS005', description: 'TSHIRT POLY GRIS TOUCHER COTON 2XL', prixHT: 11.22, tauxTVA: 0, coutAchat: 11.22, marge: 0, categorie: 'tshirts', stock: 0 },
        { reference: 'TS006', description: 'TSHIRT POLY GRIS TOUCHER COTON 3XL', prixHT: 11.82, tauxTVA: 0, coutAchat: 11.82, marge: 0, categorie: 'tshirts', stock: 0 },
        { reference: 'TS007', description: 'TSHIRT POLY BLANC TOUCHER COTON S-XL', prixHT: 10.08, tauxTVA: 0, coutAchat: 10.08, marge: 0, categorie: 'tshirts', stock: 0 },
        { reference: 'TS008', description: 'TSHIRT POLY BLANC TOUCHER COTON 2XL', prixHT: 11.22, tauxTVA: 0, coutAchat: 11.22, marge: 0, categorie: 'tshirts', stock: 0 },
        { reference: 'TS009', description: 'TSHIRT POLY BLANC TOUCHER COTON 3XL', prixHT: 11.82, tauxTVA: 0, coutAchat: 11.82, marge: 0, categorie: 'tshirts', stock: 0 },
        { reference: 'TS010', description: 'TSHIRT POLY VERT TOUCHER COTON S-XL', prixHT: 10.80, tauxTVA: 0, coutAchat: 10.80, marge: 0, categorie: 'tshirts', stock: 0 },
        { reference: 'TS011', description: 'TSHIRT POLY VERT TOUCHER COTON 2XL', prixHT: 11.22, tauxTVA: 0, coutAchat: 11.22, marge: 0, categorie: 'tshirts', stock: 0 },
        { reference: 'TS012', description: 'TSHIRT POLY VERT TOUCHER COTON 3XL', prixHT: 11.82, tauxTVA: 0, coutAchat: 11.82, marge: 0, categorie: 'tshirts', stock: 0 },
        { reference: 'TS013', description: 'TSHIRT POLY VERT TOUCHER COTON MIXTE S-XL', prixHT: 9.12, tauxTVA: 0, coutAchat: 9.12, marge: 0, categorie: 'tshirts', stock: 0 },
        { reference: 'TS014', description: 'TSHIRT POLY VERT TOUCHER COTON MIXTE 2XL', prixHT: 10.74, tauxTVA: 0, coutAchat: 10.74, marge: 0, categorie: 'tshirts', stock: 0 },
        { reference: 'TS015', description: 'TSHIRT POLY VERT TOUCHER COTON MIXTE 3XL', prixHT: 11.10, tauxTVA: 0, coutAchat: 11.10, marge: 0, categorie: 'tshirts', stock: 0 },
        { reference: 'TS016', description: 'TSHIRT POLY VERT TOUCHER COTON MIXTE 4XL', prixHT: 11.76, tauxTVA: 0, coutAchat: 11.76, marge: 0, categorie: 'tshirts', stock: 0 },
        { reference: 'TS017', description: 'TSHIRT POLY VERT TOUCHER COTON MIXTE 5XL', prixHT: 13.32, tauxTVA: 0, coutAchat: 13.32, marge: 0, categorie: 'tshirts', stock: 0 },
        { reference: 'TS018', description: 'TSHIRT POLY BLANC TOUCHER COTON ENFANT 2-16 ANS', prixHT: 7.62, tauxTVA: 0, coutAchat: 7.62, marge: 0, categorie: 'tshirts', stock: 0 },
        { reference: 'TS019', description: 'TSHIRT POLY COL V FEMME S-5XL', prixHT: 5.83, tauxTVA: 0, coutAchat: 5.83, marge: 0, categorie: 'tshirts', stock: 0 },
        { reference: 'TS020', description: 'TSHIRT POLY COL V HOMME S-5XL', prixHT: 5.83, tauxTVA: 0, coutAchat: 5.83, marge: 0, categorie: 'tshirts', stock: 0 },
        { reference: 'TS021', description: 'Tshirt rechange', prixHT: 0.96, tauxTVA: 0, coutAchat: 0.96, marge: 0, categorie: 'tshirts', stock: 0 },
        { reference: 'TS022', description: 'Tshirt rechange 2xl', prixHT: 2.82, tauxTVA: 0, coutAchat: 2.82, marge: 0, categorie: 'tshirts', stock: 0 },
        // BEBE - BE001 √† BE012
        { reference: 'BE001', description: 'Body B√©b√© Poly Ultra Doux', prixHT: 5.32, tauxTVA: 0, coutAchat: 5.32, marge: 0, categorie: 'bebe', stock: 0 },
        { reference: 'BE002', description: 'Bavoir Blanc', prixHT: 3.10, tauxTVA: 0, coutAchat: 3.10, marge: 0, categorie: 'bebe', stock: 7 },
        { reference: 'BE003', description: 'Doudou Mouton (xl)', prixHT: 5.48, tauxTVA: 0, coutAchat: 5.48, marge: 0, categorie: 'bebe', stock: 1 },
        { reference: 'BE004', description: 'Doudou Girafe (l)', prixHT: 5.48, tauxTVA: 0, coutAchat: 5.48, marge: 0, categorie: 'bebe', stock: 0 },
        { reference: 'BE005', description: 'Doudou Elephant (xl)', prixHT: 5.48, tauxTVA: 0, coutAchat: 5.48, marge: 0, categorie: 'bebe', stock: 0 },
        { reference: 'BE006', description: 'Doudou Ours (l) 220mm', prixHT: 5.93, tauxTVA: 0, coutAchat: 5.93, marge: 0, categorie: 'bebe', stock: 0 },
        { reference: 'BE007', description: 'Doudou ours Barney (m) 160mm', prixHT: 5.48, tauxTVA: 0, coutAchat: 5.48, marge: 0, categorie: 'bebe', stock: 0 },
        { reference: 'BE008', description: 'Doudou Lapin xxl 500mm', prixHT: 34.44, tauxTVA: 0, coutAchat: 34.44, marge: 0, categorie: 'bebe', stock: 0 },
        { reference: 'BE009', description: 'Doudou Lapin (m)', prixHT: 5.48, tauxTVA: 0, coutAchat: 5.48, marge: 0, categorie: 'bebe', stock: 0 },
        // SERVIETTES - SE001 √† SE002
        { reference: 'SE001', description: 'Serviette de bain 50x100', prixHT: 6.40, tauxTVA: 0, coutAchat: 6.40, marge: 0, categorie: 'serviettes', stock: 0 },
        { reference: 'SE002', description: 'Serviette de bain 70x141', prixHT: 11.95, tauxTVA: 0, coutAchat: 11.95, marge: 0, categorie: 'serviettes', stock: 0 },
        // DIVERS - DIV001 √† DIV003
        { reference: 'DIV001', description: 'Bo√Æte avec lumi√®re √©toile', prixHT: 25.00, tauxTVA: 0, coutAchat: 0, marge: 0, categorie: 'divers', stock: 0 },
        { reference: 'DIV002', description: 'March√© de No√´l Novembre', prixHT: 0, tauxTVA: 0, coutAchat: 0, marge: 0, categorie: 'divers', stock: 0 },
        { reference: 'DIV003', description: 'March√© de No√´l D√©cembre', prixHT: 0, tauxTVA: 0, coutAchat: 0, marge: 0, categorie: 'divers', stock: 0 },
        { reference: 'DIV004', description: 'Bo√Æte sans lumi√®re √©toile', prixHT: 22.00, tauxTVA: 0, coutAchat: 0, marge: 0, categorie: 'divers', stock: 0 },
        { reference: 'DIV005', description: 'Boule de No√´l', prixHT: 2.00, tauxTVA: 0, coutAchat: 0, marge: 0, categorie: 'divers', stock: 0 },
        { reference: 'DIV006', description: 'Boule de No√´l en bois', prixHT: 4.00, tauxTVA: 0, coutAchat: 0, marge: 0, categorie: 'divers', stock: 0 },
    ],
    factures: [
        { numero: 'F00001', clientId: 'C00002', date: '2024-10-23', dateEcheance: '2024-11-22', modeReglement: 'esp√®ces', remise: 0, acompte: 0, lignes: [{ id: 1, reference: 'T002', description: 'Tasse √©mail 450 ml personnalis√©e', prixHT: 15.0, quantite: 1, tauxTVA: 0 }], totalHT: 15.0, totalTTC: 15.0 },
        { numero: 'F00002', clientId: 'C00002', date: '2024-10-27', dateEcheance: '2024-11-26', modeReglement: 'esp√®ces', remise: 0, acompte: 0, lignes: [{ id: 1, reference: 'T002', description: 'Tasse √©mail 450 ml personnalis√©e', prixHT: 15.0, quantite: 2, tauxTVA: 0 }], totalHT: 30.01, totalTTC: 30.01 },
        { numero: 'F00003', clientId: 'C00003', date: '2024-11-15', dateEcheance: '2024-12-15', modeReglement: 'esp√®ces', remise: 0, acompte: 0, lignes: [{ id: 1, reference: 'T015', description: 'Tasse paillette rose bleu', prixHT: 15.0, quantite: 9, tauxTVA: 0 }], totalHT: 135.04, totalTTC: 135.04 },
        { numero: 'F00004', clientId: 'C00004', date: '2024-11-24', dateEcheance: '2024-12-24', modeReglement: 'esp√®ces', remise: 0, acompte: 0, lignes: [{ id: 1, reference: 'T015', description: 'Tasse paillette rose bleu', prixHT: 15.0, quantite: 4, tauxTVA: 0 }], totalHT: 60.02, totalTTC: 60.02 },
        { numero: 'F00005', clientId: 'C00005', date: '2024-11-24', dateEcheance: '2024-12-24', modeReglement: 'esp√®ces', remise: 0, acompte: 0, lignes: [{ id: 1, reference: 'T015', description: 'Tasse paillette rose bleu', prixHT: 15.0, quantite: 4, tauxTVA: 0 }, { id: 2, reference: 'A006', description: 'Ardoise c≈ìur', prixHT: 20.0, quantite: 4, tauxTVA: 0 }], totalHT: 140.02, totalTTC: 140.02 },
        { numero: 'F00006', clientId: 'C00006', date: '2024-12-04', dateEcheance: '2025-01-03', modeReglement: 'paypal', remise: 0, acompte: 0, lignes: [{ id: 1, reference: 'V001', description: 'Verre cannette avec paille givr√©', prixHT: 20.0, quantite: 1, tauxTVA: 0 }], totalHT: 20.0, totalTTC: 20.0 },
        { numero: 'F00007', clientId: 'C00007', date: '2024-12-04', dateEcheance: '2025-01-03', modeReglement: 'esp√®ces', remise: 0, acompte: 0, lignes: [{ id: 1, reference: 'T006', description: 'Tasse Waouh', prixHT: 15.0, quantite: 2, tauxTVA: 0 }, { id: 2, reference: 'T008', description: 'Tasse en verre jaune', prixHT: 15.0, quantite: 1, tauxTVA: 0 }, { id: 3, reference: 'G006', description: 'Gourde sport Alu Blanc 500ML', prixHT: 13.0, quantite: 1, tauxTVA: 0 }], totalHT: 58.0, totalTTC: 58.0 },
        { numero: 'F00008', clientId: 'C00008', date: '2024-12-04', dateEcheance: '2025-01-03', modeReglement: 'CB', remise: 0, acompte: 0, lignes: [{ id: 1, reference: 'G004', description: 'Gourde Iso inox 500ML bleu/vert', prixHT: 18.0, quantite: 1, tauxTVA: 0 }], totalHT: 18.0, totalTTC: 18.0 },
        { numero: 'F00009', clientId: 'C00010', date: '2024-12-04', dateEcheance: '2025-01-03', modeReglement: 'CB', remise: 0, acompte: 0, lignes: [{ id: 1, reference: 'T008', description: 'Tasse en verre jaune', prixHT: 15.0, quantite: 1, tauxTVA: 0 }], totalHT: 15.0, totalTTC: 15.0 },
        { numero: 'F00010', clientId: 'C00011', date: '2024-12-05', dateEcheance: '2025-01-04', modeReglement: '√† d√©finir', remise: 0, acompte: 0, lignes: [{ id: 1, reference: 'T014', description: 'Tasse paillette rose jaune', prixHT: 15.0, quantite: 3, tauxTVA: 0 }, { id: 2, reference: 'A007', description: 'Ardoise croix', prixHT: 20.0, quantite: 1, tauxTVA: 0 }, { id: 3, reference: 'BO003', description: 'Bo√Æte √† gouter Vert', prixHT: 15.0, quantite: 1, tauxTVA: 0 }, { id: 4, reference: 'BO004', description: 'Bo√Æte √† gouter Rose', prixHT: 15.0, quantite: 1, tauxTVA: 0 }], totalHT: 95.01, totalTTC: 95.01 },
        { numero: 'F00011', clientId: 'C00001', date: '2024-12-07', dateEcheance: '2025-01-06', modeReglement: 'CB', remise: 0, acompte: 0, lignes: [{ id: 1, reference: 'T008', description: 'Tasse en verre jaune', prixHT: 15.0, quantite: 1, tauxTVA: 0 }], totalHT: 15.0, totalTTC: 15.0 },
        { numero: 'F00012', clientId: 'C00001', date: '2024-12-07', dateEcheance: '2025-01-06', modeReglement: 'CB', remise: 0, acompte: 0, lignes: [{ id: 1, reference: 'G005', description: 'Gourde sport Alu Gris 500ML', prixHT: 13.0, quantite: 2, tauxTVA: 0 }], totalHT: 26.0, totalTTC: 26.0 },
        { numero: 'F00013', clientId: 'C00012', date: '2024-12-19', dateEcheance: '2025-01-18', modeReglement: 'CB', remise: 0, acompte: 0, lignes: [{ id: 1, reference: 'T015', description: 'Tasse paillette rose bleu', prixHT: 15.0, quantite: 3, tauxTVA: 0 }, { id: 2, reference: 'BO004', description: 'Bo√Æte √† gouter Rose', prixHT: 15.0, quantite: 3, tauxTVA: 0 }], totalHT: 90.01, totalTTC: 90.01 },
        { numero: 'F00014', clientId: 'C00013', date: '2025-02-27', dateEcheance: '2025-03-29', modeReglement: 'virement', remise: 0, acompte: 0, lignes: [{ id: 1, reference: 'T007', description: 'Tasse noir int blanc', prixHT: 0.0, quantite: 1, tauxTVA: 0 }], totalHT: 0.0, totalTTC: 0.0 },
        { numero: 'F00015', clientId: 'C00015', date: '2025-02-27', dateEcheance: '2025-03-29', modeReglement: 'esp√®ces', remise: 0, acompte: 0, lignes: [{ id: 1, reference: 'T007', description: 'Tasse noir int blanc', prixHT: 0.0, quantite: 1, tauxTVA: 0 }], totalHT: 0.0, totalTTC: 0.0 },
        { numero: 'F00016', clientId: 'C00016', date: '2025-02-27', dateEcheance: '2025-03-29', modeReglement: 'esp√®ces', remise: 0, acompte: 0, lignes: [{ id: 1, reference: 'T007', description: 'Tasse noir int blanc', prixHT: 0.0, quantite: 1, tauxTVA: 0 }, { id: 2, reference: 'T008', description: 'Tasse en verre jaune', prixHT: 15.0, quantite: 2, tauxTVA: 0 }], totalHT: 29.99, totalTTC: 29.99 },
        { numero: 'F00017', clientId: 'C00014', date: '2025-02-27', dateEcheance: '2025-03-29', modeReglement: 'virement', remise: 0, acompte: 0, lignes: [{ id: 1, reference: 'T007', description: 'Tasse noir int blanc', prixHT: 0.0, quantite: 1, tauxTVA: 0 }], totalHT: 0.0, totalTTC: 0.0 },
        { numero: 'F00018', clientId: 'C00017', date: '2025-03-30', dateEcheance: '2025-04-29', modeReglement: 'paypal', remise: 0, acompte: 0, lignes: [{ id: 1, reference: 'PA001', description: 'Panneau acrylique 100 x 150', prixHT: 8.0, quantite: 1, tauxTVA: 0 }, { id: 2, reference: 'PA002', description: 'Panneau acrylique 150 x 200', prixHT: 10.0, quantite: 1, tauxTVA: 0 }], totalHT: 17.99, totalTTC: 17.99 },
        { numero: 'F00019', clientId: 'C00001', date: '2025-04-20', dateEcheance: '2025-05-20', modeReglement: '√† d√©finir', remise: 0, acompte: 0, lignes: [{ id: 1, reference: 'T002', description: 'Tasse √©mail 450 ml personnalis√©e', prixHT: 15.0, quantite: 1, tauxTVA: 0 }], totalHT: 15.0, totalTTC: 15.0 },
        { numero: 'F00020', clientId: 'C00017', date: '2025-04-25', dateEcheance: '2025-05-25', modeReglement: 'paypal', remise: 0, acompte: 0, lignes: [{ id: 1, reference: 'PA001', description: 'Panneau acrylique 100 x 150', prixHT: 8.0, quantite: 9, tauxTVA: 0 }, { id: 2, reference: 'PA002', description: 'Panneau acrylique 150 x 200', prixHT: 10.0, quantite: 10, tauxTVA: 0 }, { id: 3, reference: 'PA005', description: 'Panneau acrylique 200 x 300', prixHT: 22.0, quantite: 3, tauxTVA: 0 }], totalHT: 237.94, totalTTC: 237.94 },
        { numero: 'F00021', clientId: 'C00019', date: '2025-05-20', dateEcheance: '2025-06-19', modeReglement: 'esp√®ces', remise: 0, acompte: 0, lignes: [{ id: 1, reference: 'T007', description: 'Tasse noir int blanc', prixHT: 0.0, quantite: 1, tauxTVA: 0 }], totalHT: 0.0, totalTTC: 0.0 },
        { numero: 'F00022', clientId: 'C00016', date: '2025-06-24', dateEcheance: '2025-07-24', modeReglement: '√† d√©finir', remise: 0, acompte: 0, lignes: [{ id: 1, reference: 'PA006', description: 'Panneau acrylique 100 x 200', prixHT: 8.5, quantite: 1, tauxTVA: 0 }], totalHT: 8.5, totalTTC: 8.5 },
        { numero: 'F00023', clientId: 'C00020', date: '2025-07-03', dateEcheance: '2025-08-02', modeReglement: '√† d√©finir', remise: 0, acompte: 0, lignes: [{ id: 1, reference: 'PA006', description: 'Panneau acrylique 100 x 200', prixHT: 8.5, quantite: 65, tauxTVA: 0 }], totalHT: 780.0, totalTTC: 780.0 },
        { numero: 'F00024', clientId: 'C00021', date: '2025-08-30', dateEcheance: '2025-09-29', modeReglement: 'esp√®ces', remise: 0, acompte: 0, lignes: [{ id: 1, reference: 'G010', description: 'Thermos Inox 750ML Gris+Gobelet', prixHT: 22.0, quantite: 1, tauxTVA: 0 }], totalHT: 25.0, totalTTC: 25.0 },
        { numero: 'F00025', clientId: 'C00022', date: '2026-01-20', dateEcheance: '2026-01-20', modeReglement: 'virement', remise: 0, acompte: 0, lignes: [{ id: 1, reference: 'PA009', description: 'Panneau en verre 127 x 178', prixHT: 15.0, quantite: 16, tauxTVA: 0 }], totalHT: 16.0, totalTTC: 16.0 },
        { numero: 'F00026', clientId: 'C00023', date: '2025-09-23', dateEcheance: '2025-10-23', modeReglement: 'esp√®ces', remise: 0, acompte: 0, lignes: [{ id: 1, reference: 'PA002', description: 'Panneau acrylique 150 x 200', prixHT: 10.0, quantite: 2, tauxTVA: 0 }], totalHT: 30.0, totalTTC: 30.0 },
        { numero: 'F00027', clientId: 'C00001', date: '2026-01-20', dateEcheance: '2026-01-20', modeReglement: 'esp√®ces', remise: 0, acompte: 0, lignes: [{ id: 1, reference: 'G006', description: 'Gourde sport Alu Blanc 500ML', prixHT: 13.0, quantite: 1, tauxTVA: 0 }, { id: 2, reference: 'G011', description: 'Thermos Inox 750ML Blanc+Gobelet', prixHT: 22.0, quantite: 1, tauxTVA: 0 }], totalHT: 30.0, totalTTC: 30.0 },
        { numero: 'F00028', clientId: 'C00025', date: '2025-11-11', dateEcheance: '2025-12-11', modeReglement: 'virement', remise: 0, acompte: 0, lignes: [{ id: 1, reference: 'DIV001', description: 'Bo√Æte avec lumi√®re √©toile', prixHT: 25.0, quantite: 1, tauxTVA: 0 }], totalHT: 25.0, totalTTC: 25.0 },
        { numero: 'F00029', clientId: 'C00026', date: '2025-11-30', dateEcheance: '2025-12-30', modeReglement: '√† d√©finir', remise: 0, acompte: 0, lignes: [{ id: 1, reference: 'DIV002', description: 'March√© de No√´l Novembre', prixHT: 0, quantite: 1, tauxTVA: 0 }], totalHT: 132.0, totalTTC: 132.0 },
        { numero: 'F00030', clientId: 'C00027', date: '2025-12-24', dateEcheance: '2026-01-24', modeReglement: '√† d√©finir', remise: 0, acompte: 0, lignes: [{ id: 1, reference: 'DIV003', description: 'March√© de No√´l D√©cembre', prixHT: 0, quantite: 1, tauxTVA: 0 }], totalHT: 638.9, totalTTC: 638.9 },
    ],
    devis: [],
    paiements: [],
    achats: [
        { id: 'A001', date: '2024-09-30', nature: 'fourniture', montant: 28.24, modeReglement: 'cb', fournisseur: 'action', justificatif: 'ticket caisse' },
        { id: 'A002', date: '2024-09-30', nature: 'encre', montant: 31.84, modeReglement: 'paypal', fournisseur: 'encreservice', justificatif: '*52514' },
        { id: 'A003', date: '2024-10-24', nature: 'fournitures', montant: 5.96, modeReglement: 'cb', fournisseur: 'centrakor', justificatif: 'ticket caisse' },
        { id: 'A004', date: '2024-10-24', nature: 'fournitures', montant: 17.76, modeReglement: 'cb', fournisseur: 'action', justificatif: 'ticket caisse' },
        { id: 'A005', date: '2024-10-30', nature: 'terminal paiement', montant: 98.98, modeReglement: 'paypal', fournisseur: 'boulanger', justificatif: 'facture F905' },
        { id: 'A006', date: '2024-11-04', nature: 'fournitures', montant: 16.94, modeReglement: 'cb', fournisseur: 'bureau vall√©e', justificatif: 'ticket de caisse' },
        { id: 'A007', date: '2024-11-04', nature: 'fournitures', montant: 155.45, modeReglement: 'paypal', fournisseur: 'print equipement', justificatif: 'facture' },
        { id: 'A008', date: '2024-11-05', nature: 'fournitures', montant: 183.79, modeReglement: 'paypal', fournisseur: 'printfabrik', justificatif: 'facture' },
        { id: 'A009', date: '2024-11-06', nature: 'tampon', montant: 50.6, modeReglement: 'paypal', fournisseur: 'le fabricant de tampon', justificatif: 'facture' },
        { id: 'A010', date: '2024-11-06', nature: 'fournitures', montant: 60.73, modeReglement: 'cb', fournisseur: 'action', justificatif: 'ticket de caisse' },
        { id: 'A011', date: '2024-11-11', nature: 'fournitures', montant: 68.16, modeReglement: 'paypal', fournisseur: 'printfabrik', justificatif: 'facture' },
        { id: 'A012', date: '2024-11-14', nature: 'fournitures', montant: 15.66, modeReglement: 'cb', fournisseur: 'bureau vall√©e', justificatif: 'facture' },
        { id: 'A013', date: '2024-11-24', nature: 'fournitures', montant: 28.32, modeReglement: 'paypal', fournisseur: 'printfabrik', justificatif: 'facture' },
        { id: 'A014', date: '2024-11-26', nature: 'fournitures', montant: 16.35, modeReglement: 'cb', fournisseur: 'brico march√©', justificatif: 'facture' },
        { id: 'A015', date: '2024-11-14', nature: 'fournitures', montant: 79.1, modeReglement: 'cb', fournisseur: 'crea mat sublimation', justificatif: 'facture' },
        { id: 'A016', date: '2024-12-08', nature: 'fourniture', montant: 105.89, modeReglement: 'cb', fournisseur: 'print fabrik', justificatif: 'facture' },
        { id: 'A017', date: '2024-12-08', nature: 'fourniture', montant: 80.76, modeReglement: 'cb', fournisseur: 'print fabrik', justificatif: 'facture' },
        { id: 'A018', date: '2024-12-01', nature: 'fourniture', montant: 46.26, modeReglement: 'paypal', fournisseur: 'print fabrik', justificatif: 'facture' },
        { id: 'A019', date: '2025-01-14', nature: 'fournitures', montant: 114.04, modeReglement: 'paypal', fournisseur: 'print fabrik', justificatif: 'facture' },
        { id: 'A020', date: '2025-02-06', nature: 'fournitures', montant: 57.83, modeReglement: 'paypal', fournisseur: 'print fabrik', justificatif: 'facture' },
        { id: 'A021', date: '2025-02-09', nature: 'fournitures', montant: 8.16, modeReglement: 'paypal', fournisseur: 'print fabrik', justificatif: 'facture' },
        { id: 'A022', date: '2025-03-13', nature: 'produit', montant: 106.84, modeReglement: 'paypal', fournisseur: 'printfabrik', justificatif: 'facture' },
        { id: 'A023', date: '2025-03-18', nature: 'produit', montant: 5.32, modeReglement: 'cb', fournisseur: 'printfabrik', justificatif: 'facture' },
        { id: 'A024', date: '2025-04-05', nature: 'produit', montant: 94.22, modeReglement: 'cb', fournisseur: 'printfabrik', justificatif: 'facture' },
        { id: 'A025', date: '2025-04-09', nature: 'produit', montant: 16.6, modeReglement: 'cb', fournisseur: 'printfabrik', justificatif: 'facture' },
        { id: 'A026', date: '2025-04-15', nature: 'produit', montant: 128.28, modeReglement: 'cb', fournisseur: 'printfabrik', justificatif: 'facture' },
        { id: 'A027', date: '2025-05-07', nature: 'fournitures', montant: 115.69, modeReglement: 'cb', fournisseur: 'printfabrik', justificatif: 'facture' },
        { id: 'A028', date: '2025-05-27', nature: 'fournitures', montant: 60.35, modeReglement: 'cb', fournisseur: 'printfabrik', justificatif: 'facture' },
        { id: 'A029', date: '2025-06-08', nature: 'fourniture', montant: 53.09, modeReglement: 'paypal', fournisseur: 'printfabrik', justificatif: 'facture' },
        { id: 'A030', date: '2025-08-11', nature: 'fourniture', montant: 9.72, modeReglement: 'cb', fournisseur: 'printfabrik', justificatif: 'facture' },
        { id: 'A031', date: '2025-08-11', nature: 'fourniture', montant: 306.89, modeReglement: 'cb', fournisseur: 'printfabrik', justificatif: 'facture' },
        { id: 'A032', date: '2025-08-13', nature: 'machine', montant: 433.15, modeReglement: 'cb', fournisseur: 'vevor', justificatif: 'facture' },
        { id: 'A033', date: '2025-08-16', nature: 'machine', montant: 122.4, modeReglement: 'cb', fournisseur: 'vevor', justificatif: 'facture' },
        { id: 'A034', date: '2025-08-26', nature: 'fourniture', montant: 251.9, modeReglement: 'paypal', fournisseur: 'printfabrik', justificatif: 'facture' },
        { id: 'A035', date: '2025-08-26', nature: 'fourniture', montant: 110.25, modeReglement: 'cb', fournisseur: 'wordans', justificatif: 'facture' },
        { id: 'A036', date: '2025-08-27', nature: 'fourniture', montant: 71.38, modeReglement: 'cb', fournisseur: 'vistaprint', justificatif: 'facture' },
        { id: 'A037', date: '2025-10-22', nature: 'fourniture', montant: 99.89, modeReglement: 'cb', fournisseur: 'printfabrik', justificatif: 'facture' },
        { id: 'A038', date: '2025-10-11', nature: 'bois', montant: 55.9, modeReglement: 'cb', fournisseur: 'woodwork', justificatif: 'facture' },
        { id: 'A039', date: '2025-10-19', nature: 'bois', montant: 219.0, modeReglement: 'cb', fournisseur: 'woodwork', justificatif: 'facture' },
        { id: 'A040', date: '2025-11-02', nature: 'fourniture', montant: 65.64, modeReglement: 'cb', fournisseur: 'printfabrik', justificatif: 'cb' },
        { id: 'A041', date: '2025-11-14', nature: 'fourniture', montant: 114.0, modeReglement: 'cb', fournisseur: 'printfabrik', justificatif: 'cb' },
        { id: 'A042', date: '2025-12-07', nature: 'bois', montant: 109.0, modeReglement: 'cb', fournisseur: 'woodwork', justificatif: 'facture' },
        { id: 'A043', date: '2025-12-22', nature: 'fourniture', montant: 62.24, modeReglement: 'cb', fournisseur: 'action', justificatif: 'ticket' },
        { id: 'A044', date: '2025-12-22', nature: 'fourniture', montant: 15.4, modeReglement: 'cb', fournisseur: 'bureau vall√©e', justificatif: 'facture' },
        { id: 'A045', date: '2026-01-06', nature: 'fourniture', montant: 304.73, modeReglement: 'paypal', fournisseur: 'printfabrik', justificatif: 'facture' },
        { id: 'A046', date: '2026-01-09', nature: 'fourniture', montant: 40.32, modeReglement: 'paypal', fournisseur: 'printfabrik', justificatif: 'facture' },
        { id: 'A047', date: '2026-01-11', nature: 'fourniture', montant: 16.0, modeReglement: 'cb', fournisseur: 'la fabrik du tampon', justificatif: 'facture' }
    ],
    relances: [], // Historique des relances envoy√©es
    referencesMigrated: true // Flag pour migration des r√©f√©rences
};

// ============================================
// VARIABLES GLOBALES
// ============================================
let data = {};
let currentTab = 'dashboard';
let currentFacture = null;
let caYear = new Date().getFullYear();
let isAdminMode = false;

// ============================================
// FONCTIONS UTILITAIRES
// ============================================
let firebaseReady = false;

function loadData() {
    // Charger d'abord depuis localStorage (fallback imm√©diat)
    const saved = localStorage.getItem('facturier_stylemoi_v3');
    if (saved) {
        try {
            data = JSON.parse(saved);
            applyDataMigrations();
        } catch (e) {
            data = JSON.parse(JSON.stringify(defaultData));
        }
    } else {
        data = JSON.parse(JSON.stringify(defaultData));
    }
    
    // Activer le listener Firebase temps r√©el
    if (dbRef) {
        dbRef.on('value', (snapshot) => {
            const firebaseData = snapshot.val();
            if (firebaseData) {
                data = firebaseData;
                applyDataMigrations();
                localStorage.setItem('facturier_stylemoi_v3', JSON.stringify(data));
                if (firebaseReady) {
                    // Rafra√Æchir l'affichage si changement externe
                    renderPage();
                    updateSidebarLogo();
                }
                console.log('üîÑ Donn√©es synchronis√©es depuis Firebase');
            } else if (!firebaseReady) {
                // Premier chargement, Firebase vide -> envoyer les donn√©es locales
                if (data.factures && data.factures.length > 0) {
                    dbRef.set(data);
                    console.log('üì§ Donn√©es locales envoy√©es vers Firebase');
                }
            }
            firebaseReady = true;
        }, (error) => {
            console.error('‚ùå Erreur Firebase:', error);
            firebaseReady = true;
        });
    }
}

function applyDataMigrations() {
    // Migration des anciennes donn√©es
    if (!data.devis) data.devis = [];
    if (!data.tauxURSSAFParMois) data.tauxURSSAFParMois = { 'default': 23.20 };
    if (!data.relances) data.relances = [];
    if (!data.cgv) data.cgv = defaultData.cgv;
    if (!data.logo) data.logo = null;
    if (!data.version) data.version = '3.2.0';
    if (!data.adminPassword) data.adminPassword = 'admin123';
    if (!data.categories) data.categories = defaultData.categories;
    // Migration des produits sans cat√©gorie
    if (data.produits) {
        data.produits.forEach(p => {
            if (!p.categorie) {
                const desc = p.description.toLowerCase();
                if (desc.includes('tasse') || desc.includes('mug') || desc.includes('choppe') || desc.includes('bol')) {
                    p.categorie = 'tasses';
                } else if (desc.includes('gourde') || desc.includes('bouteille') || desc.includes('thermos') || desc.includes('cannette') || desc.includes('gobelet')) {
                    p.categorie = 'gourdes';
                } else if (desc.includes('verre cannette') || desc.includes('verre avec paille')) {
                    p.categorie = 'verres';
                } else if (desc.includes('ardoise')) {
                    p.categorie = 'ardoises';
                } else if (desc.includes('panneau') || desc.includes('plaque photo')) {
                    p.categorie = 'panneaux';
                } else if (desc.includes('planche') || desc.includes('gant') || desc.includes('manique') || desc.includes('carrelage')) {
                    p.categorie = 'cuisine';
                } else if (desc.includes('tablier')) {
                    p.categorie = 'tabliers';
                } else if (desc.includes('bo√Æte') || desc.includes('boite')) {
                    p.categorie = 'boites';
                } else if (desc.includes('coussin') || desc.includes('bouillotte')) {
                    p.categorie = 'coussins';
                } else if (desc.includes('tshirt') || desc.includes('t-shirt')) {
                    p.categorie = 'tshirts';
                } else if (desc.includes('body') || desc.includes('bavoir') || desc.includes('doudou')) {
                    p.categorie = 'bebe';
                } else if (desc.includes('serviette')) {
                    p.categorie = 'serviettes';
                } else {
                    p.categorie = 'accessoires';
                }
            }
        });
    }
    // Migration des r√©f√©rences produits par cat√©gorie (une seule fois)
    if (!data.referencesMigrated) {
        migrateProductReferences();
        data.referencesMigrated = true;
    }
}

function saveData() {
    localStorage.setItem('facturier_stylemoi_v3', JSON.stringify(data));
    // Sync Firebase Realtime Database
    if (dbRef) {
        dbRef.set(data).catch(e => console.error('‚ùå Erreur sync Firebase:', e));
    }
}

function migrateProductReferences() {
    // Table de correspondance cat√©gorie -> pr√©fixe
    const prefixes = {
        'tasses': 'T',
        'gourdes': 'G',
        'verres': 'V',
        'ardoises': 'A',
        'panneaux': 'PA',
        'cuisine': 'CU',
        'tabliers': 'TA',
        'boites': 'BO',
        'accessoires': 'AC',
        'coussins': 'CO',
        'tshirts': 'TS',
        'bebe': 'BE',
        'serviettes': 'SE',
        'divers': 'D'
    };
    
    // Compteurs par cat√©gorie
    const compteurs = {};
    Object.keys(prefixes).forEach(cat => compteurs[cat] = 0);
    
    // Mapping anciennes r√©f√©rences -> nouvelles
    const refMapping = {};
    
    // Renommer tous les produits
    data.produits.forEach(p => {
        const oldRef = p.reference;
        const catId = p.categorie || 'divers';
        const prefix = prefixes[catId] || 'X';
        
        compteurs[catId] = (compteurs[catId] || 0) + 1;
        const newRef = `${prefix}${String(compteurs[catId]).padStart(3, '0')}`;
        
        refMapping[oldRef] = newRef;
        p.reference = newRef;
    });
    
    // Mettre √† jour les factures
    if (data.factures) {
        data.factures.forEach(f => {
            if (f.lignes) {
                f.lignes.forEach(l => {
                    if (refMapping[l.reference]) {
                        l.reference = refMapping[l.reference];
                    }
                });
            }
        });
    }
    
    // Mettre √† jour les devis
    if (data.devis) {
        data.devis.forEach(d => {
            if (d.lignes) {
                d.lignes.forEach(l => {
                    if (refMapping[l.reference]) {
                        l.reference = refMapping[l.reference];
                    }
                });
            }
        });
    }
    
    console.log('Migration des r√©f√©rences effectu√©e:', refMapping);
}

function generateNumber(prefix, items) {
    const nums = items.map(i => parseInt(i.numero?.replace(prefix, '') || '0')).filter(n => !isNaN(n));
    const max = nums.length > 0 ? Math.max(...nums) : 0;
    return `${prefix}${String(max + 1).padStart(5, '0')}`;
}

function generateProductReference(categorieId) {
    // Table de correspondance cat√©gorie -> pr√©fixe
    const prefixes = {
        'tasses': 'T',
        'gourdes': 'G',
        'verres': 'V',
        'ardoises': 'A',
        'panneaux': 'PA',
        'cuisine': 'CU',
        'tabliers': 'TA',
        'boites': 'BO',
        'accessoires': 'AC',
        'coussins': 'CO',
        'tshirts': 'TS',
        'bebe': 'BE',
        'serviettes': 'SE',
        'divers': 'D'
    };
    
    const prefixe = prefixes[categorieId] || 'X';
    
    // Trouver le num√©ro max pour cette cat√©gorie
    const produitsCategorie = data.produits.filter(p => p.categorie === categorieId);
    const regex = new RegExp(`^${prefixe}(\\d+)$`);
    const nums = produitsCategorie
        .map(p => {
            const match = p.reference.match(regex);
            return match ? parseInt(match[1]) : 0;
        })
        .filter(n => !isNaN(n));
    
    const max = nums.length > 0 ? Math.max(...nums) : 0;
    return `${prefixe}${String(max + 1).padStart(3, '0')}`;
}

function formatDate(dateStr) {
    if (!dateStr) return '-';
    return new Date(dateStr).toLocaleDateString('fr-FR');
}

function formatMoney(amount) {
    return (amount || 0).toFixed(2) + ' ‚Ç¨';
}

function formatCGVForPrint(cgvText) {
    if (!cgvText) return '';
    // S√©parer par les titres d'articles (Article X :)
    let formatted = cgvText.trim();
    // Mettre les titres d'articles en gras avec espacement
    formatted = formatted.replace(/Article\s+(\d+)\s*[-‚Äì:]\s*([^\n]+)/gi, (match, num, title) => {
        return `</div><div class="article"><div class="article-title">Article ${num} - ${title.trim()}</div>`;
    });
    // Nettoyer le d√©but si commence par </div>
    if (formatted.startsWith('</div>')) {
        formatted = formatted.substring(6);
    }
    // Fermer le dernier article
    formatted += '</div>';
    // Remplacer les sauts de ligne par des espaces (sauf entre articles)
    formatted = formatted.replace(/\n(?!<)/g, ' ');
    // Nettoyer les espaces multiples
    formatted = formatted.replace(/\s+/g, ' ');
    return formatted;
}

function getClientName(facture) {
    if (facture.paiementComptoir) return 'üõí Paiement comptoir';
    const client = getClient(facture.clientId);
    return client?.nom || '-';
}

function getClient(id) {
    return data.clients.find(c => c.numero === id);
}

function getTauxURSSAF(yearMonth) {
    return data.tauxURSSAFParMois[yearMonth] !== undefined 
        ? data.tauxURSSAFParMois[yearMonth] 
        : (data.tauxURSSAFParMois['default'] || 23.20);
}

function setTauxURSSAF(yearMonth, taux) {
    data.tauxURSSAFParMois[yearMonth] = taux;
    saveData();
}

// ============================================
// NAVIGATION
// ============================================
const menuItems = [
    { id: 'dashboard', icon: 'üìä', label: 'Tableau de bord' },
    { id: 'clients', icon: 'üë•', label: 'Clients' },
    { id: 'produits', icon: 'üì¶', label: 'Produits' },
    { id: 'stock', icon: 'üìã', label: 'Gestion Stock' },
    { id: 'devis', icon: 'üìù', label: 'Devis' },
    { id: 'factures', icon: 'üßæ', label: 'Factures' },
    { id: 'paiements', icon: 'üí≥', label: 'Suivi paiements' },
    { id: 'relances', icon: 'üì¨', label: 'Lettres de relance' },
    { id: 'ca', icon: 'üí∞', label: "Chiffre d'affaires" },
    { id: 'achats', icon: 'üõí', label: "Registre d'achats" },
    { id: 'settings', icon: '‚öôÔ∏è', label: 'Param√®tres' },
    { id: 'logout', icon: 'üö™', label: 'D√©connexion' },
];

function renderNav() {
    const nav = document.getElementById('nav-menu');
    nav.innerHTML = menuItems.map(item => `
        <button onclick="navigateTo('${item.id}')" 
            class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all ${currentTab === item.id ? 'active text-white shadow-lg' : 'text-stone-300 hover:bg-stone-700/50'}">
            <span class="text-xl">${item.icon}</span>
            <span class="font-medium">${item.label}</span>
        </button>
    `).join('');
    
    // Mise √† jour du logo dans la sidebar
    updateSidebarLogo();
}

function updateSidebarLogo() {
    const logoContainer = document.getElementById('sidebar-logo');
    if (data.logo) {
        logoContainer.innerHTML = `<img src="${data.logo}" alt="Logo" class="max-h-16">`;
    } else {
        logoContainer.innerHTML = `<h1 class="text-2xl font-bold bg-gradient-to-r from-amber-400 to-orange-400 bg-clip-text text-transparent">${data.entreprise.nom}</h1>`;
    }
    document.getElementById('version-display').textContent = 'v' + data.version;
}

function navigateTo(tab) {
    if (tab === 'logout') {
        logout();
        return;
    }
    if (tab === 'settings') {
        // Demander le mot de passe admin pour acc√©der aux param√®tres
        askAdminPassword(() => {
            currentTab = tab;
            renderNav();
            renderPage();
        });
    } else {
        currentTab = tab;
        renderNav();
        renderPage();
    }
}

function askAdminPassword(callback) {
    const content = `
        <div class="space-y-4">
            <p class="text-stone-600">üîê Cette section est prot√©g√©e. Entrez le mot de passe support.</p>
            <div>
                <label class="block text-sm font-medium text-stone-600 mb-1">Mot de passe support</label>
                <input type="password" id="admin-access-password" class="w-full px-4 py-2.5 border border-stone-300 rounded-xl" placeholder="Mot de passe..." onkeypress="if(event.key==='Enter')checkAdminAccess()">
            </div>
        </div>
        <div class="flex justify-end gap-3 mt-6">
            <button onclick="closeModal()" class="px-4 py-2.5 bg-stone-100 text-stone-700 rounded-xl font-medium">Annuler</button>
            <button onclick="checkAdminAccess()" class="btn-primary text-white px-4 py-2.5 rounded-xl font-medium">Acc√©der</button>
        </div>
    `;
    window.adminCallback = callback;
    showModal('üîí Acc√®s Param√®tres', content, 'max-w-md');
    setTimeout(() => document.getElementById('admin-access-password')?.focus(), 100);
}

function checkAdminAccess() {
    const password = document.getElementById('admin-access-password').value;
    // Mot de passe fixe pour acc√®s aux param√®tres (diff√©rent du mot de passe de connexion)
    if (password === 'Support149fj') {
        closeModal();
        if (window.adminCallback) {
            window.adminCallback();
            window.adminCallback = null;
        }
    } else {
        alert('‚ùå Mot de passe incorrect !');
    }
}

// ============================================
// MODAL
// ============================================
function showModal(title, content, size = 'max-w-4xl') {
    const container = document.getElementById('modal-container');
    const modalContent = document.getElementById('modal-content');
    modalContent.className = `bg-white rounded-2xl shadow-2xl w-full ${size} max-h-[90vh] overflow-hidden`;
    modalContent.innerHTML = `
        <div class="flex items-center justify-between px-6 py-4 border-b border-stone-200 bg-gradient-to-r from-amber-50 to-orange-50">
            <h2 class="text-xl font-semibold text-stone-800">${title}</h2>
            <button onclick="closeModal()" class="p-2 hover:bg-stone-200 rounded-full transition-colors text-xl">‚úï</button>
        </div>
        <div class="p-6 overflow-y-auto max-h-[calc(90vh-80px)]">${content}</div>
    `;
    container.classList.remove('hidden');
}

function closeModal() {
    document.getElementById('modal-container').classList.add('hidden');
}

// ============================================
// DASHBOARD
// ============================================
function renderDashboard() {
    const today = new Date();
    const thisMonth = data.factures.filter(f => {
        const d = new Date(f.date);
        return d.getMonth() === today.getMonth() && d.getFullYear() === today.getFullYear();
    });
    const caThisMonth = thisMonth.reduce((sum, f) => sum + (f.totalHT || 0), 0);
    const facturesNonPayees = data.factures.filter(f => !data.paiements?.find(p => p.numero === f.numero)?.paye);
    const totalImpaye = facturesNonPayees.reduce((sum, f) => sum + (f.totalTTC || 0), 0);
    
    // Factures en retard (√©ch√©ance d√©pass√©e)
    const facturesEnRetard = facturesNonPayees.filter(f => new Date(f.dateEcheance) < today);

    return `
        <div class="space-y-6">
            <div>
                <h2 class="text-2xl font-bold text-stone-800">Bonjour ! üëã</h2>
                <p class="text-stone-500">${today.toLocaleDateString('fr-FR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
            </div>
            <div class="grid grid-cols-4 gap-4">
                <div class="bg-gradient-to-br from-amber-500 to-orange-500 text-white rounded-2xl p-6 shadow-lg">
                    <div class="flex items-center gap-3 mb-2"><span class="text-3xl">üí∞</span><span class="text-amber-100">CA ce mois</span></div>
                    <p class="text-3xl font-bold">${formatMoney(caThisMonth)}</p>
                    <p class="text-amber-100 text-sm mt-1">${thisMonth.length} facture(s)</p>
                </div>
                <div class="bg-white rounded-2xl p-6 border border-stone-200 shadow-sm">
                    <div class="flex items-center gap-3 mb-2"><span class="text-3xl">üßæ</span><span class="text-stone-500">Factures</span></div>
                    <p class="text-3xl font-bold text-stone-800">${data.factures.length}</p>
                    <p class="text-stone-500 text-sm mt-1">Total cr√©√©es</p>
                </div>
                <div class="bg-white rounded-2xl p-6 border border-stone-200 shadow-sm">
                    <div class="flex items-center gap-3 mb-2"><span class="text-3xl">üë•</span><span class="text-stone-500">Clients</span></div>
                    <p class="text-3xl font-bold text-stone-800">${data.clients.length}</p>
                    <p class="text-stone-500 text-sm mt-1">Enregistr√©s</p>
                </div>
                <div class="${totalImpaye > 0 ? 'bg-red-50 border-red-200' : 'bg-emerald-50 border-emerald-200'} rounded-2xl p-6 border shadow-sm">
                    <div class="flex items-center gap-3 mb-2"><span class="text-3xl">‚ö†Ô∏è</span><span class="${totalImpaye > 0 ? 'text-red-600' : 'text-emerald-600'}">√Ä encaisser</span></div>
                    <p class="text-3xl font-bold ${totalImpaye > 0 ? 'text-red-700' : 'text-emerald-700'}">${formatMoney(totalImpaye)}</p>
                    <p class="text-sm mt-1 ${totalImpaye > 0 ? 'text-red-500' : 'text-emerald-500'}">${facturesNonPayees.length} facture(s)</p>
                </div>
            </div>
            
            ${facturesEnRetard.length > 0 ? `
            <div class="bg-red-50 border border-red-200 rounded-xl p-4">
                <h3 class="font-semibold text-red-800 mb-2">‚ö†Ô∏è ${facturesEnRetard.length} facture(s) en retard de paiement</h3>
                <div class="space-y-2">
                    ${facturesEnRetard.slice(0, 3).map(f => `
                        <div class="flex justify-between items-center bg-white rounded-lg p-3">
                            <div>
                                <span class="font-medium">${f.numero}</span> - ${getClientName(f)}
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="text-red-600 font-medium">${formatMoney(f.totalTTC)}</span>
                                <button onclick="navigateTo('relances')" class="text-sm bg-red-500 text-white px-3 py-1 rounded-lg">Relancer</button>
                            </div>
                        </div>
                    `).join('')}
                </div>
                ${facturesEnRetard.length > 3 ? `<p class="text-sm text-red-600 mt-2">Et ${facturesEnRetard.length - 3} autre(s)...</p>` : ''}
            </div>
            ` : ''}
            
            <div class="grid grid-cols-2 gap-6">
                <div class="bg-white rounded-2xl p-6 border border-stone-200 shadow-sm">
                    <h3 class="font-semibold text-stone-800 mb-4">Derni√®res factures</h3>
                    <div class="space-y-3">
                        ${data.factures.slice(-5).reverse().map(f => `
                            <div class="flex items-center justify-between py-2 border-b border-stone-100 last:border-0">
                                <div><p class="font-medium">${f.numero}</p><p class="text-sm text-stone-500">${getClientName(f)}</p></div>
                                <div class="text-right"><p class="font-medium">${formatMoney(f.totalTTC)}</p><p class="text-sm text-stone-500">${formatDate(f.date)}</p></div>
                            </div>
                        `).join('') || '<p class="text-stone-400 text-center py-4">Aucune facture</p>'}
                    </div>
                </div>
                <div class="bg-white rounded-2xl p-6 border border-stone-200 shadow-sm">
                    <h3 class="font-semibold text-stone-800 mb-4">Produits populaires</h3>
                    <div class="space-y-3">
                        ${data.produits.filter(p => p.prixHT > 0).slice(0, 6).map(p => `
                            <div class="flex items-center justify-between py-2 border-b border-stone-100 last:border-0">
                                <div><p class="font-medium">${p.description}</p><p class="text-sm text-stone-500">${p.reference}</p></div>
                                <p class="font-medium text-amber-600">${formatMoney(p.prixHT)}</p>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
        </div>
    `;
}

// ============================================
// CLIENTS
// ============================================
let clientSearch = '';

function renderClients() {
    const filtered = data.clients.filter(c => 
        c.nom.toLowerCase().includes(clientSearch.toLowerCase()) || 
        c.numero.toLowerCase().includes(clientSearch.toLowerCase())
    );

    return `
        <div class="space-y-6">
            <div class="flex items-center justify-between">
                <h2 class="text-2xl font-bold text-stone-800">Base Clients (${data.clients.length})</h2>
                <button onclick="openClientModal()" class="btn-primary text-white px-4 py-2.5 rounded-xl font-medium flex items-center gap-2">
                    <span>+</span> Nouveau client
                </button>
            </div>
            <div class="relative">
                <span class="absolute left-4 top-1/2 -translate-y-1/2 text-stone-400">üîç</span>
                <input type="text" placeholder="Rechercher un client..." value="${clientSearch}" 
                    oninput="clientSearch = this.value; renderPage()"
                    class="w-full pl-12 pr-4 py-3 border border-stone-300 rounded-xl focus:ring-2 focus:ring-amber-400 focus:outline-none">
            </div>
            <div class="bg-white rounded-2xl shadow-lg overflow-hidden border border-stone-200">
                <table class="w-full">
                    <thead class="bg-gradient-to-r from-stone-100 to-stone-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-stone-600">N¬∞ Client</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-stone-600">Type</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-stone-600">Nom</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-stone-600">Ville</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-stone-600">Email</th>
                            <th class="px-4 py-3 text-right text-sm font-semibold text-stone-600">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-stone-100">
                        ${filtered.map(c => `
                            <tr class="hover:bg-amber-50/50 transition-colors">
                                <td class="px-4 py-3 text-sm">${c.numero}</td>
                                <td class="px-4 py-3"><span class="px-2 py-1 rounded-full text-xs font-medium ${c.type === 'Professionnel' ? 'bg-blue-100 text-blue-700' : 'bg-green-100 text-green-700'}">${c.type}</span></td>
                                <td class="px-4 py-3 text-sm font-medium">${c.nom}</td>
                                <td class="px-4 py-3 text-sm">${c.ville || '-'}</td>
                                <td class="px-4 py-3 text-sm">${c.email || '-'}</td>
                                <td class="px-4 py-3 text-right">
                                    <button onclick="openClientModal('${c.numero}')" class="p-1.5 text-amber-500 hover:bg-amber-50 rounded-lg" title="Modifier">‚úèÔ∏è</button>
                                    <button onclick="deleteClient('${c.numero}')" class="p-1.5 text-red-500 hover:bg-red-50 rounded-lg" title="Supprimer">üóëÔ∏è</button>
                                </td>
                            </tr>
                        `).join('') || '<tr><td colspan="6" class="px-4 py-8 text-center text-stone-400">Aucun client</td></tr>'}
                    </tbody>
                </table>
            </div>
        </div>
    `;
}

function openClientModal(numero = null) {
    const client = numero ? data.clients.find(c => c.numero === numero) : {
        numero: generateNumber('C', data.clients),
        type: 'Particulier', nom: '', adresse: '', codePostal: '', ville: '',
        telephone: '', portable: '', email: ''
    };
    const isEdit = !!numero;

    const content = `
        <div class="grid grid-cols-2 gap-4">
            <div><label class="block text-sm font-medium text-stone-600 mb-1">N¬∞ Client</label>
                <input type="text" id="client-numero" value="${client.numero}" disabled class="w-full px-4 py-2.5 border border-stone-300 rounded-xl bg-stone-100"></div>
            <div><label class="block text-sm font-medium text-stone-600 mb-1">Type</label>
                <select id="client-type" class="w-full px-4 py-2.5 border border-stone-300 rounded-xl">
                    <option value="Particulier" ${client.type === 'Particulier' ? 'selected' : ''}>Particulier</option>
                    <option value="Professionnel" ${client.type === 'Professionnel' ? 'selected' : ''}>Professionnel</option>
                </select></div>
            <div class="col-span-2"><label class="block text-sm font-medium text-stone-600 mb-1">Nom / Raison sociale</label>
                <input type="text" id="client-nom" value="${client.nom}" class="w-full px-4 py-2.5 border border-stone-300 rounded-xl"></div>
            <div class="col-span-2"><label class="block text-sm font-medium text-stone-600 mb-1">Adresse</label>
                <input type="text" id="client-adresse" value="${client.adresse || ''}" class="w-full px-4 py-2.5 border border-stone-300 rounded-xl"></div>
            <div><label class="block text-sm font-medium text-stone-600 mb-1">Code postal</label>
                <input type="text" id="client-cp" value="${client.codePostal || ''}" class="w-full px-4 py-2.5 border border-stone-300 rounded-xl"></div>
            <div><label class="block text-sm font-medium text-stone-600 mb-1">Ville</label>
                <input type="text" id="client-ville" value="${client.ville || ''}" class="w-full px-4 py-2.5 border border-stone-300 rounded-xl"></div>
            <div><label class="block text-sm font-medium text-stone-600 mb-1">T√©l√©phone</label>
                <input type="text" id="client-tel" value="${client.telephone || ''}" class="w-full px-4 py-2.5 border border-stone-300 rounded-xl"></div>
            <div><label class="block text-sm font-medium text-stone-600 mb-1">Portable</label>
                <input type="text" id="client-portable" value="${client.portable || ''}" class="w-full px-4 py-2.5 border border-stone-300 rounded-xl"></div>
            <div class="col-span-2"><label class="block text-sm font-medium text-stone-600 mb-1">Email</label>
                <input type="email" id="client-email" value="${client.email || ''}" class="w-full px-4 py-2.5 border border-stone-300 rounded-xl"></div>
        </div>
        <div class="flex justify-end gap-3 mt-6">
            <button onclick="closeModal()" class="px-4 py-2.5 bg-stone-100 text-stone-700 rounded-xl font-medium">Annuler</button>
            <button onclick="saveClient('${numero || ''}')" class="btn-primary text-white px-4 py-2.5 rounded-xl font-medium">${isEdit ? 'Enregistrer' : 'Cr√©er'}</button>
        </div>
    `;
    showModal(isEdit ? 'Modifier client' : 'Nouveau client', content, 'max-w-2xl');
}

function saveClient(oldNumero) {
    const client = {
        numero: document.getElementById('client-numero').value,
        type: document.getElementById('client-type').value,
        nom: document.getElementById('client-nom').value,
        adresse: document.getElementById('client-adresse').value,
        codePostal: document.getElementById('client-cp').value,
        ville: document.getElementById('client-ville').value,
        telephone: document.getElementById('client-tel').value,
        portable: document.getElementById('client-portable').value,
        email: document.getElementById('client-email').value
    };

    if (oldNumero) {
        const idx = data.clients.findIndex(c => c.numero === oldNumero);
        if (idx !== -1) data.clients[idx] = client;
    } else {
        data.clients.push(client);
    }

    saveData();
    closeModal();
    renderPage();
}

function deleteClient(numero) {
    if (confirm('Supprimer ce client ?')) {
        data.clients = data.clients.filter(c => c.numero !== numero);
        saveData();
        renderPage();
    }
}

// ============================================
// PRODUITS
// ============================================
let produitSearch = '';
let selectedCategorie = null; // null = toutes les cat√©gories

function renderProduits() {
    // Filtrer par cat√©gorie et recherche
    let filtered = data.produits;
    if (selectedCategorie) {
        filtered = filtered.filter(p => p.categorie === selectedCategorie);
    }
    if (produitSearch) {
        filtered = filtered.filter(p => 
            p.description.toLowerCase().includes(produitSearch.toLowerCase()) || 
            p.reference.toLowerCase().includes(produitSearch.toLowerCase())
        );
    }

    // Grouper par cat√©gorie pour l'affichage
    const produitsParCategorie = {};
    data.categories.forEach(cat => {
        produitsParCategorie[cat.id] = filtered.filter(p => p.categorie === cat.id);
    });
    // Produits sans cat√©gorie
    const sansCat = filtered.filter(p => !p.categorie || !data.categories.find(c => c.id === p.categorie));
    if (sansCat.length > 0) {
        produitsParCategorie['_autres'] = sansCat;
    }

    return `
        <div class="space-y-6">
            <div class="flex items-center justify-between">
                <h2 class="text-2xl font-bold text-stone-800">Base Produits (${data.produits.length})</h2>
                <div class="flex gap-2">
                    <button onclick="openCategorieModal()" class="px-4 py-2.5 bg-stone-100 text-stone-700 rounded-xl font-medium hover:bg-stone-200 flex items-center gap-2">
                        <span>üìÅ</span> G√©rer cat√©gories
                    </button>
                    <button onclick="openProduitModal()" class="btn-primary text-white px-4 py-2.5 rounded-xl font-medium flex items-center gap-2">
                        <span>+</span> Nouveau produit
                    </button>
                </div>
            </div>

            <!-- Filtres par cat√©gorie -->
            <div class="flex flex-wrap gap-2">
                <button onclick="selectedCategorie = null; renderPage()" 
                    class="px-4 py-2 rounded-xl font-medium transition-all ${!selectedCategorie ? 'bg-gradient-to-r from-amber-500 to-orange-500 text-white shadow-lg' : 'bg-white text-stone-600 border border-stone-200 hover:bg-stone-50'}">
                    Tous (${data.produits.length})
                </button>
                ${data.categories.map(cat => {
                    const count = data.produits.filter(p => p.categorie === cat.id).length;
                    return `
                        <button onclick="selectedCategorie = '${cat.id}'; renderPage()" 
                            class="px-4 py-2 rounded-xl font-medium transition-all flex items-center gap-2 ${selectedCategorie === cat.id ? 'bg-gradient-to-r from-amber-500 to-orange-500 text-white shadow-lg' : 'bg-white text-stone-600 border border-stone-200 hover:bg-stone-50'}">
                            <span>${cat.icon}</span> ${cat.nom} (${count})
                        </button>
                    `;
                }).join('')}
            </div>

            <!-- Barre de recherche -->
            <div class="relative">
                <span class="absolute left-4 top-1/2 -translate-y-1/2 text-stone-400">üîç</span>
                <input type="text" placeholder="Rechercher un produit..." value="${produitSearch}" 
                    oninput="produitSearch = this.value; renderPage()"
                    class="w-full pl-12 pr-4 py-3 border border-stone-300 rounded-xl focus:ring-2 focus:ring-amber-400 focus:outline-none">
            </div>

            <!-- Affichage par cat√©gorie ou liste simple -->
            ${selectedCategorie ? renderProduitsTable(filtered) : renderProduitsParCategorie(produitsParCategorie)}
        </div>
    `;
}

function renderProduitsTable(produits) {
    return `
        <div class="bg-white rounded-2xl shadow-lg overflow-hidden border border-stone-200">
            <table class="w-full">
                <thead class="bg-gradient-to-r from-stone-100 to-stone-50">
                    <tr>
                        <th class="px-4 py-3 text-left text-sm font-semibold text-stone-600">R√©f.</th>
                        <th class="px-4 py-3 text-left text-sm font-semibold text-stone-600">Description</th>
                        <th class="px-4 py-3 text-right text-sm font-semibold text-stone-600">Prix HT</th>
                        <th class="px-4 py-3 text-right text-sm font-semibold text-stone-600">Co√ªt</th>
                        <th class="px-4 py-3 text-right text-sm font-semibold text-stone-600">Marge</th>
                        <th class="px-4 py-3 text-right text-sm font-semibold text-stone-600">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-stone-100">
                    ${produits.map(p => `
                        <tr class="hover:bg-amber-50/50 transition-colors">
                            <td class="px-4 py-3 text-sm">${p.reference}</td>
                            <td class="px-4 py-3 text-sm font-medium">${p.description}</td>
                            <td class="px-4 py-3 text-sm text-right">${formatMoney(p.prixHT)}</td>
                            <td class="px-4 py-3 text-sm text-right">${formatMoney(p.coutAchat)}</td>
                            <td class="px-4 py-3 text-sm text-right ${p.marge > 0 ? 'text-emerald-600 font-medium' : 'text-stone-400'}">${(p.marge || 0).toFixed(2)}</td>
                            <td class="px-4 py-3 text-right">
                                <button onclick="openProduitModal('${p.reference}')" class="p-1.5 text-amber-500 hover:bg-amber-50 rounded-lg">‚úèÔ∏è</button>
                                <button onclick="deleteProduit('${p.reference}')" class="p-1.5 text-red-500 hover:bg-red-50 rounded-lg">üóëÔ∏è</button>
                            </td>
                        </tr>
                    `).join('') || '<tr><td colspan="6" class="px-4 py-8 text-center text-stone-400">Aucun produit</td></tr>'}
                </tbody>
            </table>
        </div>
    `;
}

function renderProduitsParCategorie(produitsParCategorie) {
    return `
        <div class="space-y-6">
            ${data.categories.map(cat => {
                const produits = produitsParCategorie[cat.id] || [];
                if (produits.length === 0) return '';
                return `
                    <div class="bg-white rounded-2xl shadow-lg overflow-hidden border border-stone-200">
                        <div class="bg-gradient-to-r from-amber-50 to-orange-50 px-4 py-3 border-b border-stone-200 flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <span class="text-2xl">${cat.icon}</span>
                                <h3 class="font-semibold text-stone-800">${cat.nom}</h3>
                                <span class="bg-amber-100 text-amber-700 text-sm px-2 py-0.5 rounded-full">${produits.length}</span>
                            </div>
                            <button onclick="selectedCategorie = '${cat.id}'; renderPage()" class="text-sm text-amber-600 hover:text-amber-700 font-medium">
                                Voir tout ‚Üí
                            </button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 p-4">
                            ${produits.slice(0, 6).map(p => `
                                <div class="bg-stone-50 rounded-xl p-3 hover:bg-amber-50/50 transition-colors cursor-pointer group" onclick="openProduitModal('${p.reference}')">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <p class="text-xs text-stone-400">${p.reference}</p>
                                            <p class="font-medium text-stone-800">${p.description}</p>
                                        </div>
                                        <p class="text-lg font-bold text-amber-600">${formatMoney(p.prixHT)}</p>
                                    </div>
                                    <div class="flex justify-between items-center mt-2 text-xs text-stone-500">
                                        <span>Co√ªt: ${formatMoney(p.coutAchat)}</span>
                                        <span class="${p.marge > 0 ? 'text-emerald-600' : ''}">Marge: ${(p.marge || 0).toFixed(2)}</span>
                                    </div>
                                    <div class="absolute right-2 top-2 opacity-0 group-hover:opacity-100 transition-opacity flex gap-1">
                                        <button onclick="event.stopPropagation(); deleteProduit('${p.reference}')" class="p-1 text-red-500 hover:bg-red-100 rounded">üóëÔ∏è</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        ${produits.length > 6 ? `<div class="px-4 pb-3 text-center"><button onclick="selectedCategorie = '${cat.id}'; renderPage()" class="text-amber-600 text-sm hover:underline">+ ${produits.length - 6} autres produits</button></div>` : ''}
                    </div>
                `;
            }).join('')}
            ${produitsParCategorie['_autres']?.length > 0 ? `
                <div class="bg-white rounded-2xl shadow-lg overflow-hidden border border-stone-200">
                    <div class="bg-stone-100 px-4 py-3 border-b border-stone-200">
                        <h3 class="font-semibold text-stone-800">üì¶ Sans cat√©gorie (${produitsParCategorie['_autres'].length})</h3>
                    </div>
                    ${renderProduitsTable(produitsParCategorie['_autres'])}
                </div>
            ` : ''}
        </div>
    `;
}

function openProduitModal(reference = null) {
    const defaultCategorie = selectedCategorie || data.categories[0]?.id || 'divers';
    const produit = reference ? data.produits.find(p => p.reference === reference) : {
        reference: generateProductReference(defaultCategorie),
        description: '', prixHT: 0, tauxTVA: 0, coutAchat: 0, marge: 0, categorie: defaultCategorie
    };
    const isEdit = !!reference;

    const content = `
        <div class="space-y-4">
            <div class="grid grid-cols-2 gap-4">
                <div><label class="block text-sm font-medium text-stone-600 mb-1">Cat√©gorie</label>
                    <select id="produit-categorie" ${isEdit ? '' : 'onchange="updateProductReference()"'} class="w-full px-4 py-2.5 border border-stone-300 rounded-xl">
                        ${data.categories.map(c => `<option value="${c.id}" ${produit.categorie === c.id ? 'selected' : ''}>${c.icon} ${c.nom}</option>`).join('')}
                    </select></div>
                <div><label class="block text-sm font-medium text-stone-600 mb-1">R√©f√©rence</label>
                    <input type="text" id="produit-ref" value="${produit.reference}" ${isEdit ? 'disabled' : 'readonly'} class="w-full px-4 py-2.5 border border-stone-300 rounded-xl bg-stone-100 font-mono font-bold text-amber-600"></div>
            </div>
            <div><label class="block text-sm font-medium text-stone-600 mb-1">Description</label>
                <input type="text" id="produit-desc" value="${produit.description}" class="w-full px-4 py-2.5 border border-stone-300 rounded-xl"></div>
            <div class="grid grid-cols-2 gap-4">
                <div><label class="block text-sm font-medium text-stone-600 mb-1">Prix HT (‚Ç¨)</label>
                    <input type="number" step="0.01" id="produit-prix" value="${produit.prixHT}" class="w-full px-4 py-2.5 border border-stone-300 rounded-xl"></div>
                <div><label class="block text-sm font-medium text-stone-600 mb-1">Taux TVA (%)</label>
                    <select id="produit-tva" class="w-full px-4 py-2.5 border border-stone-300 rounded-xl">
                        ${data.tauxTVA.map(t => `<option value="${t}" ${produit.tauxTVA === t ? 'selected' : ''}>${t} %</option>`).join('')}
                    </select></div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div><label class="block text-sm font-medium text-stone-600 mb-1">Co√ªt d'achat (‚Ç¨)</label>
                    <input type="number" step="0.01" id="produit-cout" value="${produit.coutAchat}" class="w-full px-4 py-2.5 border border-stone-300 rounded-xl"></div>
                <div><label class="block text-sm font-medium text-stone-600 mb-1">Coefficient de marge</label>
                    <input type="number" step="0.01" id="produit-marge" value="${produit.marge}" class="w-full px-4 py-2.5 border border-stone-300 rounded-xl"></div>
            </div>
        </div>
        <div class="flex justify-end gap-3 mt-6">
            <button onclick="closeModal()" class="px-4 py-2.5 bg-stone-100 text-stone-700 rounded-xl font-medium">Annuler</button>
            <button onclick="saveProduit('${reference || ''}')" class="btn-primary text-white px-4 py-2.5 rounded-xl font-medium">${isEdit ? 'Enregistrer' : 'Cr√©er'}</button>
        </div>
    `;
    showModal(isEdit ? 'Modifier produit' : 'Nouveau produit', content, 'max-w-xl');
}

function updateProductReference() {
    const categorieId = document.getElementById('produit-categorie').value;
    const newRef = generateProductReference(categorieId);
    document.getElementById('produit-ref').value = newRef;
}

function saveProduit(oldRef) {
    const produit = {
        reference: document.getElementById('produit-ref').value,
        description: document.getElementById('produit-desc').value,
        prixHT: parseFloat(document.getElementById('produit-prix').value) || 0,
        tauxTVA: parseFloat(document.getElementById('produit-tva').value) || 0,
        coutAchat: parseFloat(document.getElementById('produit-cout').value) || 0,
        marge: parseFloat(document.getElementById('produit-marge').value) || 0,
        categorie: document.getElementById('produit-categorie').value
    };

    if (oldRef) {
        const idx = data.produits.findIndex(p => p.reference === oldRef);
        if (idx !== -1) data.produits[idx] = produit;
    } else {
        data.produits.push(produit);
    }

    saveData();
    closeModal();
    renderPage();
}

function deleteProduit(reference) {
    if (confirm('Supprimer ce produit ?')) {
        data.produits = data.produits.filter(p => p.reference !== reference);
        saveData();
        renderPage();
    }
}

// ============================================
// GESTION DES CAT√âGORIES
// ============================================
function openCategorieModal() {
    renderCategorieModal();
}

function renderCategorieModal() {
    const content = `
        <div class="space-y-4">
            <div class="bg-amber-50 border border-amber-200 rounded-xl p-3 text-sm text-amber-800">
                üí° Les cat√©gories permettent d'organiser vos produits. Chaque produit appartient √† une cat√©gorie.
            </div>
            
            <!-- Liste des cat√©gories -->
            <div class="space-y-2">
                ${data.categories.map((cat, index) => {
                    const count = data.produits.filter(p => p.categorie === cat.id).length;
                    return `
                        <div class="flex items-center justify-between bg-stone-50 rounded-xl p-3 hover:bg-stone-100 transition-colors">
                            <div class="flex items-center gap-3">
                                <span class="text-2xl">${cat.icon}</span>
                                <div>
                                    <p class="font-medium text-stone-800">${cat.nom}</p>
                                    <p class="text-xs text-stone-500">${count} produit${count > 1 ? 's' : ''}</p>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="editCategorie('${cat.id}')" class="p-2 text-amber-500 hover:bg-amber-100 rounded-lg" title="Modifier">‚úèÔ∏è</button>
                                ${count === 0 ? `<button onclick="deleteCategorie('${cat.id}')" class="p-2 text-red-500 hover:bg-red-100 rounded-lg" title="Supprimer">üóëÔ∏è</button>` : ''}
                            </div>
                        </div>
                    `;
                }).join('')}
            </div>
            
            <!-- Formulaire nouvelle cat√©gorie -->
            <div class="border-t border-stone-200 pt-4 mt-4">
                <h4 class="font-medium text-stone-700 mb-3">‚ûï Ajouter une cat√©gorie</h4>
                <div class="grid grid-cols-3 gap-3">
                    <div>
                        <label class="block text-xs text-stone-500 mb-1">Ic√¥ne (emoji)</label>
                        <input type="text" id="new-cat-icon" placeholder="üì¶" maxlength="2" class="w-full px-3 py-2 border border-stone-300 rounded-lg text-center text-2xl">
                    </div>
                    <div class="col-span-2">
                        <label class="block text-xs text-stone-500 mb-1">Nom de la cat√©gorie</label>
                        <input type="text" id="new-cat-nom" placeholder="Nouvelle cat√©gorie" class="w-full px-3 py-2 border border-stone-300 rounded-lg">
                    </div>
                </div>
                <button onclick="addCategorie()" class="mt-3 w-full btn-primary text-white py-2 rounded-lg font-medium">
                    Ajouter la cat√©gorie
                </button>
            </div>
        </div>
        <div class="flex justify-end mt-6">
            <button onclick="closeModal()" class="px-4 py-2.5 bg-stone-100 text-stone-700 rounded-xl font-medium">Fermer</button>
        </div>
    `;
    showModal('üìÅ G√©rer les cat√©gories', content, 'max-w-lg');
}

function addCategorie() {
    const icon = document.getElementById('new-cat-icon').value.trim() || 'üì¶';
    const nom = document.getElementById('new-cat-nom').value.trim();
    
    if (!nom) {
        alert('Veuillez saisir un nom de cat√©gorie');
        return;
    }
    
    // G√©n√©rer un ID unique
    const id = nom.toLowerCase()
        .normalize('NFD').replace(/[\u0300-\u036f]/g, '') // Enlever accents
        .replace(/[^a-z0-9]/g, '_') // Remplacer caract√®res sp√©ciaux
        .replace(/_+/g, '_'); // √âviter doubles underscores
    
    // V√©rifier si l'ID existe d√©j√†
    if (data.categories.find(c => c.id === id)) {
        alert('Une cat√©gorie avec ce nom existe d√©j√†');
        return;
    }
    
    data.categories.push({ id, nom, icon });
    saveData();
    renderCategorieModal();
    renderPage();
}

function editCategorie(catId) {
    const cat = data.categories.find(c => c.id === catId);
    if (!cat) return;
    
    const content = `
        <div class="space-y-4">
            <div class="grid grid-cols-3 gap-3">
                <div>
                    <label class="block text-xs text-stone-500 mb-1">Ic√¥ne (emoji)</label>
                    <input type="text" id="edit-cat-icon" value="${cat.icon}" maxlength="2" class="w-full px-3 py-2 border border-stone-300 rounded-lg text-center text-2xl">
                </div>
                <div class="col-span-2">
                    <label class="block text-xs text-stone-500 mb-1">Nom de la cat√©gorie</label>
                    <input type="text" id="edit-cat-nom" value="${cat.nom}" class="w-full px-3 py-2 border border-stone-300 rounded-lg">
                </div>
            </div>
        </div>
        <div class="flex justify-end gap-3 mt-6">
            <button onclick="renderCategorieModal()" class="px-4 py-2.5 bg-stone-100 text-stone-700 rounded-xl font-medium">Annuler</button>
            <button onclick="saveCategorie('${catId}')" class="btn-primary text-white px-4 py-2.5 rounded-xl font-medium">Enregistrer</button>
        </div>
    `;
    showModal('‚úèÔ∏è Modifier la cat√©gorie', content, 'max-w-md');
}

function saveCategorie(catId) {
    const cat = data.categories.find(c => c.id === catId);
    if (!cat) return;
    
    const newIcon = document.getElementById('edit-cat-icon').value.trim() || 'üì¶';
    const newNom = document.getElementById('edit-cat-nom').value.trim();
    
    if (!newNom) {
        alert('Veuillez saisir un nom');
        return;
    }
    
    cat.icon = newIcon;
    cat.nom = newNom;
    saveData();
    renderCategorieModal();
    renderPage();
}

function deleteCategorie(catId) {
    const cat = data.categories.find(c => c.id === catId);
    if (!cat) return;
    
    const count = data.produits.filter(p => p.categorie === catId).length;
    if (count > 0) {
        alert(`Impossible de supprimer cette cat√©gorie : ${count} produit(s) y sont associ√©s.`);
        return;
    }
    
    if (confirm(`Supprimer la cat√©gorie "${cat.nom}" ?`)) {
        data.categories = data.categories.filter(c => c.id !== catId);
        saveData();
        renderCategorieModal();
        renderPage();
    }
}

// ============================================
// FACTURES
// ============================================
function renderFactures() {
    return `
        <div class="space-y-6">
            <div class="flex items-center justify-between">
                <h2 class="text-2xl font-bold text-stone-800">Factures (${data.factures.length})</h2>
                <button onclick="openFactureModal()" class="btn-primary text-white px-4 py-2.5 rounded-xl font-medium flex items-center gap-2">
                    <span>+</span> Nouvelle facture
                </button>
            </div>
            <div class="bg-white rounded-2xl shadow-lg overflow-hidden border border-stone-200">
                <table class="w-full">
                    <thead class="bg-gradient-to-r from-stone-100 to-stone-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-stone-600">N¬∞ Facture</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-stone-600">Date</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-stone-600">Client</th>
                            <th class="px-4 py-3 text-right text-sm font-semibold text-stone-600">Total TTC</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-stone-600">R√®glement</th>
                            <th class="px-4 py-3 text-right text-sm font-semibold text-stone-600">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-stone-100">
                        ${data.factures.map(f => `
                            <tr class="hover:bg-amber-50/50 transition-colors">
                                <td class="px-4 py-3 text-sm font-medium">${f.numero}</td>
                                <td class="px-4 py-3 text-sm">${formatDate(f.date)}</td>
                                <td class="px-4 py-3 text-sm">${getClientName(f)}</td>
                                <td class="px-4 py-3 text-sm text-right font-medium">${formatMoney(f.totalTTC)}</td>
                                <td class="px-4 py-3 text-sm">${f.modeReglement}</td>
                                <td class="px-4 py-3 text-right">
                                    <button onclick="viewFacture('${f.numero}')" class="p-1.5 text-blue-500 hover:bg-blue-50 rounded-lg" title="Voir/Imprimer">üëÅÔ∏è</button>
                                    <button onclick="openFactureModal('${f.numero}')" class="p-1.5 text-amber-500 hover:bg-amber-50 rounded-lg" title="Modifier">‚úèÔ∏è</button>
                                    <button onclick="deleteFacture('${f.numero}')" class="p-1.5 text-red-500 hover:bg-red-50 rounded-lg" title="Supprimer">üóëÔ∏è</button>
                                </td>
                            </tr>
                        `).join('') || '<tr><td colspan="6" class="px-4 py-8 text-center text-stone-400">Aucune facture</td></tr>'}
                    </tbody>
                </table>
            </div>
        </div>
    `;
}

function openFactureModal(numero = null) {
    currentFacture = numero ? JSON.parse(JSON.stringify(data.factures.find(f => f.numero === numero))) : {
        numero: generateNumber('F', data.factures),
        clientId: data.clients[0]?.numero || '',
        paiementComptoir: false,
        date: new Date().toISOString().split('T')[0],
        dateEcheance: new Date(Date.now() + 30*24*60*60*1000).toISOString().split('T')[0],
        modeReglement: data.moyensReglement[0],
        remise: 0, acompte: 0, lignes: [], notes: ''
    };
    // Migration pour anciennes factures sans paiementComptoir
    if (currentFacture.paiementComptoir === undefined) currentFacture.paiementComptoir = false;
    renderFactureModal();
}

function renderFactureModal() {
    const f = currentFacture;
    const isDevis = f.numero.startsWith('D');
    const client = f.paiementComptoir && !isDevis ? null : getClient(f.clientId);
    
    const totalHT = f.lignes.reduce((sum, l) => sum + (l.prixHT * l.quantite), 0);
    const totalHTRemise = totalHT * (1 - f.remise / 100);
    const totalTTC = data.entreprise.exonereTVA ? totalHTRemise : totalHTRemise * 1.2;

    const content = `
        <div class="space-y-6">
            <div class="grid grid-cols-2 gap-6">
                <div class="bg-stone-50 rounded-xl p-4">
                    <h3 class="font-semibold text-stone-800 mb-2">${data.entreprise.nom}</h3>
                    <p class="text-sm text-stone-600">${data.entreprise.adresse}<br>${data.entreprise.codePostal} ${data.entreprise.ville}</p>
                </div>
                <div class="space-y-3">
                    ${!isDevis ? `
                    <!-- Case Paiement Comptoir (seulement pour factures) -->
                    <label class="flex items-center gap-3 p-3 bg-amber-50 border border-amber-200 rounded-xl cursor-pointer hover:bg-amber-100 transition-colors">
                        <input type="checkbox" id="facture-comptoir" ${f.paiementComptoir ? 'checked' : ''} onchange="currentFacture.paiementComptoir = this.checked; if(this.checked) currentFacture.clientId = ''; renderFactureModal()" class="w-5 h-5 rounded text-amber-500">
                        <div>
                            <span class="font-medium text-amber-800">üõí Paiement comptoir</span>
                            <p class="text-xs text-amber-600">Vente directe sans client enregistr√©</p>
                        </div>
                    </label>
                    ` : ''}
                    
                    ${!f.paiementComptoir || isDevis ? `
                        <label class="block text-sm font-medium text-stone-600 mb-1">Client</label>
                        <div class="relative">
                            <input type="text" id="client-search" placeholder="Rechercher un client..." 
                                   oninput="filterClients(this.value)" 
                                   onfocus="showClientSuggestions()" 
                                   class="w-full px-4 py-2.5 border border-stone-300 rounded-xl mb-2">
                            <div id="client-suggestions" class="hidden absolute z-50 w-full bg-white border border-stone-300 rounded-xl shadow-lg max-h-48 overflow-y-auto"></div>
                        </div>
                        <select id="facture-client" onchange="currentFacture.clientId = this.value; renderFactureModal()" class="w-full px-4 py-2.5 border border-stone-300 rounded-xl">
                            ${data.clients.map(c => `<option value="${c.numero}" ${f.clientId === c.numero ? 'selected' : ''}>${c.numero} - ${c.nom}</option>`).join('')}
                        </select>
                        ${client ? `<div class="${isDevis ? 'bg-blue-50' : 'bg-amber-50'} rounded-xl p-3 text-sm mt-2"><p class="font-medium">${client.nom}</p><p class="text-stone-600">${client.adresse || ''}</p><p class="text-stone-600">${client.codePostal || ''} ${client.ville || ''}</p></div>` : ''}
                    ` : `
                        <div class="bg-green-50 border border-green-200 rounded-xl p-3 text-sm">
                            <p class="font-medium text-green-800">‚úì Paiement comptoir</p>
                            <p class="text-green-600">La facture sera √©mise sans nom de client</p>
                        </div>
                    `}
                </div>
            </div>
            <div class="grid grid-cols-4 gap-4">
                <div><label class="block text-sm font-medium text-stone-600 mb-1">${isDevis ? 'N¬∞ Devis' : 'N¬∞ Facture'}</label>
                    <input type="text" value="${f.numero}" disabled class="w-full px-4 py-2.5 border border-stone-300 rounded-xl bg-stone-100"></div>
                <div><label class="block text-sm font-medium text-stone-600 mb-1">Date</label>
                    <input type="date" id="facture-date" value="${f.date}" onchange="currentFacture.date = this.value" class="w-full px-4 py-2.5 border border-stone-300 rounded-xl"></div>
                <div><label class="block text-sm font-medium text-stone-600 mb-1">${isDevis ? 'Validit√©' : '√âch√©ance'}</label>
                    <input type="date" id="facture-echeance" value="${f.dateEcheance}" onchange="currentFacture.dateEcheance = this.value" class="w-full px-4 py-2.5 border border-stone-300 rounded-xl"></div>
                <div><label class="block text-sm font-medium text-stone-600 mb-1">Mode r√®glement</label>
                    <select id="facture-reglement" onchange="currentFacture.modeReglement = this.value" class="w-full px-4 py-2.5 border border-stone-300 rounded-xl">
                        ${data.moyensReglement.map(m => `<option value="${m}" ${f.modeReglement === m ? 'selected' : ''}>${m}</option>`).join('')}
                    </select></div>
            </div>
            <div class="space-y-3">
                <div class="flex items-center justify-between">
                    <h3 class="font-semibold text-stone-800">${isDevis ? 'Lignes de devis' : 'Lignes de facture'}</h3>
                    <button onclick="showProductPicker()" class="btn-primary text-white px-3 py-1.5 rounded-lg text-sm">+ Ajouter produit</button>
                </div>
                <div id="product-picker" class="hidden bg-stone-50 rounded-xl p-4 space-y-3">
                    <input type="text" id="product-search" placeholder="Rechercher un produit..." oninput="filterProducts(this.value)" class="w-full px-4 py-2 border border-stone-300 rounded-lg">
                    <div id="product-list" class="max-h-48 overflow-y-auto space-y-1"></div>
                </div>
                <div class="bg-white border border-stone-200 rounded-xl overflow-hidden">
                    <table class="w-full">
                        <thead class="bg-stone-100">
                            <tr>
                                <th class="px-3 py-2 text-left text-sm">R√©f.</th>
                                <th class="px-3 py-2 text-left text-sm">Description</th>
                                <th class="px-3 py-2 text-right text-sm">Prix HT</th>
                                <th class="px-3 py-2 text-center text-sm w-20">Qt√©</th>
                                <th class="px-3 py-2 text-right text-sm">Total</th>
                                <th class="px-3 py-2 w-10"></th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-stone-100">
                            ${f.lignes.length === 0 ? '<tr><td colspan="6" class="px-4 py-6 text-center text-stone-400">Aucun produit</td></tr>' :
                            f.lignes.map((l, i) => `
                                <tr>
                                    <td class="px-3 py-2 text-sm">${l.reference}</td>
                                    <td class="px-3 py-2 text-sm">${l.description}</td>
                                    <td class="px-3 py-2 text-sm text-right">${formatMoney(l.prixHT)}</td>
                                    <td class="px-3 py-2"><input type="number" min="1" value="${l.quantite}" onchange="updateLigneQte(${i}, this.value)" class="w-16 text-center border border-stone-300 rounded px-2 py-1"></td>
                                    <td class="px-3 py-2 text-sm text-right font-medium">${formatMoney(l.prixHT * l.quantite)}</td>
                                    <td class="px-3 py-2"><button onclick="removeLigne(${i})" class="text-red-500 hover:bg-red-50 p-1 rounded">‚úï</button></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="flex justify-end">
                <div class="w-80 space-y-2 bg-stone-50 rounded-xl p-4">
                    <div class="flex justify-between text-sm"><span>Total HT</span><span class="font-medium">${formatMoney(totalHT)}</span></div>
                    <div class="flex justify-between text-sm items-center">
                        <span>Remise (%)</span>
                        <input type="number" min="0" max="100" value="${f.remise}" onchange="currentFacture.remise = parseFloat(this.value) || 0; renderFactureModal()" class="w-16 text-right border border-stone-300 rounded px-2 py-1">
                    </div>
                    ${f.remise > 0 ? `<div class="flex justify-between text-sm text-red-600"><span>Apr√®s remise</span><span>${formatMoney(totalHTRemise)}</span></div>` : ''}
                    
                    <!-- Case √† cocher montant manuel -->
                    <div class="border-t border-stone-300 pt-2 mt-2">
                        <label class="flex items-center gap-2 cursor-pointer mb-2 ${f.totalManuelValide ? 'opacity-50' : ''}">
                            <input type="checkbox" id="montant-manuel-check" 
                                ${f.montantManuel ? 'checked' : ''} 
                                ${f.totalManuelValide ? 'disabled' : ''}
                                onchange="toggleMontantManuel(this.checked)" 
                                class="w-4 h-4 rounded text-amber-500">
                            <span class="text-sm ${f.totalManuelValide ? 'text-stone-400' : 'text-stone-600'}">Saisir montant TTC manuellement</span>
                        </label>
                        
                        ${f.montantManuel && !f.totalManuelValide ? `
                        <div class="flex items-center gap-2 mb-2">
                            <input type="number" step="0.01" min="0" id="montant-manuel-input" 
                                value="${f.totalManuelSaisi || ''}" 
                                placeholder="Montant TTC"
                                class="flex-1 text-right border border-amber-300 rounded px-2 py-1 bg-amber-50"
                                onchange="setMontantManuel(this.value)">
                            <span class="text-sm text-stone-500">‚Ç¨</span>
                            <button onclick="validerMontantManuel()" class="bg-green-500 hover:bg-green-600 text-white text-xs px-2 py-1 rounded">‚úì OK</button>
                        </div>
                        ` : ''}
                        
                        ${f.totalManuelValide ? `
                        <div class="flex items-center justify-between bg-green-50 border border-green-200 rounded px-2 py-1 mb-2">
                            <span class="text-sm text-green-700">Montant fix√© :</span>
                            <span class="font-bold text-green-700">${formatMoney(f.totalManuelSaisi)}</span>
                            <button onclick="reinitMontantManuel()" class="text-red-500 hover:text-red-700 text-xs ml-2" title="R√©initialiser">‚úï</button>
                        </div>
                        ` : ''}
                    </div>
                    
                    <div class="flex justify-between text-lg font-bold">
                        <span>Total TTC</span><span class="${isDevis ? 'text-blue-600' : 'text-amber-600'}">${formatMoney(f.totalManuelValide ? f.totalManuelSaisi : totalTTC)}</span>
                    </div>
                </div>
            </div>
            ${data.entreprise.exonereTVA ? '<div class="bg-amber-50 border border-amber-200 rounded-xl px-4 py-2 text-sm text-amber-800">TVA non applicable, article 293B du CGI</div>' : ''}
        </div>
        <div class="flex justify-end gap-3 mt-6">
            <button onclick="closeModal()" class="px-4 py-2.5 bg-stone-100 text-stone-700 rounded-xl font-medium">Annuler</button>
            <button onclick="${isDevis ? 'saveDevis()' : 'saveFacture()'}" class="${isDevis ? 'bg-blue-600 hover:bg-blue-700' : 'btn-primary'} text-white px-4 py-2.5 rounded-xl font-medium">Enregistrer</button>
        </div>
    `;
    showModal((isDevis ? 'Devis ' : 'Facture ') + currentFacture.numero, content, 'max-w-4xl');
}

function filterClients(query) {
    const suggestions = document.getElementById('client-suggestions');
    if (!query || query.length < 1) {
        suggestions.classList.add('hidden');
        return;
    }
    const q = query.toLowerCase();
    const filtered = data.clients.filter(c => 
        c.nom.toLowerCase().includes(q) || 
        c.numero.toLowerCase().includes(q) ||
        (c.email && c.email.toLowerCase().includes(q)) ||
        (c.telephone && c.telephone.includes(q))
    ).slice(0, 8);
    
    if (filtered.length > 0) {
        suggestions.innerHTML = filtered.map(c => `
            <div onclick="selectClient('${c.numero}')" class="px-4 py-2 hover:bg-amber-50 cursor-pointer border-b border-stone-100 last:border-0">
                <span class="font-medium text-amber-600">${c.numero}</span> - ${c.nom}
            </div>
        `).join('');
        suggestions.classList.remove('hidden');
    } else {
        suggestions.classList.add('hidden');
    }
}

function showClientSuggestions() {
    const input = document.getElementById('client-search');
    if (input && input.value.length >= 1) {
        filterClients(input.value);
    }
}

function selectClient(numero) {
    currentFacture.clientId = numero;
    document.getElementById('client-suggestions').classList.add('hidden');
    document.getElementById('client-search').value = '';
    renderFactureModal();
}

function showProductPicker() {
    document.getElementById('product-picker').classList.remove('hidden');
    filterProducts('');
}

function filterProducts(search) {
    const filtered = data.produits.filter(p => 
        p.description.toLowerCase().includes(search.toLowerCase()) || 
        p.reference.toLowerCase().includes(search.toLowerCase())
    ).slice(0, 10);
    
    document.getElementById('product-list').innerHTML = filtered.map(p => `
        <button onclick="addProductToFacture('${p.reference}')" class="w-full text-left px-3 py-2 hover:bg-amber-100 rounded-lg transition-colors flex justify-between">
            <span>${p.reference} - ${p.description}</span>
            <span class="text-amber-600 font-medium">${formatMoney(p.prixHT)}</span>
        </button>
    `).join('') || '<p class="text-stone-400 text-center py-2">Aucun produit</p>';
}

function addProductToFacture(reference) {
    const produit = data.produits.find(p => p.reference === reference);
    if (produit) {
        currentFacture.lignes.push({
            id: Date.now(),
            reference: produit.reference,
            description: produit.description,
            prixHT: produit.prixHT,
            quantite: 1,
            tauxTVA: produit.tauxTVA
        });
        document.getElementById('product-picker').classList.add('hidden');
        renderFactureModal();
    }
}

function updateLigneQte(index, value) {
    currentFacture.lignes[index].quantite = parseInt(value) || 1;
    renderFactureModal();
}

function removeLigne(index) {
    currentFacture.lignes.splice(index, 1);
    renderFactureModal();
}

function saveFacture() {
    const f = currentFacture;
    let totalHT = f.lignes.reduce((sum, l) => sum + (l.prixHT * l.quantite), 0);
    let totalHTRemise = totalHT * (1 - f.remise / 100);
    let totalTTC = data.entreprise.exonereTVA ? totalHTRemise : totalHTRemise * 1.2;
    
    // Utiliser le montant manuel si valid√©
    if (f.totalManuelValide && f.totalManuelSaisi) {
        totalTTC = f.totalManuelSaisi;
        // Pour la compta, totalHT = totalTTC car exon√©r√© de TVA
        totalHT = f.totalManuelSaisi;
        totalHTRemise = f.totalManuelSaisi;
    }
    
    f.totalHT = totalHT;
    f.totalHTRemise = totalHTRemise;
    f.totalTTC = totalTTC;

    const idx = data.factures.findIndex(x => x.numero === f.numero);
    if (idx !== -1) {
        data.factures[idx] = f;
    } else {
        // Nouvelle facture : d√©cr√©menter le stock
        decrementerStock(f.lignes);
        data.factures.push(f);
    }

    saveData();
    closeModal();
    renderPage();
}

// Fonctions de gestion du montant manuel
function toggleMontantManuel(checked) {
    currentFacture.montantManuel = checked;
    if (!checked) {
        currentFacture.totalManuelSaisi = null;
        currentFacture.totalManuelValide = false;
    }
    renderFactureModal();
}

function setMontantManuel(value) {
    currentFacture.totalManuelSaisi = parseFloat(value) || 0;
}

function validerMontantManuel() {
    const input = document.getElementById('montant-manuel-input');
    if (input && input.value) {
        currentFacture.totalManuelSaisi = parseFloat(input.value) || 0;
        currentFacture.totalManuelValide = true;
        currentFacture.montantManuel = false; // D√©coche la case
        renderFactureModal();
    } else {
        alert('Veuillez saisir un montant');
    }
}

function reinitMontantManuel() {
    currentFacture.totalManuelSaisi = null;
    currentFacture.totalManuelValide = false;
    currentFacture.montantManuel = false;
    renderFactureModal();
}

function deleteFacture(numero) {
    if (confirm('Supprimer cette facture ?')) {
        data.factures = data.factures.filter(f => f.numero !== numero);
        saveData();
        renderPage();
    }
}

function viewFacture(numero) {
    const f = data.factures.find(x => x.numero === numero);
    const client = f.paiementComptoir ? null : getClient(f.clientId);
    
    const content = `
        <div id="print-facture">
            <!-- Page 1 : Facture -->
            <div class="print-page">
                <div class="flex justify-between mb-8">
                    <div>
                        ${data.logo ? `<img src="${data.logo}" alt="Logo" class="max-h-16 mb-2"><h2 class="text-xl font-bold">${data.entreprise.nom}</h2>` : `<h2 class="text-xl font-bold">${data.entreprise.nom}</h2>`}
                        <p class="text-sm text-stone-600">${data.entreprise.complement}</p>
                        <p class="text-sm text-stone-600">${data.entreprise.adresse}</p>
                        <p class="text-sm text-stone-600">${data.entreprise.codePostal} ${data.entreprise.ville}</p>
                        <p class="text-sm text-stone-600">T√©l : ${data.entreprise.telephone}</p>
                        <p class="text-sm text-stone-600 mt-2">Siret : ${data.entreprise.siret}</p>
                        <p class="text-sm text-stone-600">IBAN : ${data.entreprise.iban}</p>
                        <p class="text-sm text-stone-600">BIC : ${data.entreprise.bic}</p>
                    </div>
                    <div class="text-right">
                        <h1 class="text-2xl font-bold text-amber-600">FACTURE</h1>
                        <p class="text-lg font-medium">${f.numero}</p>
                        <p class="text-sm text-stone-600 mt-4">Date : ${formatDate(f.date)}</p>
                        <p class="text-sm text-stone-600">√âch√©ance : ${formatDate(f.dateEcheance)}</p>
                    </div>
                </div>
                <div class="mb-6">
                    <h3 class="text-sm font-semibold text-stone-500 mb-2">DESTINATAIRE</h3>
                    <div class="bg-stone-50 p-4 rounded-lg">
                        ${f.paiementComptoir ? `
                            <p class="font-medium text-amber-700">üõí Paiement comptoir</p>
                            <p class="text-sm text-stone-500">Vente directe - Client de passage</p>
                        ` : `
                            <p class="font-medium">${client?.nom || '-'}</p>
                            <p class="text-sm">${client?.adresse || ''}</p>
                            <p class="text-sm">${client?.codePostal || ''} ${client?.ville || ''}</p>
                        `}
                    </div>
                </div>
                <table class="w-full border border-stone-200 mb-6">
                    <thead class="bg-stone-100">
                        <tr>
                            <th class="border border-stone-200 px-3 py-2 text-left text-sm">R√©f√©rence</th>
                            <th class="border border-stone-200 px-3 py-2 text-left text-sm">Description</th>
                            <th class="border border-stone-200 px-3 py-2 text-right text-sm">Prix HT</th>
                            <th class="border border-stone-200 px-3 py-2 text-center text-sm">Qt√©</th>
                            <th class="border border-stone-200 px-3 py-2 text-right text-sm">Total HT</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${f.lignes.map(l => `
                            <tr>
                                <td class="border border-stone-200 px-3 py-2 text-sm">${l.reference}</td>
                                <td class="border border-stone-200 px-3 py-2 text-sm">${l.description}</td>
                                <td class="border border-stone-200 px-3 py-2 text-sm text-right">${formatMoney(l.prixHT)}</td>
                                <td class="border border-stone-200 px-3 py-2 text-sm text-center">${l.quantite}</td>
                                <td class="border border-stone-200 px-3 py-2 text-sm text-right">${formatMoney(l.prixHT * l.quantite)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                <div class="flex justify-end mb-6">
                    <div class="w-64">
                        <div class="flex justify-between py-1"><span>Total HT</span><span>${formatMoney(f.totalHT)}</span></div>
                        ${f.remise > 0 ? `<div class="flex justify-between py-1 text-red-600"><span>Remise (${f.remise}%)</span><span>-${formatMoney(f.totalHT * f.remise / 100)}</span></div>` : ''}
                        <div class="flex justify-between py-2 border-t-2 border-stone-300 font-bold text-lg"><span>Total TTC</span><span>${formatMoney(f.totalTTC)}</span></div>
                    </div>
                </div>
                ${data.entreprise.exonereTVA ? '<p class="text-sm text-stone-500 italic mb-4">TVA non applicable, article 293B du CGI</p>' : ''}
                <p class="text-sm text-stone-600">Mode de r√®glement : ${f.modeReglement}</p>
                <p class="text-xs text-stone-400 mt-4">Voir conditions g√©n√©rales de vente au verso</p>
            </div>
        </div>
        <div class="flex justify-end gap-3 mt-6 no-print">
            <button onclick="sendFactureByEmail('${f.numero}')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2.5 rounded-xl font-medium">üìß PDF + Gmail</button>
            <button onclick="printFactureWithCGV('${f.numero}')" class="btn-primary text-white px-4 py-2.5 rounded-xl font-medium">üñ®Ô∏è Imprimer (recto-verso)</button>
        </div>
    `;
    showModal('Facture ' + f.numero, content, 'max-w-3xl');
}

function printFactureWithCGV(numero) {
    const f = data.factures.find(x => x.numero === numero);
    const client = f.paiementComptoir ? null : getClient(f.clientId);
    
    const printWindow = window.open('', '', 'width=800,height=600');
    printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>Facture ${f.numero}</title>
            <style>
                * { box-sizing: border-box; }
                body { font-family: Arial, sans-serif; margin: 0; padding: 0; font-size: 11px; }
                @page { size: A4; margin: 10mm; }
                @media print {
                    .facture-page { page-break-after: always; height: 277mm; }
                    .cgv-page { page-break-before: avoid; page-break-inside: avoid; }
                }
                .facture-page { padding: 10mm; }
                .cgv-page { padding: 8mm; }
                table { width: 100%; border-collapse: collapse; margin: 10px 0; }
                th, td { border: 1px solid #ddd; padding: 6px; text-align: left; font-size: 10px; }
                th { background: #f5f5f5; }
                .text-right { text-align: right; }
                .text-center { text-align: center; }
                .header { display: flex; justify-content: space-between; margin-bottom: 20px; }
                .totals { width: 220px; margin-left: auto; }
                .totals div { display: flex; justify-content: space-between; padding: 4px 0; font-size: 11px; }
                .total-line { border-top: 2px solid #333; font-weight: bold; font-size: 13px; }
                h1 { color: #f59e0b; margin: 0; font-size: 24px; }
                h2 { margin: 0; font-size: 16px; }
                .cgv-wrapper { display: block; }
                .cgv-title { font-size: 11px; font-weight: bold; margin-bottom: 6px; text-align: center; text-transform: uppercase; border-bottom: 1px solid #333; padding-bottom: 4px; }
                .cgv-content { font-size: 6.5px; line-height: 1.3; column-count: 2; column-gap: 12px; text-align: justify; orphans: 3; widows: 3; }
                .cgv-content .article { margin-bottom: 6px; break-inside: avoid; }
                .cgv-content .article-title { font-weight: bold; font-size: 7px; margin-bottom: 2px; color: #333; text-transform: uppercase; }
            </style>
        </head>
        <body>
            <!-- Recto: Facture -->
            <div class="facture-page">
                <div class="header">
                    <div>
                        ${data.logo ? `<img src="${data.logo}" style="max-height:50px;margin-bottom:8px"><h2>${data.entreprise.nom}</h2>` : `<h2>${data.entreprise.nom}</h2>`}
                        <p style="font-size:10px;margin:5px 0">${data.entreprise.complement}<br>${data.entreprise.adresse}<br>${data.entreprise.codePostal} ${data.entreprise.ville}<br>T√©l: ${data.entreprise.telephone}</p>
                        <p style="font-size:9px;margin:5px 0">Siret: ${data.entreprise.siret}<br>IBAN: ${data.entreprise.iban}<br>BIC: ${data.entreprise.bic}</p>
                    </div>
                    <div style="text-align:right">
                        <h1>FACTURE</h1>
                        <p style="font-size:14px;font-weight:bold;margin:5px 0">${f.numero}</p>
                        <p style="font-size:10px">Date: ${formatDate(f.date)}<br>√âch√©ance: ${formatDate(f.dateEcheance)}</p>
                    </div>
                </div>
                <div style="background:#f5f5f5;padding:10px;margin-bottom:15px;font-size:10px">
                    <strong>DESTINATAIRE</strong><br>
                    ${f.paiementComptoir ? `
                        <span style="color:#d97706;font-weight:bold">üõí Paiement comptoir</span><br>
                        <span style="color:#666">Vente directe - Client de passage</span>
                    ` : `
                        ${client?.nom || '-'}<br>
                        ${client?.adresse || ''}<br>
                        ${client?.codePostal || ''} ${client?.ville || ''}
                    `}
                </div>
                <table>
                    <thead><tr><th>R√©f.</th><th>Description</th><th class="text-right">Prix HT</th><th class="text-center">Qt√©</th><th class="text-right">Total HT</th></tr></thead>
                    <tbody>
                        ${f.lignes.map(l => `<tr><td>${l.reference}</td><td>${l.description}</td><td class="text-right">${formatMoney(l.prixHT)}</td><td class="text-center">${l.quantite}</td><td class="text-right">${formatMoney(l.prixHT * l.quantite)}</td></tr>`).join('')}
                    </tbody>
                </table>
                <div class="totals">
                    <div><span>Total HT</span><span>${formatMoney(f.totalHT)}</span></div>
                    ${f.remise > 0 ? `<div style="color:red"><span>Remise (${f.remise}%)</span><span>-${formatMoney(f.totalHT * f.remise / 100)}</span></div>` : ''}
                    <div class="total-line"><span>Total TTC</span><span>${formatMoney(f.totalTTC)}</span></div>
                </div>
                ${data.entreprise.exonereTVA ? '<p style="font-style:italic;color:#666;margin-top:15px;font-size:10px">TVA non applicable, article 293B du CGI</p>' : ''}
                <p style="margin-top:10px;font-size:10px">Mode de r√®glement: ${f.modeReglement}</p>
                <p style="font-size:9px;color:#999;margin-top:20px">Voir conditions g√©n√©rales de vente au verso</p>
            </div>
            <!-- Verso: CGV -->
            <div class="cgv-page">
                <div class="cgv-wrapper">
                    <div class="cgv-title">CONDITIONS G√âN√âRALES DE VENTE</div>
                    <div class="cgv-content">${formatCGVForPrint(data.cgv)}</div>
                </div>
            </div>
        </body>
        </html>
    `);
    printWindow.document.close();
    printWindow.print();
}

// ============================================
// GESTION DU STOCK
// ============================================
function renderStock() {
    // Calculer les statistiques de stock
    const produitsAvecStock = data.produits.filter(p => (p.stock || 0) > 0);
    const produitsStockBas = data.produits.filter(p => (p.stock || 0) > 0 && (p.stock || 0) <= 3);
    const produitsRupture = data.produits.filter(p => (p.stock || 0) === 0);
    const valeurStock = data.produits.reduce((acc, p) => acc + ((p.stock || 0) * (p.coutAchat || 0)), 0);
    
    return `
        <div class="space-y-6">
            <div class="flex items-center justify-between">
                <h2 class="text-2xl font-bold text-stone-800">üìã Gestion du Stock</h2>
                <div class="flex gap-2">
                    <button onclick="exportStock()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-xl font-medium">üì• Exporter</button>
                </div>
            </div>
            
            <!-- Statistiques -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="bg-white rounded-xl p-4 shadow border-l-4 border-blue-500">
                    <p class="text-stone-500 text-sm">Produits en stock</p>
                    <p class="text-2xl font-bold text-blue-600">${produitsAvecStock.length}</p>
                </div>
                <div class="bg-white rounded-xl p-4 shadow border-l-4 border-amber-500">
                    <p class="text-stone-500 text-sm">Stock bas (‚â§3)</p>
                    <p class="text-2xl font-bold text-amber-600">${produitsStockBas.length}</p>
                </div>
                <div class="bg-white rounded-xl p-4 shadow border-l-4 border-red-500">
                    <p class="text-stone-500 text-sm">En rupture</p>
                    <p class="text-2xl font-bold text-red-600">${produitsRupture.length}</p>
                </div>
                <div class="bg-white rounded-xl p-4 shadow border-l-4 border-green-500">
                    <p class="text-stone-500 text-sm">Valeur du stock</p>
                    <p class="text-2xl font-bold text-green-600">${valeurStock.toFixed(2)} ‚Ç¨</p>
                </div>
            </div>
            
            <!-- Filtres -->
            <div class="bg-white rounded-xl p-4 shadow flex flex-wrap gap-4 items-center">
                <input type="text" id="stock-search" placeholder="üîç Rechercher un produit..." 
                    class="flex-1 min-w-[200px] px-4 py-2 border rounded-lg" onkeyup="filterStock()">
                <select id="stock-filter" class="px-4 py-2 border rounded-lg" onchange="filterStock()">
                    <option value="all">Tous les produits</option>
                    <option value="instock">En stock (>0)</option>
                    <option value="low">Stock bas (‚â§3)</option>
                    <option value="out">Rupture (0)</option>
                </select>
                <select id="stock-categorie" class="px-4 py-2 border rounded-lg" onchange="filterStock()">
                    <option value="all">Toutes cat√©gories</option>
                    ${data.categories.map(c => `<option value="${c.id}">${c.icon} ${c.nom}</option>`).join('')}
                </select>
            </div>
            
            <!-- Tableau de stock -->
            <div class="bg-white rounded-2xl shadow-lg overflow-hidden border border-stone-200">
                <table class="w-full" id="stock-table">
                    <thead class="bg-gradient-to-r from-stone-100 to-stone-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-stone-600">R√©f</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-stone-600">Produit</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-stone-600">Cat√©gorie</th>
                            <th class="px-4 py-3 text-center text-sm font-semibold text-stone-600">Stock</th>
                            <th class="px-4 py-3 text-right text-sm font-semibold text-stone-600">Prix achat</th>
                            <th class="px-4 py-3 text-right text-sm font-semibold text-stone-600">Valeur</th>
                            <th class="px-4 py-3 text-center text-sm font-semibold text-stone-600">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="stock-tbody">
                        ${renderStockRows(data.produits)}
                    </tbody>
                </table>
            </div>
        </div>
    `;
}

function renderStockRows(produits) {
    return produits.map(p => {
        const stock = p.stock || 0;
        const valeur = stock * (p.coutAchat || 0);
        const cat = data.categories.find(c => c.id === p.categorie);
        let stockClass = 'text-green-600 bg-green-100';
        if (stock === 0) stockClass = 'text-red-600 bg-red-100';
        else if (stock <= 3) stockClass = 'text-amber-600 bg-amber-100';
        
        return `
            <tr class="border-t hover:bg-stone-50 stock-row" 
                data-ref="${p.reference}" 
                data-desc="${p.description.toLowerCase()}" 
                data-cat="${p.categorie || ''}"
                data-stock="${stock}">
                <td class="px-4 py-3 font-mono text-sm">${p.reference}</td>
                <td class="px-4 py-3">${p.description}</td>
                <td class="px-4 py-3 text-sm">${cat ? cat.icon + ' ' + cat.nom : '-'}</td>
                <td class="px-4 py-3 text-center">
                    <span class="px-3 py-1 rounded-full font-bold ${stockClass}">${stock}</span>
                </td>
                <td class="px-4 py-3 text-right">${(p.coutAchat || 0).toFixed(2)} ‚Ç¨</td>
                <td class="px-4 py-3 text-right font-medium">${valeur.toFixed(2)} ‚Ç¨</td>
                <td class="px-4 py-3 text-center">
                    <button onclick="modifierStock('${p.reference}')" class="text-blue-500 hover:text-blue-700 px-2" title="Modifier stock">‚úèÔ∏è</button>
                    <button onclick="ajouterStock('${p.reference}')" class="text-green-500 hover:text-green-700 px-2" title="Ajouter">‚ûï</button>
                    <button onclick="retirerStock('${p.reference}')" class="text-red-500 hover:text-red-700 px-2" title="Retirer">‚ûñ</button>
                </td>
            </tr>
        `;
    }).join('');
}

function filterStock() {
    const search = document.getElementById('stock-search').value.toLowerCase();
    const filter = document.getElementById('stock-filter').value;
    const categorie = document.getElementById('stock-categorie').value;
    
    document.querySelectorAll('.stock-row').forEach(row => {
        const ref = row.dataset.ref.toLowerCase();
        const desc = row.dataset.desc;
        const cat = row.dataset.cat;
        const stock = parseInt(row.dataset.stock);
        
        let show = true;
        
        // Recherche texte
        if (search && !ref.includes(search) && !desc.includes(search)) show = false;
        
        // Filtre stock
        if (filter === 'instock' && stock <= 0) show = false;
        if (filter === 'low' && (stock === 0 || stock > 3)) show = false;
        if (filter === 'out' && stock !== 0) show = false;
        
        // Filtre cat√©gorie
        if (categorie !== 'all' && cat !== categorie) show = false;
        
        row.style.display = show ? '' : 'none';
    });
}

function modifierStock(ref) {
    const produit = data.produits.find(p => p.reference === ref);
    if (!produit) return;
    
    const newStock = prompt(`Stock actuel de "${produit.description}": ${produit.stock || 0}\n\nNouveau stock:`, produit.stock || 0);
    if (newStock !== null && !isNaN(parseInt(newStock))) {
        produit.stock = Math.max(0, parseInt(newStock));
        saveData();
        navigateTo('stock');
    }
}

function ajouterStock(ref) {
    const produit = data.produits.find(p => p.reference === ref);
    if (!produit) return;
    
    const qte = prompt(`Ajouter au stock de "${produit.description}" (actuel: ${produit.stock || 0}):`, 1);
    if (qte !== null && !isNaN(parseInt(qte)) && parseInt(qte) > 0) {
        produit.stock = (produit.stock || 0) + parseInt(qte);
        saveData();
        navigateTo('stock');
    }
}

function retirerStock(ref) {
    const produit = data.produits.find(p => p.reference === ref);
    if (!produit) return;
    
    const qte = prompt(`Retirer du stock de "${produit.description}" (actuel: ${produit.stock || 0}):`, 1);
    if (qte !== null && !isNaN(parseInt(qte)) && parseInt(qte) > 0) {
        produit.stock = Math.max(0, (produit.stock || 0) - parseInt(qte));
        saveData();
        navigateTo('stock');
    }
}

function exportStock() {
    let csv = 'R√©f√©rence;Produit;Cat√©gorie;Stock;Prix Achat;Valeur\n';
    data.produits.forEach(p => {
        const cat = data.categories.find(c => c.id === p.categorie);
        const stock = p.stock || 0;
        const valeur = stock * (p.coutAchat || 0);
        csv += `${p.reference};${p.description};${cat ? cat.nom : ''};${stock};${(p.coutAchat || 0).toFixed(2)};${valeur.toFixed(2)}\n`;
    });
    
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `stock_stylemoi_${new Date().toISOString().slice(0,10)}.csv`;
    link.click();
}

// D√©cr√©mentation automatique du stock lors de la sauvegarde d'une facture
function decrementerStock(lignes) {
    lignes.forEach(ligne => {
        const produit = data.produits.find(p => p.reference === ligne.reference || p.description === ligne.description);
        if (produit && produit.stock !== undefined) {
            produit.stock = Math.max(0, produit.stock - ligne.quantite);
        }
    });
}

// ============================================
// DEVIS (similaire aux factures)
// ============================================
function renderDevis() {
    return `
        <div class="space-y-6">
            <div class="flex items-center justify-between">
                <h2 class="text-2xl font-bold text-stone-800">Devis (${data.devis.length})</h2>
                <button onclick="openDevisModal()" class="btn-primary text-white px-4 py-2.5 rounded-xl font-medium">+ Nouveau devis</button>
            </div>
            <div class="bg-white rounded-2xl shadow-lg overflow-hidden border border-stone-200">
                <table class="w-full">
                    <thead class="bg-gradient-to-r from-stone-100 to-stone-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-stone-600">N¬∞ Devis</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-stone-600">Date</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-stone-600">Client</th>
                            <th class="px-4 py-3 text-right text-sm font-semibold text-stone-600">Total TTC</th>
                            <th class="px-4 py-3 text-right text-sm font-semibold text-stone-600">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-stone-100">
                        ${data.devis.map(d => `
                            <tr class="hover:bg-amber-50/50">
                                <td class="px-4 py-3 text-sm font-medium">${d.numero}</td>
                                <td class="px-4 py-3 text-sm">${formatDate(d.date)}</td>
                                <td class="px-4 py-3 text-sm">${getClient(d.clientId)?.nom || '-'}</td>
                                <td class="px-4 py-3 text-sm text-right font-medium">${formatMoney(d.totalTTC)}</td>
                                <td class="px-4 py-3 text-right">
                                    <button onclick="viewDevis('${d.numero}')" class="p-1.5 text-blue-500 hover:bg-blue-50 rounded-lg">üëÅÔ∏è</button>
                                    <button onclick="convertDevisToFacture('${d.numero}')" class="p-1.5 text-green-500 hover:bg-green-50 rounded-lg" title="Convertir en facture">‚û°Ô∏èüßæ</button>
                                    <button onclick="deleteDevis('${d.numero}')" class="p-1.5 text-red-500 hover:bg-red-50 rounded-lg">üóëÔ∏è</button>
                                </td>
                            </tr>
                        `).join('') || '<tr><td colspan="5" class="px-4 py-8 text-center text-stone-400">Aucun devis</td></tr>'}
                    </tbody>
                </table>
            </div>
        </div>
    `;
}

function openDevisModal() {
    currentFacture = {
        numero: generateNumber('D', data.devis),
        clientId: data.clients[0]?.numero || '',
        date: new Date().toISOString().split('T')[0],
        dateEcheance: new Date(Date.now() + 30*24*60*60*1000).toISOString().split('T')[0],
        modeReglement: data.moyensReglement[0],
        remise: 0, lignes: []
    };
    renderDevisModal();
}

function renderDevisModal() {
    renderFactureModal();
}

function saveDevis() {
    const d = currentFacture;
    let totalHT = d.lignes.reduce((sum, l) => sum + (l.prixHT * l.quantite), 0);
    let totalHTRemise = totalHT * (1 - d.remise / 100);
    let totalTTC = data.entreprise.exonereTVA ? totalHTRemise : totalHTRemise * 1.2;
    
    // Utiliser le montant manuel si valid√©
    if (d.totalManuelValide && d.totalManuelSaisi) {
        totalTTC = d.totalManuelSaisi;
        totalHT = d.totalManuelSaisi;
        totalHTRemise = d.totalManuelSaisi;
    }
    
    d.totalHT = totalHT;
    d.totalHTRemise = totalHTRemise;
    d.totalTTC = totalTTC;

    const idx = data.devis.findIndex(x => x.numero === d.numero);
    if (idx !== -1) data.devis[idx] = d;
    else data.devis.push(d);

    saveData();
    closeModal();
    renderPage();
}

function viewDevis(numero) {
    const d = data.devis.find(x => x.numero === numero);
    const client = getClient(d.clientId);
    
    const content = `
        <div class="space-y-6">
            <div class="flex justify-between">
                <div>
                    ${data.logo ? `<img src="${data.logo}" class="max-h-16 mb-2"><h2 class="text-xl font-bold">${data.entreprise.nom}</h2>` : `<h2 class="text-xl font-bold">${data.entreprise.nom}</h2>`}
                    <p class="text-sm text-stone-600">${data.entreprise.adresse}<br>${data.entreprise.codePostal} ${data.entreprise.ville}</p>
                </div>
                <div class="text-right">
                    <h1 class="text-2xl font-bold text-blue-600">DEVIS</h1>
                    <p class="text-lg font-medium">${d.numero}</p>
                    <p class="text-sm text-stone-600 mt-2">Date : ${formatDate(d.date)}</p>
                </div>
            </div>
            <div class="bg-stone-50 p-4 rounded-lg">
                <p class="font-medium">${client?.nom || '-'}</p>
                <p class="text-sm">${client?.adresse || ''} ${client?.codePostal || ''} ${client?.ville || ''}</p>
            </div>
            <table class="w-full border border-stone-200">
                <thead class="bg-stone-100"><tr><th class="border px-3 py-2 text-left text-sm">R√©f.</th><th class="border px-3 py-2 text-left text-sm">Description</th><th class="border px-3 py-2 text-right text-sm">Prix HT</th><th class="border px-3 py-2 text-center text-sm">Qt√©</th><th class="border px-3 py-2 text-right text-sm">Total</th></tr></thead>
                <tbody>${d.lignes.map(l => `<tr><td class="border px-3 py-2 text-sm">${l.reference}</td><td class="border px-3 py-2 text-sm">${l.description}</td><td class="border px-3 py-2 text-sm text-right">${formatMoney(l.prixHT)}</td><td class="border px-3 py-2 text-sm text-center">${l.quantite}</td><td class="border px-3 py-2 text-sm text-right">${formatMoney(l.prixHT * l.quantite)}</td></tr>`).join('')}</tbody>
            </table>
            <div class="flex justify-end"><div class="w-64"><div class="flex justify-between py-2 border-t-2 font-bold"><span>Total TTC</span><span>${formatMoney(d.totalTTC)}</span></div></div></div>
        </div>
        <div class="flex justify-end gap-3 mt-6">
            <button onclick="sendDevisByEmail('${d.numero}')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2.5 rounded-xl font-medium">üìß PDF + Gmail</button>
            <button onclick="printDevisWithCGV('${d.numero}')" class="btn-primary text-white px-4 py-2.5 rounded-xl font-medium">üñ®Ô∏è Imprimer</button>
        </div>
    `;
    showModal('Devis ' + d.numero, content, 'max-w-3xl');
}

function printDevisWithCGV(numero) {
    const d = data.devis.find(x => x.numero === numero);
    const client = getClient(d.clientId);
    
    const printWindow = window.open('', '', 'width=800,height=600');
    printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>Devis ${d.numero}</title>
            <style>
                * { box-sizing: border-box; }
                body { font-family: Arial, sans-serif; margin: 0; padding: 0; font-size: 11px; }
                @page { size: A4; margin: 10mm; }
                @media print {
                    .devis-page { page-break-after: always; height: 277mm; }
                    .cgv-page { page-break-before: avoid; page-break-inside: avoid; }
                }
                .devis-page { padding: 10mm; }
                .cgv-page { padding: 8mm; }
                table { width: 100%; border-collapse: collapse; margin: 10px 0; }
                th, td { border: 1px solid #ddd; padding: 6px; text-align: left; font-size: 10px; }
                th { background: #f5f5f5; }
                .text-right { text-align: right; }
                h1 { color: #3b82f6; margin: 0; font-size: 24px; }
                h2 { margin: 0; font-size: 16px; }
                .cgv-wrapper { display: block; }
                .cgv-title { font-size: 11px; font-weight: bold; margin-bottom: 6px; text-align: center; text-transform: uppercase; border-bottom: 1px solid #333; padding-bottom: 4px; }
                .cgv-content { font-size: 6.5px; line-height: 1.3; column-count: 2; column-gap: 12px; text-align: justify; orphans: 3; widows: 3; }
                .cgv-content .article { margin-bottom: 6px; break-inside: avoid; }
                .cgv-content .article-title { font-weight: bold; font-size: 7px; margin-bottom: 2px; color: #333; text-transform: uppercase; }
            </style>
        </head>
        <body>
            <!-- Recto: Devis -->
            <div class="devis-page">
                <div style="display:flex;justify-content:space-between;margin-bottom:20px">
                    <div>
                        ${data.logo ? `<img src="${data.logo}" style="max-height:50px;margin-bottom:8px"><h2>${data.entreprise.nom}</h2>` : `<h2>${data.entreprise.nom}</h2>`}
                        <p style="font-size:10px;margin:5px 0">${data.entreprise.adresse}<br>${data.entreprise.codePostal} ${data.entreprise.ville}<br>T√©l: ${data.entreprise.telephone}</p>
                    </div>
                    <div style="text-align:right">
                        <h1>DEVIS</h1>
                        <p style="font-size:14px;font-weight:bold;margin:5px 0">${d.numero}</p>
                        <p style="font-size:10px">Date: ${formatDate(d.date)}<br>Validit√©: ${formatDate(d.dateEcheance)}</p>
                    </div>
                </div>
                <div style="background:#f5f5f5;padding:10px;margin-bottom:15px;font-size:10px">
                    <strong>DESTINATAIRE</strong><br>${client?.nom || '-'}<br>${client?.adresse || ''}<br>${client?.codePostal || ''} ${client?.ville || ''}
                </div>
                <table>
                    <thead><tr><th>R√©f.</th><th>Description</th><th class="text-right">Prix HT</th><th style="text-align:center">Qt√©</th><th class="text-right">Total</th></tr></thead>
                    <tbody>${d.lignes.map(l => `<tr><td>${l.reference}</td><td>${l.description}</td><td class="text-right">${formatMoney(l.prixHT)}</td><td style="text-align:center">${l.quantite}</td><td class="text-right">${formatMoney(l.prixHT * l.quantite)}</td></tr>`).join('')}</tbody>
                </table>
                <div style="width:220px;margin-left:auto"><div style="display:flex;justify-content:space-between;padding:8px 0;border-top:2px solid #333;font-weight:bold;font-size:13px"><span>Total TTC</span><span>${formatMoney(d.totalTTC)}</span></div></div>
                ${data.entreprise.exonereTVA ? '<p style="font-style:italic;color:#666;font-size:10px">TVA non applicable, article 293B du CGI</p>' : ''}
                <p style="font-size:9px;color:#999;margin-top:20px">Devis valable 30 jours. Voir CGV au verso.</p>
            </div>
            <!-- Verso: CGV -->
            <div class="cgv-page">
                <div class="cgv-wrapper">
                    <div class="cgv-title">CONDITIONS G√âN√âRALES DE VENTE</div>
                    <div class="cgv-content">${formatCGVForPrint(data.cgv)}</div>
                </div>
            </div>
        </body>
        </html>
    `);
    printWindow.document.close();
    printWindow.print();
}

// ============================================
// ENVOI PAR EMAIL AVEC PDF
// ============================================
function sendFactureByEmail(numero) {
    const f = data.factures.find(x => x.numero === numero);
    const client = f.paiementComptoir ? null : getClient(f.clientId);
    
    // G√©n√©rer et t√©l√©charger le PDF
    generateFacturePDF(f, client, () => {
        // Ouvrir Gmail avec message pro
        const email = client?.email || '';
        const sujet = `Facture ${f.numero} - ${data.entreprise.nom}`;
        const corps = `Bonjour,

Veuillez trouver en pi√®ce jointe votre facture N¬∞ ${f.numero}.

Montant : ${formatMoney(f.totalTTC)} TTC
√âch√©ance : ${formatDate(f.dateEcheance)}

R√®glement par ${f.modeReglement} :
IBAN : ${data.entreprise.iban}
BIC : ${data.entreprise.bic}

Restant √† votre disposition,

${data.entreprise.nom}
${data.entreprise.telephone}`;

        const gmailUrl = `https://mail.google.com/mail/?view=cm&fs=1&to=${encodeURIComponent(email)}&su=${encodeURIComponent(sujet)}&body=${encodeURIComponent(corps)}`;
        window.open(gmailUrl, '_blank');
    });
}

function sendDevisByEmail(numero) {
    const d = data.devis.find(x => x.numero === numero);
    const client = getClient(d.clientId);
    
    // G√©n√©rer et t√©l√©charger le PDF
    generateDevisPDF(d, client, () => {
        // Ouvrir Gmail avec message pro
        const email = client?.email || '';
        const sujet = `Devis ${d.numero} - ${data.entreprise.nom}`;
        const corps = `Bonjour,

Suite √† votre demande, veuillez trouver en pi√®ce jointe notre devis N¬∞ ${d.numero}.

Montant : ${formatMoney(d.totalTTC)} TTC
Validit√© : 30 jours

N'h√©sitez pas √† me contacter pour toute question.

Cordialement,

${data.entreprise.nom}
${data.entreprise.telephone}`;

        const gmailUrl = `https://mail.google.com/mail/?view=cm&fs=1&to=${encodeURIComponent(email)}&su=${encodeURIComponent(sujet)}&body=${encodeURIComponent(corps)}`;
        window.open(gmailUrl, '_blank');
    });
}

function generateFacturePDF(f, client, callback) {
    const element = document.createElement('div');
    element.innerHTML = `
        <div style="font-family: Arial, sans-serif; padding: 20px; font-size: 12px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 30px;">
                <div>
                    ${data.logo ? `<img src="${data.logo}" style="max-height:60px;margin-bottom:10px"><br>` : ''}
                    <strong style="font-size:16px">${data.entreprise.nom}</strong><br>
                    ${data.entreprise.complement ? data.entreprise.complement + '<br>' : ''}
                    ${data.entreprise.adresse}<br>
                    ${data.entreprise.codePostal} ${data.entreprise.ville}<br>
                    T√©l: ${data.entreprise.telephone}<br><br>
                    Siret: ${data.entreprise.siret}<br>
                    IBAN: ${data.entreprise.iban}<br>
                    BIC: ${data.entreprise.bic}
                </div>
                <div style="text-align:right">
                    <h1 style="color:#f59e0b;margin:0;font-size:24px">FACTURE</h1>
                    <p style="font-size:16px;font-weight:bold">${f.numero}</p>
                    <p style="margin-top:15px">Date: ${formatDate(f.date)}<br>√âch√©ance: ${formatDate(f.dateEcheance)}</p>
                </div>
            </div>
            <div style="background:#f5f5f5;padding:15px;margin-bottom:20px">
                <strong>DESTINATAIRE</strong><br>
                ${f.paiementComptoir ? 'Paiement comptoir' : `${client?.nom || '-'}<br>${client?.adresse || ''}<br>${client?.codePostal || ''} ${client?.ville || ''}`}
            </div>
            <table style="width:100%;border-collapse:collapse;margin:15px 0">
                <thead>
                    <tr style="background:#f5f5f5">
                        <th style="border:1px solid #ddd;padding:8px;text-align:left">R√©f.</th>
                        <th style="border:1px solid #ddd;padding:8px;text-align:left">Description</th>
                        <th style="border:1px solid #ddd;padding:8px;text-align:right">Prix HT</th>
                        <th style="border:1px solid #ddd;padding:8px;text-align:center">Qt√©</th>
                        <th style="border:1px solid #ddd;padding:8px;text-align:right">Total HT</th>
                    </tr>
                </thead>
                <tbody>
                    ${f.lignes.map(l => `
                        <tr>
                            <td style="border:1px solid #ddd;padding:8px">${l.reference}</td>
                            <td style="border:1px solid #ddd;padding:8px">${l.description}</td>
                            <td style="border:1px solid #ddd;padding:8px;text-align:right">${formatMoney(l.prixHT)}</td>
                            <td style="border:1px solid #ddd;padding:8px;text-align:center">${l.quantite}</td>
                            <td style="border:1px solid #ddd;padding:8px;text-align:right">${formatMoney(l.prixHT * l.quantite)}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
            <div style="width:250px;margin-left:auto">
                <div style="display:flex;justify-content:space-between;padding:5px 0"><span>Total HT</span><span>${formatMoney(f.totalHT)}</span></div>
                ${f.remise > 0 ? `<div style="display:flex;justify-content:space-between;padding:5px 0;color:red"><span>Remise (${f.remise}%)</span><span>-${formatMoney(f.totalHT * f.remise / 100)}</span></div>` : ''}
                <div style="display:flex;justify-content:space-between;padding:10px 0;border-top:2px solid #333;font-weight:bold;font-size:14px"><span>Total TTC</span><span>${formatMoney(f.totalTTC)}</span></div>
            </div>
            ${data.entreprise.exonereTVA ? '<p style="font-style:italic;color:#666;margin-top:20px">TVA non applicable, article 293B du CGI</p>' : ''}
            <p style="margin-top:15px">Mode de r√®glement: ${f.modeReglement}</p>
        </div>
    `;
    
    document.body.appendChild(element);
    
    html2pdf().set({
        margin: 10,
        filename: `Facture_${f.numero}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    }).from(element).save().then(() => {
        document.body.removeChild(element);
        setTimeout(callback, 500);
    });
}

function generateDevisPDF(d, client, callback) {
    const element = document.createElement('div');
    element.innerHTML = `
        <div style="font-family: Arial, sans-serif; padding: 20px; font-size: 12px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 30px;">
                <div>
                    ${data.logo ? `<img src="${data.logo}" style="max-height:60px;margin-bottom:10px"><br>` : ''}
                    <strong style="font-size:16px">${data.entreprise.nom}</strong><br>
                    ${data.entreprise.adresse}<br>
                    ${data.entreprise.codePostal} ${data.entreprise.ville}<br>
                    T√©l: ${data.entreprise.telephone}
                </div>
                <div style="text-align:right">
                    <h1 style="color:#3b82f6;margin:0;font-size:24px">DEVIS</h1>
                    <p style="font-size:16px;font-weight:bold">${d.numero}</p>
                    <p style="margin-top:15px">Date: ${formatDate(d.date)}<br>Validit√©: ${formatDate(d.dateEcheance)}</p>
                </div>
            </div>
            <div style="background:#f5f5f5;padding:15px;margin-bottom:20px">
                <strong>DESTINATAIRE</strong><br>
                ${client?.nom || '-'}<br>${client?.adresse || ''}<br>${client?.codePostal || ''} ${client?.ville || ''}
            </div>
            <table style="width:100%;border-collapse:collapse;margin:15px 0">
                <thead>
                    <tr style="background:#f5f5f5">
                        <th style="border:1px solid #ddd;padding:8px;text-align:left">R√©f.</th>
                        <th style="border:1px solid #ddd;padding:8px;text-align:left">Description</th>
                        <th style="border:1px solid #ddd;padding:8px;text-align:right">Prix HT</th>
                        <th style="border:1px solid #ddd;padding:8px;text-align:center">Qt√©</th>
                        <th style="border:1px solid #ddd;padding:8px;text-align:right">Total HT</th>
                    </tr>
                </thead>
                <tbody>
                    ${d.lignes.map(l => `
                        <tr>
                            <td style="border:1px solid #ddd;padding:8px">${l.reference}</td>
                            <td style="border:1px solid #ddd;padding:8px">${l.description}</td>
                            <td style="border:1px solid #ddd;padding:8px;text-align:right">${formatMoney(l.prixHT)}</td>
                            <td style="border:1px solid #ddd;padding:8px;text-align:center">${l.quantite}</td>
                            <td style="border:1px solid #ddd;padding:8px;text-align:right">${formatMoney(l.prixHT * l.quantite)}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
            <div style="width:250px;margin-left:auto">
                <div style="display:flex;justify-content:space-between;padding:10px 0;border-top:2px solid #333;font-weight:bold;font-size:14px"><span>Total TTC</span><span>${formatMoney(d.totalTTC)}</span></div>
            </div>
            ${data.entreprise.exonereTVA ? '<p style="font-style:italic;color:#666;margin-top:20px">TVA non applicable, article 293B du CGI</p>' : ''}
            <p style="font-size:10px;color:#999;margin-top:30px">Devis valable 30 jours.</p>
        </div>
    `;
    
    document.body.appendChild(element);
    
    html2pdf().set({
        margin: 10,
        filename: `Devis_${d.numero}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    }).from(element).save().then(() => {
        document.body.removeChild(element);
        setTimeout(callback, 500);
    });
}

function convertDevisToFacture(numero) {
    const devis = data.devis.find(d => d.numero === numero);
    if (devis && confirm('Convertir ce devis en facture ?')) {
        const facture = JSON.parse(JSON.stringify(devis));
        facture.numero = generateNumber('F', data.factures);
        facture.date = new Date().toISOString().split('T')[0];
        facture.dateEcheance = new Date(Date.now() + 30*24*60*60*1000).toISOString().split('T')[0];
        data.factures.push(facture);
        saveData();
        alert('Facture ' + facture.numero + ' cr√©√©e !');
        navigateTo('factures');
    }
}

function deleteDevis(numero) {
    if (confirm('Supprimer ce devis ?')) {
        data.devis = data.devis.filter(d => d.numero !== numero);
        saveData();
        renderPage();
    }
}

// ============================================
// PAIEMENTS
// ============================================
function renderPaiements() {
    const totalFacture = data.factures.reduce((sum, f) => sum + (f.totalTTC || 0), 0);
    const paye = data.factures.filter(f => data.paiements?.find(p => p.numero === f.numero)?.paye);
    const totalPaye = paye.reduce((sum, f) => sum + (f.totalTTC || 0), 0);

    return `
        <div class="space-y-6">
            <h2 class="text-2xl font-bold text-stone-800">Suivi des Paiements</h2>
            <div class="grid grid-cols-3 gap-4">
                <div class="bg-white rounded-xl p-4 border"><p class="text-sm text-stone-500">Total factur√©</p><p class="text-2xl font-bold">${formatMoney(totalFacture)}</p></div>
                <div class="bg-emerald-50 rounded-xl p-4 border border-emerald-200"><p class="text-sm text-emerald-600">Encaiss√©</p><p class="text-2xl font-bold text-emerald-700">${formatMoney(totalPaye)}</p></div>
                <div class="bg-red-50 rounded-xl p-4 border border-red-200"><p class="text-sm text-red-600">Reste</p><p class="text-2xl font-bold text-red-700">${formatMoney(totalFacture - totalPaye)}</p></div>
            </div>
            <div class="bg-white rounded-2xl shadow-lg overflow-hidden border">
                <table class="w-full">
                    <thead class="bg-stone-100"><tr><th class="px-4 py-3 text-left">Facture</th><th class="px-4 py-3 text-left">Client</th><th class="px-4 py-3 text-left">Date</th><th class="px-4 py-3 text-left">√âch√©ance</th><th class="px-4 py-3 text-right">Montant</th><th class="px-4 py-3 text-center">Statut</th></tr></thead>
                    <tbody class="divide-y">
                        ${data.factures.map(f => {
                            const isPaye = data.paiements?.find(p => p.numero === f.numero)?.paye;
                            const isLate = !isPaye && new Date(f.dateEcheance) < new Date();
                            return `<tr class="${isPaye ? 'bg-emerald-50/50' : isLate ? 'bg-red-50/50' : ''}">
                                <td class="px-4 py-3 font-medium">${f.numero}</td>
                                <td class="px-4 py-3">${getClientName(f)}</td>
                                <td class="px-4 py-3">${formatDate(f.date)}</td>
                                <td class="px-4 py-3 ${isLate ? 'text-red-600 font-medium' : ''}">${formatDate(f.dateEcheance)} ${isLate ? '‚ö†Ô∏è' : ''}</td>
                                <td class="px-4 py-3 text-right font-medium">${formatMoney(f.totalTTC)}</td>
                                <td class="px-4 py-3 text-center">
                                    <button onclick="togglePaiement('${f.numero}')" class="px-3 py-1 rounded-full text-sm font-medium ${isPaye ? 'bg-emerald-100 text-emerald-700' : 'bg-red-100 text-red-700'}">
                                        ${isPaye ? '‚úì Pay√©' : 'Non pay√©'}
                                    </button>
                                </td>
                            </tr>`;
                        }).join('')}
                    </tbody>
                </table>
            </div>
        </div>
    `;
}

function togglePaiement(numero) {
    if (!data.paiements) data.paiements = [];
    const idx = data.paiements.findIndex(p => p.numero === numero);
    if (idx !== -1) data.paiements.splice(idx, 1);
    else data.paiements.push({ numero, paye: true, date: new Date().toISOString().split('T')[0] });
    saveData();
    renderPage();
}

// ============================================
// RELANCES
// ============================================
function renderRelances() {
    const today = new Date();
    const facturesImpayees = data.factures.filter(f => {
        const isPaye = data.paiements?.find(p => p.numero === f.numero)?.paye;
        return !isPaye;
    });
    const facturesEnRetard = facturesImpayees.filter(f => new Date(f.dateEcheance) < today);

    return `
        <div class="space-y-6">
            <h2 class="text-2xl font-bold text-stone-800">Lettres de Relance</h2>
            
            <div class="bg-amber-50 border border-amber-200 rounded-xl p-4">
                <h3 class="font-semibold text-amber-800 mb-2">üì¨ ${facturesEnRetard.length} facture(s) en retard de paiement</h3>
                <p class="text-sm text-amber-700">S√©lectionnez une facture pour g√©n√©rer une lettre de relance</p>
            </div>

            <div class="bg-white rounded-2xl shadow-lg overflow-hidden border">
                <table class="w-full">
                    <thead class="bg-stone-100">
                        <tr>
                            <th class="px-4 py-3 text-left">Facture</th>
                            <th class="px-4 py-3 text-left">Client</th>
                            <th class="px-4 py-3 text-left">√âch√©ance</th>
                            <th class="px-4 py-3 text-right">Montant</th>
                            <th class="px-4 py-3 text-center">Retard</th>
                            <th class="px-4 py-3 text-center">Relances</th>
                            <th class="px-4 py-3 text-right">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y">
                        ${facturesEnRetard.map(f => {
                            const client = getClient(f.clientId);
                            const joursRetard = Math.floor((today - new Date(f.dateEcheance)) / (1000 * 60 * 60 * 24));
                            const nbRelances = data.relances?.filter(r => r.factureNumero === f.numero).length || 0;
                            return `
                                <tr class="hover:bg-red-50/50">
                                    <td class="px-4 py-3 font-medium">${f.numero}</td>
                                    <td class="px-4 py-3">${client?.nom || '-'}</td>
                                    <td class="px-4 py-3 text-red-600">${formatDate(f.dateEcheance)}</td>
                                    <td class="px-4 py-3 text-right font-medium">${formatMoney(f.totalTTC)}</td>
                                    <td class="px-4 py-3 text-center"><span class="px-2 py-1 bg-red-100 text-red-700 rounded-full text-sm">${joursRetard} j</span></td>
                                    <td class="px-4 py-3 text-center">${nbRelances}</td>
                                    <td class="px-4 py-3 text-right space-x-1">
                                        <button onclick="previewRelance('${f.numero}', 1)" class="px-2 py-1 bg-amber-100 text-amber-700 rounded text-sm" title="1√®re relance">R1</button>
                                        <button onclick="previewRelance('${f.numero}', 2)" class="px-2 py-1 bg-orange-100 text-orange-700 rounded text-sm" title="2√®me relance">R2</button>
                                        <button onclick="previewRelance('${f.numero}', 3)" class="px-2 py-1 bg-red-100 text-red-700 rounded text-sm" title="Mise en demeure">MD</button>
                                    </td>
                                </tr>
                            `;
                        }).join('') || '<tr><td colspan="7" class="px-4 py-8 text-center text-stone-400">Aucune facture en retard üéâ</td></tr>'}
                    </tbody>
                </table>
            </div>

            ${data.relances?.length > 0 ? `
            <div class="bg-white rounded-2xl p-6 border">
                <h3 class="font-semibold text-stone-800 mb-4">Historique des relances</h3>
                <div class="space-y-2">
                    ${data.relances.slice(-10).reverse().map(r => `
                        <div class="flex justify-between items-center py-2 border-b border-stone-100">
                            <div><span class="font-medium">${r.factureNumero}</span> - ${r.clientNom}</div>
                            <div class="flex items-center gap-3">
                                <span class="text-sm text-stone-500">${formatDate(r.date)}</span>
                                <span class="px-2 py-1 ${r.type === 'email' ? 'bg-blue-100 text-blue-700' : 'bg-stone-100 text-stone-700'} rounded text-xs">${r.type === 'email' ? 'üìß Email' : 'üìÑ Courrier'}</span>
                                <span class="px-2 py-1 bg-amber-100 text-amber-700 rounded text-xs">Niveau ${r.niveau}</span>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
            ` : ''}
        </div>
    `;
}

function previewRelance(factureNumero, niveau) {
    const f = data.factures.find(x => x.numero === factureNumero);
    const client = getClient(f.clientId);
    const joursRetard = Math.floor((new Date() - new Date(f.dateEcheance)) / (1000 * 60 * 60 * 24));
    
    const titres = {
        1: 'PREMI√àRE RELANCE - Rappel de paiement',
        2: 'DEUXI√àME RELANCE - Facture impay√©e',
        3: 'MISE EN DEMEURE'
    };
    
    const textes = {
        1: `Madame, Monsieur,

Sauf erreur de notre part, nous n'avons pas re√ßu le r√®glement de la facture r√©f√©renc√©e ci-dessous, arriv√©e √† √©ch√©ance le ${formatDate(f.dateEcheance)}.

Facture n¬∞ : ${f.numero}
Montant : ${formatMoney(f.totalTTC)}
Date d'√©ch√©ance : ${formatDate(f.dateEcheance)}

Nous vous remercions de bien vouloir proc√©der au r√®glement de cette somme dans les meilleurs d√©lais.

Si votre r√®glement s'est crois√© avec ce courrier, nous vous prions de ne pas tenir compte de ce rappel.

Nous restons √† votre disposition pour tout renseignement compl√©mentaire.

Cordialement,
${data.entreprise.nom}`,

        2: `Madame, Monsieur,

Malgr√© notre pr√©c√©dent rappel, nous constatons que notre facture n'a toujours pas √©t√© r√©gl√©e.

Facture n¬∞ : ${f.numero}
Montant : ${formatMoney(f.totalTTC)}
Retard : ${joursRetard} jours

Nous vous mettons en demeure de proc√©der au r√®glement de cette somme sous 8 jours.

√Ä d√©faut de r√®glement dans ce d√©lai, nous nous verrons dans l'obligation d'engager des poursuites pour le recouvrement de notre cr√©ance, ce qui entra√Ænerait des frais suppl√©mentaires √† votre charge.

Cordialement,
${data.entreprise.nom}`,

        3: `Madame, Monsieur,

MISE EN DEMEURE

Par la pr√©sente, nous vous mettons en demeure de nous r√©gler la somme de ${formatMoney(f.totalTTC)} correspondant √† la facture n¬∞ ${f.numero} du ${formatDate(f.date)}, demeur√©e impay√©e malgr√© nos pr√©c√©dents rappels.

√Ä d√©faut de r√®glement dans un d√©lai de 8 jours √† compter de la r√©ception de ce courrier, nous transmettrons ce dossier √† notre service contentieux / notre avocat pour recouvrement judiciaire, sans autre avis de notre part.

Les frais de proc√©dure seront int√©gralement √† votre charge.

Fait pour servir et valoir ce que de droit.

${data.entreprise.nom}`
    };

    const content = `
        <div class="space-y-4">
            <div class="bg-${niveau === 3 ? 'red' : 'amber'}-50 border border-${niveau === 3 ? 'red' : 'amber'}-200 rounded-xl p-4">
                <h3 class="font-bold text-${niveau === 3 ? 'red' : 'amber'}-800">${titres[niveau]}</h3>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-stone-50 rounded-xl p-4">
                    <p class="text-sm text-stone-500">Exp√©diteur</p>
                    <p class="font-medium">${data.entreprise.nom}</p>
                    <p class="text-sm">${data.entreprise.adresse}<br>${data.entreprise.codePostal} ${data.entreprise.ville}</p>
                </div>
                <div class="bg-stone-50 rounded-xl p-4">
                    <p class="text-sm text-stone-500">Destinataire</p>
                    <p class="font-medium">${client?.nom || '-'}</p>
                    <p class="text-sm">${client?.adresse || ''}<br>${client?.codePostal || ''} ${client?.ville || ''}</p>
                    ${client?.email ? `<p class="text-sm text-blue-600">${client.email}</p>` : '<p class="text-sm text-red-500">‚ö†Ô∏è Pas d\'email</p>'}
                </div>
            </div>

            <div class="bg-white border rounded-xl p-6">
                <p class="text-right text-sm text-stone-500 mb-4">${data.entreprise.ville}, le ${formatDate(new Date().toISOString())}</p>
                <p class="mb-4">Objet : ${titres[niveau]}</p>
                <div class="whitespace-pre-line text-sm leading-relaxed">${textes[niveau]}</div>
            </div>
        </div>
        
        <div class="flex justify-between mt-6">
            <button onclick="closeModal()" class="px-4 py-2.5 bg-stone-100 text-stone-700 rounded-xl font-medium">Fermer</button>
            <div class="flex gap-3">
                ${client?.email ? `<button onclick="sendRelanceEmail('${f.numero}', ${niveau}, '${client.email}')" class="px-4 py-2.5 bg-blue-500 text-white rounded-xl font-medium">üìß Envoyer par email</button>` : ''}
                <button onclick="printRelance('${f.numero}', ${niveau})" class="btn-primary text-white px-4 py-2.5 rounded-xl font-medium">üñ®Ô∏è Imprimer</button>
            </div>
        </div>
    `;
    
    showModal(titres[niveau], content, 'max-w-3xl');
}

function sendRelanceEmail(factureNumero, niveau, email) {
    const f = data.factures.find(x => x.numero === factureNumero);
    const client = getClient(f.clientId);
    
    const sujets = {
        1: `Rappel de paiement - Facture ${f.numero}`,
        2: `Relance urgente - Facture impay√©e ${f.numero}`,
        3: `MISE EN DEMEURE - Facture ${f.numero}`
    };
    
    const corps = `Facture ${f.numero} - Montant: ${formatMoney(f.totalTTC)} - √âch√©ance: ${formatDate(f.dateEcheance)}`;
    
    // Ouvrir le client mail
    const mailtoLink = `mailto:${email}?subject=${encodeURIComponent(sujets[niveau])}&body=${encodeURIComponent(corps)}`;
    window.open(mailtoLink);
    
    // Enregistrer la relance
    if (!data.relances) data.relances = [];
    data.relances.push({
        factureNumero: f.numero,
        clientNom: client?.nom || '-',
        date: new Date().toISOString().split('T')[0],
        type: 'email',
        niveau: niveau
    });
    saveData();
    
    alert('Email pr√©par√© ! Votre client mail va s\'ouvrir.');
    closeModal();
    renderPage();
}

function printRelance(factureNumero, niveau) {
    const f = data.factures.find(x => x.numero === factureNumero);
    const client = getClient(f.clientId);
    const joursRetard = Math.floor((new Date() - new Date(f.dateEcheance)) / (1000 * 60 * 60 * 24));
    
    const titres = { 1: 'PREMI√àRE RELANCE', 2: 'DEUXI√àME RELANCE', 3: 'MISE EN DEMEURE' };
    const textes = {
        1: `Sauf erreur de notre part, nous n'avons pas re√ßu le r√®glement de la facture r√©f√©renc√©e ci-dessous.\n\nFacture n¬∞ : ${f.numero}\nMontant : ${formatMoney(f.totalTTC)}\n√âch√©ance : ${formatDate(f.dateEcheance)}\n\nNous vous remercions de bien vouloir proc√©der au r√®glement dans les meilleurs d√©lais.`,
        2: `Malgr√© notre pr√©c√©dent rappel, notre facture n'a toujours pas √©t√© r√©gl√©e.\n\nFacture n¬∞ : ${f.numero}\nMontant : ${formatMoney(f.totalTTC)}\nRetard : ${joursRetard} jours\n\nNous vous mettons en demeure de r√©gler sous 8 jours.`,
        3: `MISE EN DEMEURE\n\nNous vous mettons en demeure de nous r√©gler ${formatMoney(f.totalTTC)} correspondant √† la facture n¬∞ ${f.numero}.\n\n√Ä d√©faut sous 8 jours, nous transmettrons ce dossier au contentieux.`
    };

    const printWindow = window.open('', '', 'width=800,height=600');
    printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>Relance ${f.numero}</title>
            <style>
                body { font-family: Arial, sans-serif; padding: 40px; font-size: 12px; line-height: 1.6; }
                .header { margin-bottom: 50px; }
                .expediteur { margin-bottom: 30px; }
                .destinataire { margin-bottom: 30px; text-align: right; }
                .date { text-align: right; margin-bottom: 30px; }
                .objet { font-weight: bold; margin-bottom: 30px; ${niveau === 3 ? 'color: red;' : ''} }
                .corps { white-space: pre-line; }
                .signature { margin-top: 50px; }
            </style>
        </head>
        <body>
            <div class="header">
                <div class="expediteur">
                    ${data.logo ? `<img src="${data.logo}" style="max-height:50px;margin-bottom:10px"><br>` : `<strong>${data.entreprise.nom}</strong><br>`}
                    ${data.entreprise.adresse}<br>
                    ${data.entreprise.codePostal} ${data.entreprise.ville}<br>
                    T√©l: ${data.entreprise.telephone}
                </div>
                <div class="destinataire">
                    <strong>${client?.nom || '-'}</strong><br>
                    ${client?.adresse || ''}<br>
                    ${client?.codePostal || ''} ${client?.ville || ''}
                </div>
                <div class="date">${data.entreprise.ville}, le ${formatDate(new Date().toISOString())}</div>
            </div>
            <div class="objet">Objet : ${titres[niveau]}</div>
            <div class="corps">Madame, Monsieur,\n\n${textes[niveau]}\n\nCordialement,</div>
            <div class="signature">${data.entreprise.nom}</div>
        </body>
        </html>
    `);
    printWindow.document.close();
    printWindow.print();

    // Enregistrer
    if (!data.relances) data.relances = [];
    data.relances.push({
        factureNumero: f.numero,
        clientNom: client?.nom || '-',
        date: new Date().toISOString().split('T')[0],
        type: 'courrier',
        niveau: niveau
    });
    saveData();
}

// ============================================
// CHIFFRE D'AFFAIRES
// ============================================
function renderCA() {
    const mois = ['Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'];

    const caParMois = mois.map((nom, i) => {
        const yearMonth = `${caYear}-${String(i + 1).padStart(2, '0')}`;
        const facturesMois = data.factures.filter(f => {
            const d = new Date(f.date);
            return d.getFullYear() === caYear && d.getMonth() === i;
        });
        const ca = facturesMois.reduce((sum, f) => sum + (f.totalHT || 0), 0);
        const taux = getTauxURSSAF(yearMonth);
        return { mois: nom, yearMonth, ca, nbFactures: facturesMois.length, taux };
    });

    const totalAnnee = caParMois.reduce((sum, m) => sum + m.ca, 0);
    const totalCotisations = caParMois.reduce((sum, m) => sum + (m.ca * m.taux / 100), 0);
    const maxCA = Math.max(...caParMois.map(m => m.ca), 1);

    return `
        <div class="space-y-6">
            <div class="flex items-center justify-between">
                <h2 class="text-2xl font-bold text-stone-800">Chiffre d'Affaires ${caYear}</h2>
                <div class="flex items-center gap-2">
                    <button onclick="caYear--; renderPage()" class="p-2 hover:bg-stone-200 rounded-lg text-xl">‚óÄ</button>
                    <span class="text-lg font-semibold w-20 text-center">${caYear}</span>
                    <button onclick="caYear++; renderPage()" class="p-2 hover:bg-stone-200 rounded-lg text-xl">‚ñ∂</button>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div class="bg-gradient-to-br from-amber-500 to-orange-500 text-white rounded-2xl p-6 shadow-lg">
                    <p class="text-amber-100">CA Total ${caYear}</p>
                    <p class="text-4xl font-bold mt-2">${formatMoney(totalAnnee)}</p>
                </div>
                <div class="bg-gradient-to-br from-stone-700 to-stone-800 text-white rounded-2xl p-6 shadow-lg">
                    <p class="text-stone-300">Cotisations URSSAF estim√©es</p>
                    <p class="text-4xl font-bold mt-2">${formatMoney(totalCotisations)}</p>
                </div>
            </div>

            <div class="bg-blue-50 border border-blue-200 rounded-xl p-4">
                <p class="text-sm text-blue-800">üí° <strong>Taux URSSAF par mois :</strong> Cliquez sur le taux pour le modifier individuellement. Le taux par d√©faut est ${(data.tauxURSSAFParMois['default'] || 23.20).toFixed(2).replace('.', ',')}%</p>
            </div>

            <div class="bg-white rounded-2xl shadow-lg overflow-hidden border">
                <table class="w-full">
                    <thead class="bg-stone-100">
                        <tr>
                            <th class="px-4 py-3 text-left">Mois</th>
                            <th class="px-4 py-3 text-right">CA HT</th>
                            <th class="px-4 py-3 text-center">Taux URSSAF</th>
                            <th class="px-4 py-3 text-right">Cotisations</th>
                            <th class="px-4 py-3 text-center">Factures</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y">
                        ${caParMois.map(m => `
                            <tr class="${m.ca > 0 ? 'bg-amber-50/30' : ''} hover:bg-amber-50/50">
                                <td class="px-4 py-3 font-medium">${m.mois}</td>
                                <td class="px-4 py-3 text-right font-medium">${formatMoney(m.ca)}</td>
                                <td class="px-4 py-3 text-center">
                                    <button onclick="editTauxMois('${m.yearMonth}', ${m.taux})" class="px-3 py-1 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 font-medium">
                                        ${m.taux.toFixed(2).replace('.', ',')}%
                                    </button>
                                </td>
                                <td class="px-4 py-3 text-right text-stone-600">${formatMoney(m.ca * m.taux / 100)}</td>
                                <td class="px-4 py-3 text-center">${m.nbFactures}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                    <tfoot class="bg-stone-100 font-bold">
                        <tr>
                            <td class="px-4 py-3">TOTAL</td>
                            <td class="px-4 py-3 text-right">${formatMoney(totalAnnee)}</td>
                            <td class="px-4 py-3 text-center">-</td>
                            <td class="px-4 py-3 text-right">${formatMoney(totalCotisations)}</td>
                            <td class="px-4 py-3 text-center">${data.factures.filter(f => new Date(f.date).getFullYear() === caYear).length}</td>
                        </tr>
                    </tfoot>
                </table>
            </div>

            <div class="grid grid-cols-4 gap-4">
                ${[0, 1, 2, 3].map(q => {
                    const caT = caParMois.slice(q * 3, q * 3 + 3).reduce((sum, m) => sum + m.ca, 0);
                    const cotisT = caParMois.slice(q * 3, q * 3 + 3).reduce((sum, m) => sum + (m.ca * m.taux / 100), 0);
                    const trimLabels = ['1er trimestre', '2√®me trimestre', '3√®me trimestre', '4√®me trimestre'];
                    return `<div class="bg-white rounded-xl p-4 border shadow-sm">
                        <p class="text-sm text-stone-500">${trimLabels[q]} ${caYear}</p>
                        <p class="text-xl font-bold text-stone-800">${formatMoney(caT)}</p>
                        <p class="text-sm text-stone-500">Cotisations : ${formatMoney(cotisT)}</p>
                    </div>`;
                }).join('')}
            </div>

            <!-- Graphique √† barres -->
            <div class="bg-white rounded-2xl shadow-lg p-6 border">
                <h3 class="text-lg font-bold text-stone-800 mb-4">üìä √âvolution du Chiffre d'Affaires ${caYear}</h3>
                <div class="relative" style="height: 300px;">
                    <!-- Lignes de grille horizontales -->
                    <div class="absolute inset-0 flex flex-col justify-between pointer-events-none">
                        ${[...Array(6)].map((_, i) => `
                            <div class="flex items-center w-full border-b border-stone-200">
                                <span class="text-xs text-stone-400 w-16 text-right pr-2">${formatMoney(maxCA * (5-i) / 5)}</span>
                            </div>
                        `).join('')}
                    </div>
                    <!-- Barres -->
                    <div class="absolute bottom-6 left-16 right-4 top-0 flex items-end justify-around gap-1">
                        ${caParMois.map(m => {
                            const heightPct = maxCA > 0 ? (m.ca / maxCA * 100) : 0;
                            const hasData = m.ca > 0;
                            return `
                                <div class="flex flex-col items-center flex-1" style="height: 100%;">
                                    <div class="flex-1 w-full flex flex-col justify-end items-center">
                                        ${hasData ? `<span class="text-xs font-semibold text-stone-700 mb-1">${m.ca.toFixed(2).replace('.', ',')}‚Ç¨</span>` : ''}
                                        <div class="w-full max-w-12 rounded-t-lg transition-all ${hasData ? 'bg-gradient-to-t from-blue-600 to-blue-400' : 'bg-stone-200'}" 
                                             style="height: ${hasData ? Math.max(heightPct, 2) : 2}%;">
                                        </div>
                                    </div>
                                    <span class="text-xs text-stone-600 mt-2 font-medium">${m.mois.substring(0, 3).toUpperCase()}</span>
                                </div>
                            `;
                        }).join('')}
                        <!-- Barre Total -->
                        <div class="flex flex-col items-center flex-1 ml-4 pl-4 border-l-2 border-stone-300" style="height: 100%;">
                            <div class="flex-1 w-full flex flex-col justify-end items-center">
                                <span class="text-xs font-bold text-amber-700 mb-1">${totalAnnee.toFixed(2).replace('.', ',')}‚Ç¨</span>
                                <div class="w-full max-w-12 rounded-t-lg bg-gradient-to-t from-amber-500 to-orange-400" 
                                     style="height: ${maxCA > 0 ? Math.min(totalAnnee / maxCA * 100, 100) : 0}%;">
                                </div>
                            </div>
                            <span class="text-xs text-amber-700 mt-2 font-bold">TOTAL</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
}

function editTauxMois(yearMonth, currentTaux) {
    const moisNom = new Date(yearMonth + '-01').toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' });
    const content = `
        <div class="space-y-4">
            <p>Modifier le taux URSSAF pour <strong>${moisNom}</strong></p>
            <div>
                <label class="block text-sm font-medium text-stone-600 mb-1">Taux (%)</label>
                <input type="number" step="0.01" id="taux-mois" value="${currentTaux}" class="w-full px-4 py-2.5 border border-stone-300 rounded-xl">
            </div>
            <div class="bg-blue-50 border border-blue-200 rounded-xl p-3 text-sm text-blue-800">
                <p><strong>Rappel des taux courants :</strong></p>
                <ul class="mt-1 space-y-1">
                    <li>‚Ä¢ Vente de marchandises : 12,30%</li>
                    <li>‚Ä¢ Prestations de services BIC : 21,20%</li>
                    <li>‚Ä¢ Prestations de services BNC : 21,10%</li>
                    <li>‚Ä¢ Activit√©s lib√©rales : 21,10%</li>
                </ul>
            </div>
        </div>
        <div class="flex justify-end gap-3 mt-6">
            <button onclick="closeModal()" class="px-4 py-2.5 bg-stone-100 text-stone-700 rounded-xl font-medium">Annuler</button>
            <button onclick="saveTauxMois('${yearMonth}')" class="btn-primary text-white px-4 py-2.5 rounded-xl font-medium">Enregistrer</button>
        </div>
    `;
    showModal('Taux URSSAF - ' + moisNom, content, 'max-w-md');
}

function saveTauxMois(yearMonth) {
    const taux = parseFloat(document.getElementById('taux-mois').value) || 0;
    setTauxURSSAF(yearMonth, taux);
    closeModal();
    renderPage();
}

// ============================================
// REGISTRE D'ACHATS
// ============================================
let achatsYear = new Date().getFullYear();

function renderAchats() {
    if (!data.achats) data.achats = [];
    
    const moisNoms = ['Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'];
    
    // Calcul des achats par mois pour l'ann√©e s√©lectionn√©e
    const achatsParMois = moisNoms.map((nom, idx) => {
        const mois = String(idx + 1).padStart(2, '0');
        const yearMonth = `${achatsYear}-${mois}`;
        const achatsM = data.achats.filter(a => a.date && a.date.startsWith(yearMonth));
        const total = achatsM.reduce((sum, a) => sum + (a.montant || 0), 0);
        return { mois: nom, total, count: achatsM.length, yearMonth };
    });
    
    const totalAnnee = achatsParMois.reduce((sum, m) => sum + m.total, 0);
    const maxAchats = Math.max(...achatsParMois.map(m => m.total), 1);
    
    // Tous les achats tri√©s par date desc
    const tousAchats = [...data.achats].sort((a, b) => new Date(b.date) - new Date(a.date));

    return `
        <div class="space-y-6">
            <div class="flex items-center justify-between">
                <h2 class="text-2xl font-bold text-stone-800">üõí Registre d'achats</h2>
                <button onclick="newAchat()" class="btn-primary text-white px-4 py-2.5 rounded-xl font-medium flex items-center gap-2">
                    <span class="text-xl">+</span> Nouvel achat
                </button>
            </div>
            
            <!-- S√©lecteur d'ann√©e et Total -->
            <div class="bg-gradient-to-br from-red-500 to-pink-500 text-white rounded-2xl p-6 shadow-lg">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-3">
                        <span class="text-3xl">üí∏</span>
                        <span class="text-red-100">Total Achats</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="achatsYear--; renderPage();" class="bg-white/20 hover:bg-white/30 px-3 py-1 rounded-lg">‚óÄ</button>
                        <span class="text-2xl font-bold px-4">${achatsYear}</span>
                        <button onclick="achatsYear++; renderPage();" class="bg-white/20 hover:bg-white/30 px-3 py-1 rounded-lg">‚ñ∂</button>
                    </div>
                </div>
                <p class="text-4xl font-bold">${formatMoney(totalAnnee)}</p>
                <p class="text-red-100 text-sm mt-1">${data.achats.filter(a => a.date && a.date.startsWith(achatsYear)).length} achat(s) en ${achatsYear}</p>
            </div>
            
            <!-- Tableau par mois -->
            <div class="bg-white rounded-2xl shadow-lg border overflow-hidden">
                <div class="p-4 border-b bg-stone-50">
                    <h3 class="font-semibold text-stone-700">üìÖ D√©tail par mois - ${achatsYear}</h3>
                </div>
                <table class="w-full">
                    <thead class="bg-stone-50 border-b">
                        <tr>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-stone-600">Mois</th>
                            <th class="px-4 py-3 text-right text-sm font-semibold text-stone-600">Nb achats</th>
                            <th class="px-4 py-3 text-right text-sm font-semibold text-stone-600">Total TTC</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-stone-600 w-1/3">Graphique</th>
                            <th class="px-4 py-3 text-center text-sm font-semibold text-stone-600">D√©tail</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-stone-100">
                        ${achatsParMois.map((m, idx) => `
                            <tr class="hover:bg-red-50 transition-colors ${m.total > 0 ? '' : 'opacity-50'}">
                                <td class="px-4 py-3 font-medium">${m.mois}</td>
                                <td class="px-4 py-3 text-right">${m.count}</td>
                                <td class="px-4 py-3 text-right font-medium ${m.total > 0 ? 'text-red-600' : 'text-stone-400'}">${formatMoney(m.total)}</td>
                                <td class="px-4 py-3">
                                    <div class="h-4 bg-stone-100 rounded-full overflow-hidden">
                                        <div class="h-full bg-gradient-to-r from-red-400 to-pink-500 rounded-full" style="width: ${maxAchats > 0 ? (m.total / maxAchats * 100) : 0}%"></div>
                                    </div>
                                </td>
                                <td class="px-4 py-3 text-center">
                                    ${m.count > 0 ? `<button onclick="voirAchatsMois('${m.yearMonth}')" class="text-blue-500 hover:text-blue-700" title="Voir d√©tail">üîç</button>` : '-'}
                                </td>
                            </tr>
                        `).join('')}
                        <tr class="bg-red-50 font-bold">
                            <td class="px-4 py-3">TOTAL ${achatsYear}</td>
                            <td class="px-4 py-3 text-right">${achatsParMois.reduce((s, m) => s + m.count, 0)}</td>
                            <td class="px-4 py-3 text-right text-red-700">${formatMoney(totalAnnee)}</td>
                            <td class="px-4 py-3" colspan="2"></td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Graphique barres -->
            <div class="bg-white rounded-2xl shadow-lg border p-6">
                <h3 class="font-semibold text-stone-700 mb-4">üìä √âvolution des achats ${achatsYear}</h3>
                <div class="flex items-end gap-2 h-48">
                    ${achatsParMois.map((m, idx) => `
                        <div class="flex flex-col items-center flex-1" style="height: 100%;">
                            <div class="flex-1 w-full flex flex-col justify-end items-center">
                                ${m.total > 0 ? `<span class="text-xs text-red-600 mb-1">${m.total.toFixed(0)}‚Ç¨</span>` : ''}
                                <div class="w-full max-w-8 rounded-t-lg bg-gradient-to-t from-red-500 to-pink-400" 
                                     style="height: ${maxAchats > 0 ? (m.total / maxAchats * 100) : 0}%; min-height: ${m.total > 0 ? '4px' : '0'};">
                                </div>
                            </div>
                            <span class="text-xs text-stone-500 mt-2">${m.mois.substring(0, 3)}</span>
                        </div>
                    `).join('')}
                </div>
            </div>
            
            <!-- Liste des derniers achats -->
            <div class="bg-white rounded-2xl shadow-lg border overflow-hidden">
                <div class="p-4 border-b bg-stone-50 flex justify-between items-center">
                    <h3 class="font-semibold text-stone-700">üìã Derniers achats</h3>
                </div>
                <table class="w-full">
                    <thead class="bg-stone-50 border-b">
                        <tr>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-stone-600">Date</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-stone-600">Nature</th>
                            <th class="px-4 py-3 text-right text-sm font-semibold text-stone-600">Montant</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-stone-600">Fournisseur</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-stone-600">R√®glement</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-stone-600">Justificatif</th>
                            <th class="px-4 py-3 text-center text-sm font-semibold text-stone-600">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-stone-100">
                        ${tousAchats.length === 0 ? `
                            <tr><td colspan="7" class="px-4 py-8 text-center text-stone-400">Aucun achat enregistr√©</td></tr>
                        ` : tousAchats.slice(0, 20).map(a => `
                            <tr class="hover:bg-red-50 transition-colors">
                                <td class="px-4 py-3 text-sm">${formatDate(a.date)}</td>
                                <td class="px-4 py-3 text-sm font-medium capitalize">${a.nature || '-'}</td>
                                <td class="px-4 py-3 text-sm text-right font-medium text-red-600">${formatMoney(a.montant)}</td>
                                <td class="px-4 py-3 text-sm capitalize">${a.fournisseur || '-'}</td>
                                <td class="px-4 py-3 text-sm uppercase">${a.modeReglement || '-'}</td>
                                <td class="px-4 py-3 text-sm text-stone-500">${a.justificatif || '-'}</td>
                                <td class="px-4 py-3 text-center">
                                    <button onclick="editAchat('${a.id}')" class="text-blue-500 hover:text-blue-700 mr-2" title="Modifier">‚úèÔ∏è</button>
                                    <button onclick="deleteAchat('${a.id}')" class="text-red-500 hover:text-red-700" title="Supprimer">üóëÔ∏è</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                ${tousAchats.length > 20 ? `<div class="p-3 text-center text-stone-500 text-sm border-t">Affichage des 20 derniers achats sur ${tousAchats.length}</div>` : ''}
            </div>
        </div>
    `;
}

function voirAchatsMois(yearMonth) {
    const achats = data.achats.filter(a => a.date && a.date.startsWith(yearMonth)).sort((a, b) => new Date(a.date) - new Date(b.date));
    const total = achats.reduce((sum, a) => sum + (a.montant || 0), 0);
    const moisNom = new Date(yearMonth + '-01').toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' });
    
    const content = `
        <div class="max-h-96 overflow-y-auto">
            <table class="w-full">
                <thead class="bg-stone-50 sticky top-0">
                    <tr>
                        <th class="px-3 py-2 text-left text-sm">Date</th>
                        <th class="px-3 py-2 text-left text-sm">Nature</th>
                        <th class="px-3 py-2 text-right text-sm">Montant</th>
                        <th class="px-3 py-2 text-left text-sm">Fournisseur</th>
                    </tr>
                </thead>
                <tbody class="divide-y">
                    ${achats.map(a => `
                        <tr class="hover:bg-red-50">
                            <td class="px-3 py-2 text-sm">${formatDate(a.date)}</td>
                            <td class="px-3 py-2 text-sm capitalize">${a.nature}</td>
                            <td class="px-3 py-2 text-sm text-right text-red-600 font-medium">${formatMoney(a.montant)}</td>
                            <td class="px-3 py-2 text-sm capitalize">${a.fournisseur}</td>
                        </tr>
                    `).join('')}
                </tbody>
                <tfoot class="bg-red-50 font-bold">
                    <tr>
                        <td class="px-3 py-2" colspan="2">TOTAL</td>
                        <td class="px-3 py-2 text-right text-red-700">${formatMoney(total)}</td>
                        <td class="px-3 py-2">${achats.length} achat(s)</td>
                    </tr>
                </tfoot>
            </table>
        </div>
        <div class="flex justify-end mt-4">
            <button onclick="closeModal()" class="px-4 py-2 bg-stone-100 text-stone-700 rounded-xl">Fermer</button>
        </div>
    `;
    showModal(`üìÖ Achats ${moisNom}`, content, 'max-w-2xl');
}

function newAchat() {
    const maxId = data.achats?.length > 0 ? Math.max(...data.achats.map(a => parseInt(a.id.replace('A', '')) || 0)) : 0;
    const nextId = 'A' + String(maxId + 1).padStart(3, '0');
    const today = new Date().toISOString().split('T')[0];
    
    const content = `
        <div class="space-y-4">
            <input type="hidden" id="achat-id" value="${nextId}">
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-stone-600 mb-1">Date *</label>
                    <input type="date" id="achat-date" value="${today}" class="w-full px-4 py-2.5 border border-stone-300 rounded-xl">
                </div>
                <div>
                    <label class="block text-sm font-medium text-stone-600 mb-1">Montant TTC *</label>
                    <input type="number" step="0.01" id="achat-montant" placeholder="0.00" class="w-full px-4 py-2.5 border border-stone-300 rounded-xl">
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium text-stone-600 mb-1">Nature de l'achat *</label>
                <input type="text" id="achat-nature" placeholder="Ex: fourniture, encre, mat√©riel..." class="w-full px-4 py-2.5 border border-stone-300 rounded-xl">
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-stone-600 mb-1">Mode de r√®glement</label>
                    <select id="achat-mode" class="w-full px-4 py-2.5 border border-stone-300 rounded-xl">
                        <option value="cb">CB</option>
                        <option value="esp√®ces">Esp√®ces</option>
                        <option value="virement">Virement</option>
                        <option value="paypal">PayPal</option>
                        <option value="ch√®que">Ch√®que</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-stone-600 mb-1">Fournisseur</label>
                    <input type="text" id="achat-fournisseur" placeholder="Nom du fournisseur" class="w-full px-4 py-2.5 border border-stone-300 rounded-xl">
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium text-stone-600 mb-1">Justificatif de paiement</label>
                <input type="text" id="achat-justificatif" placeholder="Ex: ticket caisse, facture n¬∞..." class="w-full px-4 py-2.5 border border-stone-300 rounded-xl">
            </div>
        </div>
        <div class="flex justify-end gap-3 mt-6">
            <button onclick="closeModal()" class="px-4 py-2.5 bg-stone-100 text-stone-700 rounded-xl font-medium">Annuler</button>
            <button onclick="saveAchat()" class="btn-primary text-white px-4 py-2.5 rounded-xl font-medium">Enregistrer</button>
        </div>
    `;
    showModal('Nouvel achat', content, 'max-w-lg');
}

function editAchat(id) {
    const a = data.achats.find(x => x.id === id);
    if (!a) return;
    
    const content = `
        <div class="space-y-4">
            <input type="hidden" id="achat-id" value="${a.id}">
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-stone-600 mb-1">Date *</label>
                    <input type="date" id="achat-date" value="${a.date}" class="w-full px-4 py-2.5 border border-stone-300 rounded-xl">
                </div>
                <div>
                    <label class="block text-sm font-medium text-stone-600 mb-1">Montant TTC *</label>
                    <input type="number" step="0.01" id="achat-montant" value="${a.montant}" class="w-full px-4 py-2.5 border border-stone-300 rounded-xl">
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium text-stone-600 mb-1">Nature de l'achat *</label>
                <input type="text" id="achat-nature" value="${a.nature || ''}" class="w-full px-4 py-2.5 border border-stone-300 rounded-xl">
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-stone-600 mb-1">Mode de r√®glement</label>
                    <select id="achat-mode" class="w-full px-4 py-2.5 border border-stone-300 rounded-xl">
                        <option value="cb" ${a.modeReglement === 'cb' ? 'selected' : ''}>CB</option>
                        <option value="esp√®ces" ${a.modeReglement === 'esp√®ces' ? 'selected' : ''}>Esp√®ces</option>
                        <option value="virement" ${a.modeReglement === 'virement' ? 'selected' : ''}>Virement</option>
                        <option value="paypal" ${a.modeReglement === 'paypal' ? 'selected' : ''}>PayPal</option>
                        <option value="ch√®que" ${a.modeReglement === 'ch√®que' ? 'selected' : ''}>Ch√®que</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-stone-600 mb-1">Fournisseur</label>
                    <input type="text" id="achat-fournisseur" value="${a.fournisseur || ''}" class="w-full px-4 py-2.5 border border-stone-300 rounded-xl">
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium text-stone-600 mb-1">Justificatif de paiement</label>
                <input type="text" id="achat-justificatif" value="${a.justificatif || ''}" class="w-full px-4 py-2.5 border border-stone-300 rounded-xl">
            </div>
        </div>
        <div class="flex justify-end gap-3 mt-6">
            <button onclick="closeModal()" class="px-4 py-2.5 bg-stone-100 text-stone-700 rounded-xl font-medium">Annuler</button>
            <button onclick="saveAchat()" class="btn-primary text-white px-4 py-2.5 rounded-xl font-medium">Enregistrer</button>
        </div>
    `;
    showModal('Modifier achat', content, 'max-w-lg');
}

function saveAchat() {
    const id = document.getElementById('achat-id').value;
    const date = document.getElementById('achat-date').value;
    const montant = parseFloat(document.getElementById('achat-montant').value) || 0;
    const nature = document.getElementById('achat-nature').value.trim();
    const modeReglement = document.getElementById('achat-mode').value;
    const fournisseur = document.getElementById('achat-fournisseur').value.trim();
    const justificatif = document.getElementById('achat-justificatif').value.trim();
    
    if (!date || !nature || montant <= 0) {
        alert('Veuillez remplir les champs obligatoires (Date, Nature, Montant)');
        return;
    }
    
    if (!data.achats) data.achats = [];
    
    const achat = { id, date, montant, nature, modeReglement, fournisseur, justificatif };
    
    const idx = data.achats.findIndex(x => x.id === id);
    if (idx !== -1) {
        data.achats[idx] = achat;
    } else {
        data.achats.push(achat);
    }
    
    saveData();
    closeModal();
    renderPage();
}

function deleteAchat(id) {
    if (confirm('Supprimer cet achat ?')) {
        data.achats = data.achats.filter(a => a.id !== id);
        saveData();
        renderPage();
    }
}

// ============================================
// PARAM√àTRES
// ============================================
function renderSettings() {
    const e = data.entreprise;
    return `
        <div class="space-y-6 max-w-4xl">
            <div class="flex items-center justify-between">
                <h2 class="text-2xl font-bold text-stone-800">‚öôÔ∏è Param√®tres</h2>
                <span class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-sm">üîì Mode Admin</span>
            </div>
            
            <!-- Version et Mot de passe Admin -->
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-white rounded-2xl shadow-lg p-6 border">
                    <h3 class="font-semibold text-stone-700 mb-3">üî¢ Version de l'application</h3>
                    <div class="flex items-center gap-4">
                        <div class="flex items-center gap-1">
                            <input type="number" id="version-major" value="${data.version.split('.')[0]}" min="0" class="w-16 px-2 py-2 border border-stone-300 rounded-lg text-center text-lg font-bold">
                            <span class="text-2xl text-stone-400">.</span>
                            <input type="number" id="version-minor" value="${data.version.split('.')[1]}" min="0" class="w-16 px-2 py-2 border border-stone-300 rounded-lg text-center text-lg font-bold">
                            <span class="text-2xl text-stone-400">.</span>
                            <input type="number" id="version-patch" value="${data.version.split('.')[2]}" min="0" class="w-16 px-2 py-2 border border-stone-300 rounded-lg text-center text-lg font-bold">
                        </div>
                        <button onclick="saveVersionDirect()" class="btn-primary text-white px-4 py-2 rounded-lg">üíæ</button>
                    </div>
                </div>
                <div class="bg-white rounded-2xl shadow-lg p-6 border">
                    <h3 class="font-semibold text-stone-700 mb-3">üîê Mot de passe Admin</h3>
                    <button onclick="openChangePasswordModal()" class="w-full px-4 py-2.5 bg-stone-100 text-stone-700 rounded-xl font-medium hover:bg-stone-200">
                        Changer le mot de passe
                    </button>
                    <p class="text-xs text-stone-500 mt-2">Prot√®ge l'acc√®s √† cette page</p>
                </div>
            </div>
            
            <!-- Logo -->
            <div class="bg-white rounded-2xl shadow-lg p-6 border">
                <h3 class="font-semibold text-stone-700 mb-4">üñºÔ∏è Logo de l'entreprise</h3>
                <div class="flex items-center gap-6">
                    <div class="w-48 h-24 border-2 border-dashed border-stone-300 rounded-xl flex items-center justify-center bg-stone-50">
                        ${data.logo ? `<img src="${data.logo}" class="max-h-20 max-w-44">` : `<span class="text-stone-400">Aucun logo</span>`}
                    </div>
                    <div class="space-y-2">
                        <input type="file" id="logo-input" accept="image/*" onchange="uploadLogo(event)" class="hidden">
                        <button onclick="document.getElementById('logo-input').click()" class="btn-primary text-white px-4 py-2 rounded-lg">üì§ Charger un logo</button>
                        ${data.logo ? `<button onclick="removeLogo()" class="block text-red-500 text-sm hover:underline">Supprimer le logo</button>` : ''}
                        <p class="text-xs text-stone-500">Format recommand√© : PNG ou JPG, max 200x80px</p>
                    </div>
                </div>
            </div>

            <!-- Entreprise -->
            <div class="bg-white rounded-2xl shadow-lg p-6 border space-y-6">
                <h3 class="font-semibold text-stone-700 border-b pb-2">üè¢ Informations entreprise</h3>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm font-medium text-stone-600 mb-1">Nom</label>
                        <input type="text" id="ent-nom" value="${e.nom}" class="w-full px-4 py-2.5 border border-stone-300 rounded-xl"></div>
                    <div><label class="block text-sm font-medium text-stone-600 mb-1">Compl√©ment</label>
                        <input type="text" id="ent-complement" value="${e.complement}" class="w-full px-4 py-2.5 border border-stone-300 rounded-xl"></div>
                    <div class="col-span-2"><label class="block text-sm font-medium text-stone-600 mb-1">Adresse</label>
                        <input type="text" id="ent-adresse" value="${e.adresse}" class="w-full px-4 py-2.5 border border-stone-300 rounded-xl"></div>
                    <div><label class="block text-sm font-medium text-stone-600 mb-1">Code postal</label>
                        <input type="text" id="ent-cp" value="${e.codePostal}" class="w-full px-4 py-2.5 border border-stone-300 rounded-xl"></div>
                    <div><label class="block text-sm font-medium text-stone-600 mb-1">Ville</label>
                        <input type="text" id="ent-ville" value="${e.ville}" class="w-full px-4 py-2.5 border border-stone-300 rounded-xl"></div>
                    <div><label class="block text-sm font-medium text-stone-600 mb-1">T√©l√©phone</label>
                        <input type="text" id="ent-tel" value="${e.telephone}" class="w-full px-4 py-2.5 border border-stone-300 rounded-xl"></div>
                    <div><label class="block text-sm font-medium text-stone-600 mb-1">Email</label>
                        <input type="email" id="ent-email" value="${e.email || ''}" class="w-full px-4 py-2.5 border border-stone-300 rounded-xl"></div>
                </div>
                
                <h3 class="font-semibold text-stone-700 border-b pb-2 pt-4">üìã Informations l√©gales</h3>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm font-medium text-stone-600 mb-1">SIRET</label>
                        <input type="text" id="ent-siret" value="${e.siret}" class="w-full px-4 py-2.5 border border-stone-300 rounded-xl"></div>
                    <div><label class="block text-sm font-medium text-stone-600 mb-1">RCS / Code APE</label>
                        <input type="text" id="ent-rcs" value="${e.rcs}" class="w-full px-4 py-2.5 border border-stone-300 rounded-xl"></div>
                </div>
                
                <h3 class="font-semibold text-stone-700 border-b pb-2 pt-4">üè¶ Coordonn√©es bancaires</h3>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm font-medium text-stone-600 mb-1">IBAN</label>
                        <input type="text" id="ent-iban" value="${e.iban}" class="w-full px-4 py-2.5 border border-stone-300 rounded-xl"></div>
                    <div><label class="block text-sm font-medium text-stone-600 mb-1">BIC</label>
                        <input type="text" id="ent-bic" value="${e.bic}" class="w-full px-4 py-2.5 border border-stone-300 rounded-xl"></div>
                </div>

                <h3 class="font-semibold text-stone-700 border-b pb-2 pt-4">üí∂ TVA et cotisations</h3>
                <label class="flex items-center gap-3 cursor-pointer">
                    <input type="checkbox" id="ent-exonere" ${e.exonereTVA ? 'checked' : ''} class="w-5 h-5 rounded text-amber-500">
                    <span>Exon√©r√© de TVA (micro-entreprise, article 293B du CGI)</span>
                </label>
                <div class="mt-4">
                    <label class="block text-sm font-medium text-stone-600 mb-1">Taux URSSAF par d√©faut (%)</label>
                    <input type="number" step="0.01" id="ent-urssaf-default" value="${data.tauxURSSAFParMois['default'] || 23.20}" class="w-40 px-4 py-2.5 border border-stone-300 rounded-xl">
                </div>

                <div class="flex justify-between pt-4">
                    <button onclick="resetData()" class="px-4 py-2.5 bg-red-500 text-white rounded-xl font-medium">üîÑ R√©initialiser</button>
                    <button onclick="saveSettings()" class="btn-primary text-white px-4 py-2.5 rounded-xl font-medium">‚úì Enregistrer</button>
                </div>
            </div>

            <!-- CGV -->
            <div class="bg-white rounded-2xl shadow-lg p-6 border">
                <h3 class="font-semibold text-stone-700 mb-4">üìú Conditions G√©n√©rales de Vente</h3>
                <textarea id="cgv-text" rows="15" class="w-full px-4 py-3 border border-stone-300 rounded-xl text-sm">${data.cgv}</textarea>
                <div class="flex justify-end mt-4">
                    <button onclick="saveCGV()" class="btn-primary text-white px-4 py-2.5 rounded-xl font-medium">Enregistrer les CGV</button>
                </div>
            </div>
        </div>
    `;
}

function saveVersionDirect() {
    const major = document.getElementById('version-major').value || '0';
    const minor = document.getElementById('version-minor').value || '0';
    const patch = document.getElementById('version-patch').value || '0';
    data.version = `${major}.${minor}.${patch}`;
    saveData();
    updateSidebarLogo();
    alert('Version mise √† jour : v' + data.version);
}

function uploadLogo(event) {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            data.logo = e.target.result;
            saveData();
            renderPage();
            updateSidebarLogo();
        };
        reader.readAsDataURL(file);
    }
}

function removeLogo() {
    if (confirm('Supprimer le logo ?')) {
        data.logo = null;
        saveData();
        renderPage();
        updateSidebarLogo();
    }
}

function openChangePasswordModal() {
    const content = `
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-stone-600 mb-1">Mot de passe actuel</label>
                <input type="password" id="old-password" class="w-full px-4 py-2.5 border border-stone-300 rounded-xl">
            </div>
            <div>
                <label class="block text-sm font-medium text-stone-600 mb-1">Nouveau mot de passe</label>
                <input type="password" id="new-password" class="w-full px-4 py-2.5 border border-stone-300 rounded-xl">
            </div>
            <div>
                <label class="block text-sm font-medium text-stone-600 mb-1">Confirmer le nouveau mot de passe</label>
                <input type="password" id="confirm-password" class="w-full px-4 py-2.5 border border-stone-300 rounded-xl">
            </div>
        </div>
        <div class="flex justify-end gap-3 mt-6">
            <button onclick="closeModal()" class="px-4 py-2.5 bg-stone-100 text-stone-700 rounded-xl font-medium">Annuler</button>
            <button onclick="changePassword()" class="btn-primary text-white px-4 py-2.5 rounded-xl font-medium">Changer</button>
        </div>
    `;
    showModal('Changer le mot de passe', content, 'max-w-md');
}

function changePassword() {
    const oldPwd = document.getElementById('old-password').value;
    const newPwd = document.getElementById('new-password').value;
    const confirmPwd = document.getElementById('confirm-password').value;

    if (oldPwd !== data.adminPassword) {
        alert('Mot de passe actuel incorrect !');
        return;
    }
    if (newPwd !== confirmPwd) {
        alert('Les nouveaux mots de passe ne correspondent pas !');
        return;
    }
    if (newPwd.length < 4) {
        alert('Le mot de passe doit faire au moins 4 caract√®res !');
        return;
    }

    data.adminPassword = newPwd;
    saveData();
    closeModal();
    alert('Mot de passe modifi√© avec succ√®s !');
}

function saveSettings() {
    data.entreprise = {
        nom: document.getElementById('ent-nom').value,
        complement: document.getElementById('ent-complement').value,
        adresse: document.getElementById('ent-adresse').value,
        codePostal: document.getElementById('ent-cp').value,
        ville: document.getElementById('ent-ville').value,
        telephone: document.getElementById('ent-tel').value,
        email: document.getElementById('ent-email').value,
        siret: document.getElementById('ent-siret').value,
        rcs: document.getElementById('ent-rcs').value,
        iban: document.getElementById('ent-iban').value,
        bic: document.getElementById('ent-bic').value,
        exonereTVA: document.getElementById('ent-exonere').checked
    };
    data.tauxURSSAFParMois['default'] = parseFloat(document.getElementById('ent-urssaf-default').value) || 23.20;
    saveData();
    updateSidebarLogo();
    alert('Param√®tres enregistr√©s !');
}

function saveCGV() {
    data.cgv = document.getElementById('cgv-text').value;
    saveData();
    alert('CGV enregistr√©es !');
}

function resetData() {
    if (confirm('‚ö†Ô∏è ATTENTION !\n\nCela va r√©initialiser TOUTES les donn√©es (local ET Firebase) avec les donn√©es par d√©faut.\nTous les clients, factures, produits et stock seront remis √† z√©ro.\n\nContinuer ?')) {
        if (confirm('√ätes-vous vraiment s√ªr ? Cette action est irr√©versible !')) {
            // R√©initialiser avec les donn√©es par d√©faut
            data = JSON.parse(JSON.stringify(defaultData));
            
            // Sauvegarder en local
            localStorage.setItem('facturier_stylemoi_v3', JSON.stringify(data));
            
            // Sauvegarder sur Firebase si connect√©
            if (dbRef) {
                dbRef.set(data).then(() => {
                    alert('‚úÖ Donn√©es r√©initialis√©es avec succ√®s !');
                    location.reload();
                }).catch(err => {
                    console.error('Erreur Firebase:', err);
                    location.reload();
                });
            } else {
                alert('‚úÖ Donn√©es r√©initialis√©es avec succ√®s !');
                location.reload();
            }
        }
    }
}

// ============================================
// RENDU PRINCIPAL
// ============================================
function renderPage() {
    const main = document.getElementById('main-content');
    switch (currentTab) {
        case 'dashboard': main.innerHTML = renderDashboard(); break;
        case 'clients': main.innerHTML = renderClients(); break;
        case 'produits': main.innerHTML = renderProduits(); break;
        case 'stock': main.innerHTML = renderStock(); break;
        case 'devis': main.innerHTML = renderDevis(); break;
        case 'factures': main.innerHTML = renderFactures(); break;
        case 'paiements': main.innerHTML = renderPaiements(); break;
        case 'relances': main.innerHTML = renderRelances(); break;
        case 'ca': main.innerHTML = renderCA(); break;
        case 'achats': main.innerHTML = renderAchats(); break;
        case 'settings': main.innerHTML = renderSettings(); break;
        default: main.innerHTML = renderDashboard();
    }
}

// ============================================
// INITIALISATION
// ============================================
document.addEventListener('DOMContentLoaded', checkSession);

document.getElementById('modal-container').addEventListener('click', function(e) {
    if (e.target === this) closeModal();
});
</script>
</body>
</html>
